---
title: 'Data Visualizations & Stats, by SI Figure #'
author: "Britta Schumacher"
date: "Last updated: `r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    theme: yeti
    toc: yes
    toc_float: true
---

# Set-up

### Load relevant packages & common data
```{r message = FALSE, warning = FALSE}
library(tidyverse)
library(ggplot2)
library(ggpubr)
library(sf)

# common data
counties <- readRDS("./data/coterm_cty_sf.RDS") 
states <- readRDS("./data/states_sf.RDS") 
states <- states %>% filter(STATE_FIPS %in% counties$STATEFP)
bea <- readRDS("./data/bea.RDS")
c <- readRDS("./data/contemp-coa.RDS")
r <- readRDS("./data/coa-race.RDS")
h <- read.csv("./data/historical-coa.csv")

# Build spatial
c_sf <- merge(counties, c, by = "GEOID")

# notes from EB
project_theme <- theme_bw() +
  theme(text = element_text(size=8))

# 
paste_noNA <- function(x,sep=", ") {
gsub(", " ,sep, toString(x[!is.na(x) & x!="" & x!="NA"] ) ) }
```


### Pull in theme for maps
```{r}
theme_map <- function(...) {
  theme_minimal() +
  theme(
    # remove all axes
    axis.line = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),

    # borders and margins
    panel.border = element_blank(),
    
    # titles
    legend.title = element_blank(),
    legend.text = element_text(size = 7, hjust = 0,
                               color = "black"),
    plot.title = element_text(size = 15, hjust = 0.5,
                              color = "black"),
    plot.subtitle = element_text(size = 10, hjust = 0.5,
                                 color = "black",
                                 margin = margin(b = -0.1,
                                                 t = -0.1,
                                                 l = 2,
                                                 unit = "cm"),
                                 debug = F),
    ...
  )
}
```

# Visualizations

### **SI Figure 1**: 

#### The agricultural contribution to a county’s GDP in 2019. Data: US BEA. 
```{r}
# county-level, in most recent year
g <- bea %>% filter(GEOID %in% counties$GEOID, YEAR == 2019) %>% mutate(contrib = current_GDP_ag / current_GDP * 100) %>% filter(!is.na(contrib))

#464 counties > 10%

g_sf <- merge(counties, g, by = "GEOID")

# Pull quantiles
q<- g_sf %>%
  pull(contrib) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() 

quantiles <- c(0,0.5,1,2.5,5,15,30,90)
labels <- c("0 - 0.5%",      "0.5 - 1%",    "1 - 2.5%",    "2.5 - 5%",   "5 - 15%", "15 - 30%",  "30 - 80%")

# Map ag contribution to GDP
g_sf %>%
  mutate(quantiles = cut(contrib,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(YEAR == 2019) %>% 
ggplot(.) +
  geom_sf(aes(fill = quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), legend.position="bottom",
          legend.key.size = unit(2, 'mm')) +
  scale_fill_manual(values=c("#fef6b5","#ffdd9a","#ffc285","#ffa679","#fa8a76","#f16d7a","#e15383"),name="") +
  ggsave('./viz/SI-Figure1.png', dpi = 400, width = 100, height = 80, units = "mm")
```
### **SI Figure 2**: 

#### The proportion of all workers engaged in the direct production of agricultural commodities, livestock or crops (includes sole proprietors, partners, and hired laborers) in 2019. Data: US BEA
```{r}
# Farm employment as percentage of total county employment
# county-level, in most recent year (sf/ggplot())
fc <- bea %>% filter(GEOID %in% counties$GEOID) %>% select(c(1:2,38:39,44:45)) 
fc$farmempl <- as.numeric(apply(fc[c(5:6)],1,paste_noNA))
fc$totjobs <- as.numeric(apply(fc[c(3:4)],1,paste_noNA))

fc <- fc %>% mutate(prop_farm = farmempl/totjobs*100) %>% select(1:2,7:9)

fc_sf <- merge(counties, fc, by = "GEOID")

# Pull quantiles
q<- fc_sf %>%
  pull(prop_farm) %>%
  quantile(probs = seq(0, 1, length.out = 8), na.rm = T) %>%
  as.vector() 

quantiles <- c(0,2.5,5,7.5,10,15,30,75)
labels <- c("0 – 2.5%",      "2.5 - 5.0%",    "5.0 - 7.5%",    "7.5 - 10.0%",   "10.0 - 15.0%",  "15.0 - 30.0%", "> 30.0%")

# Map ag contribution to GDP
fc_sf %>%
  mutate(quantiles = cut(prop_farm,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(YEAR == 2019) %>%
  filter(!is.na(prop_farm)) %>% 
ggplot(.) +
  geom_sf(aes(fill = quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), legend.position="bottom",
          legend.key.size = unit(2, 'mm')) +
  scale_fill_manual(values=c("#f9ddda","#f2b9c4","#e597b9","#ce78b3","#ad5fad","#834ba0","#573b88"),name="") +
  ggsave('./viz/SI-Figure2.png', dpi = 400, width = 100, height = 80, units = "mm")
```

### **SI Figure 3**: 

#### (A.) Average age of primary operators in 2017. (B.) Change in average age between 1997 and 2017; where red, average age was less in 2017 than 1997. Data: USDA NASS QuickStats.
```{r}
############################################################
# Average Age
############################################################
age <- c_sf %>% select(c(1,9:13)) 

### Extract quantiles; use these to estimate quantiles, below!
q <- age %>% filter(year == 2017) %>% 
  pull(age) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() # to remove names of quantiles, so idx below is numeric

### What are the quantiles?
quantiles <- c(32.5,55,57.5,59,61.5,63,75)

### Create custom labels
labels <- c("32.5 – 55 years",      "55 – 57.5 years",    "57.5 – 59 years",    "59 – 61.5 years",   "61.5 – 63 years",  "> 63 years")

### Create a new variable with the quantiles
df <- age %>%
  mutate(mean_quantiles = cut(age,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(!is.na(age)) 

### PLOT
# Average age
ave_age <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "Reds") +
  theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), legend.position="bottom",
          legend.key.size = unit(2, 'mm'))

############################################################
# Change in average Age between 1997 & 2017
############################################################
age_diff <- c %>% select(c(1:5)) %>%   
  filter(year %in% c(1997,2017)) %>% 
  group_by(GEOID, county) %>%
  summarise(age = diff(age)) %>% 
  filter(!is.na(age))

# percent cty's reporting reduction in average age
z<- age_diff %>% filter(age < 0) #67/3108 counties

t <- age_diff %>% filter(age <= 0)

age_diff <- merge(counties, age_diff, by = "GEOID")

### Extract quantiles; use these to estimate quantiles, below!
q<- age_diff %>%
  pull(age) %>%
  quantile(probs = seq(0, 1, length.out = 8), na.rm = T) %>%
  as.vector() # to remove names of quantiles, so idx below is numeric

quantiles <- c(-15,0,2.5,3.5,4.5,5.5,7.5,25)

labels <- c("< 0 years",      "0 - 2.5 years",    "2.5 - 3.5 years",    "3.5 - 4.5 years",   "4.5 - 5.5 years",  "5.5 - 7.5 years", "> 7.5 years")

age_diff <- age_diff %>%
  mutate(quantiles = cut(age,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(!is.na(age)) 

age_diff <- ggplot() +
  geom_sf(data = age_diff, aes(fill = quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  theme_map() +
  scale_fill_manual(values = c("#B2182B","#F7F7F7", "#D1E5F0", "#92C5DE", "#4393C3", "#2166AC", "#053061")) +
  theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), legend.position="bottom",
          legend.key.size = unit(2, 'mm'))

# Build panel plots!
# (A.) % full owners, (B.) % tenants
ggarrange(ave_age, age_diff, labels = c("A.", "B."), ncol = 2, font.label = list(size = 8))
ggsave("./viz/SI-Figure3.png", dpi = 400, width = 200, height = 80, units = "mm")
```

### **SI Figure 4**: 

#### Experience, years on present farm; The vertical line in 1997 reflects USDA-NASS implementation of adjustments for under-coverage. We do not include the non-adjusted ‘97 values. Data: Robert Hoppe, USDA ERS.
```{r}
# Experience

z <- h %>%
  select(c(1,18:20)) %>% filter(!is.na(exp_05)) %>% mutate(perc = exp_10/(exp_05+exp_09+exp_10)) %>%
  pivot_longer(!c(1,5), names_to = "exp", values_to = "count") %>%  
ggplot(.) +
  geom_bar(aes(fill = exp, y = count, x = year), position = "fill", stat = "identity") +
  scale_fill_manual(name = "", labels = c("Less than 5", "5 to 9", "Greater than 10"), values=c("#117733","#44AA99","#88CCEE")) +
  labs(title = "", color = "", y = "", x = "") +
  geom_vline(xintercept=c(1997), linetype="dotted") +
  project_theme +
  theme(legend.position="bottom") +
  ggsave('./viz/SI-Figure4.png', dpi = 400, width = 100, height = 80, units = "mm")

# percent in 1910
1802540/5794768
# percent in 2017
2435435/3399834
```

### **SI Figure 5**: 

#### Primary operators reported years’ experience on present operation in 2017. Data: USDA NASS QuickStats.
```{r}
############################################################
# Years on any operation
############################################################

exp <- c_sf %>% select(c(1,10,12,17)) 

### Extract quantiles; use these to estimate quantiles, below!
q <- exp %>% filter(year == 2017) %>% 
  pull(exp) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() # to remove names of quantiles, so idx below is numeric

### What are the quantiles?
quantiles <- c(5,15,20,22.5,25,27.5,32.6)

### Create custom labels
labels <- c("5 - 15 years",      "15 - 20 years",    "20 – 22.5 years",    "22.5 - 25 years",   "25 - 27.5 years",  "> 27.5 years")

### Create a new variable with the quantiles
df <- exp %>%
  mutate(mean_quantiles = cut(exp,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(!is.na(exp)) %>% 
  filter(year == 2017) 

### PLOT
ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "Blues") +
  theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), legend.position="bottom",
          legend.key.size = unit(2, 'mm')) +
  ggsave('./viz/SI-Figure5.png', dpi = 400, width = 100, height = 80, units = "mm")
  
# STATS
z<- c %>% select(c(1,2,9)) %>% filter(year == 2017) %>% filter(exp >= 10) # (3058/3117)
```

### **SI Figure 6**: 

#### Proportional bar charts showing (A.) the area operated by principal operators by their reported race, and (B.) operations by principal operator’s race; y-axis limits at proportion = 0.08 to show distinctions between races (ie. white operators represent over 90% of all operators and farm over 90% of all operated acres). Data: USDA NASS QuickStats.
```{r}
# Stacked bar chart, race
# area operated
race_area <- r %>%
  filter(OPERATOR == "OPERATORS, PRINCIPAL", TYPE == "AREA OPERATED") %>% 
  select(c(1,4,7:13)) %>% 
  pivot_longer(!c(1,2), names_to = "race", values_to = "acres") %>% 
ggplot(.) +
  geom_bar(aes(fill = forcats::fct_rev(race), y = acres, x = YEAR), position = "fill", stat = "identity") +
  scale_fill_manual(name = "", labels = c("White", "Native Hawaiian or Other Pacific Islander", "American Indian or Alaskan Native", "Multiple Races", "Hispanic", "Black", "Asian"), values=c("#332288","#117733","#44AA99","#88CCEE","#DDCC77","#CC6677","#AA4499")) +
  labs(title = "", color = "", y = "Proportion of Area Operated", x = "") +
  #geom_vline(xintercept=c(1997), linetype="dotted") +
  project_theme +
  theme(legend.position="bottom") +
  coord_cartesian(ylim = c(0,0.085)) +
  scale_x_continuous(breaks = c(2007, 2012, 2017)) 

# operations
race_operations <- r %>%
  filter(OPERATOR == "OPERATORS, PRINCIPAL", TYPE == "OPERATIONS") %>% 
  select(c(1,4,7:13)) %>% 
  pivot_longer(!c(1,2), names_to = "race", values_to = "acres") %>% 
ggplot(.) +
  geom_bar(aes(fill = forcats::fct_rev(race), y = acres, x = YEAR), position = "fill", stat = "identity") +
  scale_fill_manual(name = "", labels = c("White", "Native Hawaiian or Other Pacific Islander", "American Indian or Alaskan Native", "Multiple Races", "Hispanic", "Black", "Asian"), values=c("#332288","#117733","#44AA99","#88CCEE","#DDCC77","#CC6677","#AA4499")) +
  labs(title = "", color = "", y = "Proportion of Operations", x = "") +
  #geom_vline(xintercept=c(1997), linetype="dotted") +
  project_theme +
  theme(legend.position="bottom") +
  coord_cartesian(ylim = c(0,0.085)) +
  scale_x_continuous(breaks = c(2007, 2012, 2017)) 

# Build panel plots!
ggarrange(race_area, race_operations, labels = c("A.", "B."), ncol = 2, nrow = 1, common.legend = TRUE, legend = "bottom",
          font.label = list(size = 8))
ggsave("./viz/SI-Figure6.png", dpi = 400, width = 200, height = 80, units = "mm")
```

### **SI Figure 7**: 

#### Percent acreage operated by (A.) Black, (B.) Hispanic, (C.) white, and (D.) female identifying primary operators in 2017. Data: USDA QuickStats, 2017 COA.
```{r}
############################################################
# Percent acres operated by principal operators identifying as females
############################################################
female_acres <- c_sf %>% select(c(1,10:11,21)) 

### Extract quantiles; use these to estimate quantiles, below!
q <- female_acres %>% filter(year == 2017) %>% 
  pull(percf_acr) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() # to remove names of quantiles, so idx below is numeric

### What are the quantiles?
quantiles <- c(0,15,20,22.5,25,30,77)

### Create custom labels
labels <- c("0 – 15%",      "15 – 20%",    "20 – 22.5%",    "22.5 – 25.0%",   "25.0 – 30.0%",  "> 30.0%")

### Create a new variable with the quantiles
df <- female_acres %>%
  mutate(mean_quantiles = cut(percf_acr,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(!is.na(percf_acr)) %>% 
  filter(year == 2017)

### PLOT
# Percent acres operated by women - 2017
female_acres <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "Greens") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), legend.position="bottom",
          legend.key.size = unit(2, 'mm'))

############################################################
# Percent acres operated by folx identifying as black, hispanic, and white principal operators
############################################################

# proporation of each race
race_prop <- r %>% mutate(TOTAL = rowSums(.[7:13])) %>% 
  mutate(POC = (NATIVE_AMER + BLACK + MULTI + HISPANIC + ASIAN + PACIFIC_ISL)/TOTAL*100,
         NATIVE_AMER = NATIVE_AMER/TOTAL*100,
         BLACK = BLACK/TOTAL*100,
         MULTI = MULTI/TOTAL*100,
         WHITE = WHITE/TOTAL*100,
         HISPANIC = HISPANIC/TOTAL*100,
         ASIAN = ASIAN/TOTAL*100,
         PACIFIC_ISL = PACIFIC_ISL/TOTAL*100) %>% 
  filter(OPERATOR == "OPERATORS, PRINCIPAL") %>% 
  select("GEOID", "YEAR", "OPERATOR", "TYPE", "WHITE", "POC", "NATIVE_AMER", "BLACK", "MULTI", "HISPANIC", "ASIAN", "PACIFIC_ISL", "TOTAL") %>% 
  mutate_at(7:13, round, 3)

# build spatial
r_sf <- merge(counties, race_prop, by = "GEOID") 

### Extract quantiles; use these to estimate quantiles, below!
q <- r_sf %>% filter(YEAR == 2017, TYPE == "AREA OPERATED") %>% 
  pull(WHITE) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() 

### What are the quantiles?
q_h <- c(0,0.25,0.5,1.0,2.5,5.0,101)
q_b <- c(0,0.25,0.5,1.0,2.5,5.0,72)
q_w <- c(0,90,95,97.5,98.5,99.5,100.1)

### Create custom labels
l_h <- c("0 - 0.25%",      "0.25 - 0.5%",    "0.5 - 1.0%",    "1.0 - 2.5%",   "2.5 - 5.0%",  "> 5.0%")
l_b <- c("0 - 0.25%",      "0.25 - 0.5%",    "0.5 - 1.0%",    "1.0 - 2.5%",   "2.5 - 5.0%",  "> 5.0%")
l_w <- c("0 - 90.0%",    "90.0 - 95.0%",   "95.0 - 97.5%",   "97.5 - 98.5%", "98.5 - 99.5%",  "> 99.5%")

### Create a new variable with the quantiles
df <- r_sf %>%
  mutate(mean_quantiles = cut(HISPANIC,
                               breaks = q_h,
                               labels = l_h,
                               include.lowest = T)) %>% 
  filter(!is.na(HISPANIC)) %>% 
  filter(YEAR == 2017, TYPE == "AREA OPERATED") 

### PLOT
# Percent HISPANIC operators - 2017
hisp_acres <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "Purples") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), legend.position="bottom",
          legend.key.size = unit(2, 'mm'))

### Create a new variable with the quantiles
df <- r_sf %>%
  mutate(mean_quantiles = cut(BLACK,
                               breaks = q_b,
                               labels = l_b,
                               include.lowest = T)) %>% 
  filter(!is.na(BLACK)) %>% 
  filter(YEAR == 2017, TYPE == "AREA OPERATED") 

### PLOT
# Percent BLACK operators - 2017
black_acres <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "Oranges") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), legend.position="bottom",
          legend.key.size = unit(2, 'mm'))

### Create a new variable with the quantiles
df <- r_sf %>%
  mutate(mean_quantiles = cut(WHITE,
                               breaks = q_w,
                               labels = l_w,
                               include.lowest = T)) %>% 
  filter(!is.na(WHITE)) %>% 
  filter(YEAR == 2017, TYPE == "AREA OPERATED") 

### PLOT
# Percent WHITE operators - 2017
white_acres <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "Reds") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), legend.position="bottom",
          legend.key.size = unit(2, 'mm'))

# Build panel plots!
# (A.) Black, (B.) Hispanic, (C.) white and (D.) female operated acreage
library(ggpubr)
ggarrange(black_acres, hisp_acres, white_acres, female_acres, labels = c("A.", "B.", "C.", "D."), ncol = 2, nrow = 2, font.label = list(size = 8))
ggsave("./viz/SI-Figure7.png", dpi = 400, width = 180, height = 120, units = "mm")
```
### **SI Figure 8**: 

#### (A.) Percent agricultural acres operated by POC (i.e., Black, American Indian or Native Alaskan, Multi-racial, Hispanic, Asian, Native Hawaiian or other Pacific Islander) principal operators in 2017, and (B.) Percent of all US farm operations operated by POC principal operators in 2017. Data: USDA NASS QuickStats
```{r}
############################################################
# Percent acres operated by POC principal operators
############################################################

### Extract quantiles; use these to estimate quantiles, below!
q <- r_sf %>% filter(YEAR == 2017, TYPE == "AREA OPERATED") %>% 
  pull(POC) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() # to remove names of quantiles, so idx below is numeric

### What are the quantiles?
quantiles <- c(0,0.125,0.75,2.5,5,25,100)

### Create custom labels
labels <- c("0 - 0.125%",      "0.125 - 0.75%",    "0.75 - 2.5%",    "2.5 - 5.0%",   "5.0 - 25.0%",  "> 25.0%")

### Create a new variable with the quantiles
df <- r_sf %>%
  mutate(mean_quantiles = cut(POC,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(!is.na(POC)) %>% 
  filter(YEAR == 2017, TYPE == "AREA OPERATED") 

### PLOT
# Percent POC operated acres - 2017
POC_acres <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "GnBu") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), legend.position="bottom",
          legend.key.size = unit(2, 'mm'))

############################################################
# Percent operations operated by POC principle operators
############################################################

### Extract quantiles; use these to estimate quantiles, below!
q <- r_sf %>% filter(YEAR == 2017, TYPE == "OPERATIONS") %>% 
  pull(POC) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() # to remove names of quantiles, so idx below is numeric

### What are the quantiles?
quantiles <- c(0,1.25,2.5,5,10,25,100)

### Create custom labels
labels <- c("0 - 1.25%",      "1.25 - 2.5%",    "2.5 - 5.0%",    "5.0 - 10.0%",   "10.0 - 25.0%",  "> 25.0%")

### Create a new variable with the quantiles
df <- r_sf %>%
  mutate(mean_quantiles = cut(POC,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(!is.na(POC)) %>% 
  filter(YEAR == 2017, TYPE == "OPERATIONS") 

### PLOT
# Percent POC operated acres - 2017
POC_operations <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "YlGn") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), legend.position="bottom",
          legend.key.size = unit(2, 'mm'))

# Build panel plots!
# (A.) Percent POC operated acres, (B.) Percent POC-run operations
library(ggpubr)
ggarrange(POC_acres, POC_operations, labels = c("A.", "B."), ncol = 2, font.label = list(size = 8))
ggsave("./viz/SI-Figure8.png", dpi = 400, width = 200, height = 80, units = "mm")
```

### **SI Figure 9**: 

#### Proportion of acres operated by tenancy status. Data: USDA NASS QuickStats.
```{r}
z <- c %>%
  select(c(1:2,18:20)) %>% 
  pivot_longer(!c(1,2), names_to = "tenancy", values_to = "acres") %>% 
ggplot(.) +
  geom_bar(aes(fill = forcats::fct_rev(tenancy), y = acres, x = year), position = "fill", stat = "identity") +
  scale_fill_manual(name = "", labels = c("Tenant", "Part Owner", "Full Owner"), values=c("#44AA99","#88CCEE","#882255")) +
  labs(title = "", color = "", y = "", x = "") +
  project_theme +
  theme(legend.position="bottom") +
  scale_x_continuous(breaks = c(1997, 2002, 2007, 2012, 2017)) +
  ggsave("./viz/SI-Figure9.png", dpi = 400, width = 100, height = 80, units = "mm")

# STATS
# tenancy through time

z <- c %>%
  select(c(1:2,18:20)) %>% 
  filter(year == 2017)   

z[is.na(z)] <- 0 

z <- z %>% group_by(year) %>% 
  summarise(full_owner = sum(full_owner),
            part_owner = sum(part_owner),
            tenant = sum(tenant))
  
# full owner
294702960/879236316
# part owner
294702960/879236316
# tenant
82741246/879236316
```

### **SI Figure 10**: 

#### Average acres per operation in 2017, measured as the total number of agricultural acres in a county divided by the total number of operations. Data: USDA NASS QuickStats.
```{r}
############################################################
# Acres per operation, mean in 2017
############################################################
size <- c %>% select(c(1:4,6:7)) %>% filter(year == 2017)  %>% mutate(ave_apo = round(tot_acres/n_op))

size <- merge(counties, size, by = "GEOID")

### Extract quantiles; use these to estimate quantiles, below!
# Mean
q <- size %>% 
  pull(ave_apo) %>% # switch ave_apo
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() # to remove names of quantiles, so idx below is numeric

### What are the quantiles?
quantiles <- c(0,150,300,600,1200,2500,60000) # Mean

### Create custom labels
labels <- c("0 – 150 acres",      "150 – 300 acres",    "300 – 600 acres",    "600 – 1200 acres",   "1200 – 2500 acres",  "> 2500 acres") # Mean

### Create a new variable with the quantiles
# Mean
df <- size %>%
  mutate(mean_quantiles = cut(ave_apo,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(!is.na(ave_apo)) 

### PLOT
# Mean acres
mean_acres <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "YlGn") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), legend.position="bottom",
          legend.key.size = unit(2, 'mm')) +
  ggsave('./viz/SI-Figure10.png', dpi = 400, width = 100, height = 80, units = "mm")

```

### **Figure 11**: 

#### Share of gross farm cash receipts spent on all agricultural inputs. During the height of the Farm Crisis of the 1980s, for instance, US farmers spent over 90% of their gross earnings (ie. earnings before subtracting production expenses) on inputs to agriculture. 
```{r}
bea$YEAR<-as.numeric(bea$YEAR) 
t<- bea %>% select(c(1:3,11,23)) %>% filter(GeoName == "United States") %>% mutate(prod_exp = (prod_exp)/cash_income*100) %>% 
  ggplot(.) +
  geom_line(aes(x = YEAR, y = prod_exp), color = "#88CCEE", size = 1.5) +
  project_theme +
  labs(title = "", color = "", y = "Share of Earnings (%) Spent on Inputs", x = "") +
  ggsave("./viz/SI-Figure11.png", dpi = 400, width = 100, height = 80, units = "mm")
```

### **Figure 12**: 

#### Agricultural input expenditure as a proportion of gross farm cash receipts in 2017; where values are > 100% county input expenditures surpassed gross farm earnings. For example, in Chattahoochee, GA expenditure on inputs surpassed gross earnings for the county by just under 1000%. Data: US BEA. 
```{r}
# county-level, in most recent year
g <- bea %>% select(c(1:3,11,23)) %>% mutate(perc = prod_exp/cash_income*100) %>% filter(!is.na(perc),                                                                                   YEAR == 2019) 
g_sf <- merge(counties, g, by = "GEOID")

# Pull quantiles
q<- g_sf %>%
  pull(perc) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() 

quantiles <- c(0,70,85,100,125,150,200,1000)
labels <- c("0 - 70%",      "70 - 85%",    "85 - 100%",    "100 - 125%",   "125 - 150%",  "150 - 200%", "> 200%")

# Map ag contribution to GDP
g_sf %>%
  mutate(quantiles = cut(perc,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
ggplot(.) +
  geom_sf(aes(fill = quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_manual(values=c("#053061", "#4393C3", "#92C5DE",  "#FDDBC7", "#D6604D", "#B2182B", "#67001F"),name="") +
  theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), legend.position="bottom",
          legend.key.size = unit(2, 'mm')) +
  ggsave('./viz/SI-Figure12.png', dpi = 400, width = 100, height = 80, units = "mm")
```

### **SI Figure 15**: 

#### Agricultural real estate debt from 1969 to 2019, adjusted for inflation using the chain-type GDP deflator provided by the USDA ERS. Data: USDA ERS.
```{r}
# tidy data
library(viridis)
w <- read.csv("./data/ers-wealthstatdata.csv")
w <- w[c(1,2,4:8,11)]

debt <- w %>% 
  filter(VariableDescriptionPart1 %in% c("Real estate","Farm sector debt","Non-real estate"))

debt$variable <- paste(debt$VariableDescriptionPart1, debt$VariableDescriptionPart2, sep="_")

debt <- debt[c(1,2,6,8:9)]
unique(debt$variable)

debt <- debt %>% mutate(REAL_GDP = Amount / (ChainType_GDP_Deflator/100))

debt_tidy <- debt %>% pivot_wider(names_from = variable, values_from = Amount)

# VIZ
z<-debt %>%
  filter(variable %in% c("Real estate_Commercial banks","Real estate_CCC storage and drying loans","Real estate_Farm Credit System","Real estate_Farm Service Agency","Real estate_Farmer Mac","Real estate_Individuals and others","Real estate_Life insurance companies"),
         Year >= 1960) %>%
ggplot(.) +
    geom_bar(aes(fill=variable, y=REAL_GDP*1000, x=Year), position="stack", stat="identity") +
    scale_fill_viridis(discrete = T, option = "magma",labels = c("CCC Loans", "Commercial Banks", "Farm Credit System","Farm Service Agency","Farmer Mac","Individuals & Others", "Life Insurance"),name="Holder") +
    project_theme +
  #scale_fill_discrete(labels = c("CCC Loans", "Commercial Banks", "Farm Credit System","Farm Service Agency","Farmer Mac","Individuals & Others", "Life Insurance"), values = c("#000004FF", "#2D1160FF", "#721F81FF", "#B63679FF", "#F1605DFF", "#FEAF77FF", "#FCFDBFFF")) +
    xlab("") +
  labs(title = "", y = "Real US Dollars") +
  scale_y_continuous(breaks=c(100000000000,200000000000,300000000000),
        labels=c("$100B","$200B","$300B")) +
  theme(legend.position="bottom") +
  ggsave("./viz/SI-Figure15.png", dpi = 400, width = 140, height = 80, units = "mm")
```

### **SI Figure 16**: 

#### Agricultural   non-real estate debt from 1969 to 2019, adjusted for inflation using the chain-type GDP deflator provided by the USDA ERS. Data: USDA ERS.
```{r}
debt %>%
  filter(variable %in% c("Non-real estate_Farm Credit System","Non-real estate_Farm Service Agency","Non-real estate_Individuals and others","Non-real estate_Commerical banks"),
         Year >= 1960) %>%
ggplot(.) +
    geom_bar(aes(fill=variable, y=REAL_GDP*1000, x=Year), position="stack", stat="identity") +
    scale_fill_viridis(discrete = T, labels = c("Farm Credit System","Farm Service Agency","Individuals & Others", "Commercial Banks"), name = "Holder") +
    ggtitle("Proportion of Non-real Estate Debt: By holder") +
    project_theme +
  labs(title = "", y = "Real US Dollars") +
  scale_y_continuous(breaks=c(50000000000,100000000000,150000000000,200000000000),
        labels=c("$50B","$100B","$150B","$200B")) +
  theme(legend.position="bottom") + 
  ggsave("./viz/SI-Figure16.png", dpi = 400, width = 140, height = 80, units = "mm")
```

### **SI Figure 17**: 

#### Realized net income (total cash receipts and other income less total production expenses.), adjusted to 2019 dollars. Data: US BEA.
```{r}
#inflation adjust to 2019 dollars 
options(scipen = 100)
library(blscrapeR) 

df<-inflation_adjust(2019) #this pulls a table of adjustment values (adjustment to 2019 $) 

df$year<-as.numeric(df$year) 

dat<-left_join(bea,df[,c(1,3)], by=c("YEAR"="year")) #this basically joins the inflation adjustment values to the dataset you want to adjust by joining by year of the data (so the current year data in the BEA dataset) in this case I am inflation adjusting the per capita income levels (pci) 

dat$net_income_adj<-dat$net_income/dat$adj_value #this performs the actual dollar value adjustment

# Net adjusted income over time
n <- dat %>% filter(GeoName == "United States") %>% select(c(2,24,69))

n %>% 
ggplot(.) +
  geom_line(aes(x = YEAR, y = net_income_adj*1000/1000000000),color = "#009392", size = 1.5) +
  project_theme +
  labs(title = "", color = "", y = "Realized Net Income (in billions of USD$)", x = "") +
   ggsave("./viz/SI-Figure17.png", dpi = 400, width = 100, height = 80, units = "mm")
```

### **SI Figure 18**: 

#### Average farm proprietors’ income in (A.) 1969, adjusted to 2019 dollars, and (B.) 2019. Counties in which average farm proprietors’ income is negative (red) went into debt in a given year. For instance, in Lawrence, AL, farm proprietors made $29k on average in 1969, but lost $16k on average in 2019. Data: US BEA. 
```{r}
p <- dat %>% select(c(1:3,farmprop_income, farmprop_employ, nonfarmprop_income, nonfarmprop_employ,adj_value))

p$farmprop_income_adj<-p$farmprop_income/p$adj_value
p$nonfarmprop_income_adj<-p$nonfarmprop_income/p$adj_value

p <- p %>% 
  mutate(ave_farm = farmprop_income_adj*1000/farmprop_employ,
         ave_nonfarm = nonfarmprop_income_adj*1000/nonfarmprop_employ)

# county-level data; average farm proprietors income, 2019
i <- p %>% filter(GEOID %in% counties$GEOID, YEAR == 2019) %>% select(c(1:3,11:12)) %>% filter(!is.na(ave_farm)) 
i_sf <- merge(counties, i, by = "GEOID")
# Pull quantiles
q<- i_sf %>%
  pull(ave_farm) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() 

quantiles <- c(-2150000,-5500,0,5500,15000,30000,60000,3100000)
labels <- c("< -$5.5k",  "-$5.5k - $0",    "$0 - $5.5k",   "$5.5k - $15k",  "$15k - $30k", "$30k - $60k", "> $60k")

# Map 
farm_19 <- i_sf %>%
  mutate(quantiles = cut(ave_farm,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
ggplot(.) +
  geom_sf(aes(fill = quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_manual(values = c("#B2182B", "#FDDBC7", "#D1E5F0", "#92C5DE", "#4393C3", "#2166AC", "#053061"),name="") +
   theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), legend.position="bottom",
          legend.key.size = unit(2, 'mm'))

# county-level data; average farm proprietors income, 1969
i <- p %>% filter(GEOID %in% counties$GEOID, YEAR == 1969) %>% select(c(1:3,11:12)) %>% filter(!is.na(ave_farm), ave_farm != 0) %>% filter(GEOID != 	
"08097")
i_sf <- merge(counties, i, by = "GEOID")
# Pull quantiles
q<- i_sf %>%
  pull(ave_farm) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() 

quantiles <- c(-70000,0,10000,20000,30000,40000,50000,600000)
labels <- c("< $0",  "$0 - $10k",    "$10k - $20k",   "$20k - $30k",  "$30k - $40k", "$40k - $50k", "> $50k")

# Map net income
farm_69 <- i_sf %>%
  mutate(quantiles = cut(ave_farm,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
ggplot(.) +
  geom_sf(aes(fill = quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_manual(values = c("#B2182B", "#ebf8ff", "#D1E5F0", "#92C5DE", "#4393C3", "#2166AC", "#053061"),name="") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), legend.position="bottom",
          legend.key.size = unit(2, 'mm')) 

# Build panel plots!
# (A.) income 1969, (B.) income 2019
library(ggpubr)
ggarrange(farm_69, farm_19, labels = c("A.", "B."), ncol = 2, font.label = list(size = 8))
ggsave("./viz/SI-Figure18.png", dpi = 400, width = 200, height = 80, units = "mm")

# STATS
i <- p %>% filter(GEOID %in% counties$GEOID) %>% filter(YEAR == 1969 | YEAR == 2019)
```
### **SI Figure ??**: 

#### (A.) Percent of county acres covered by crop insurance in 2017; (B.) Dollars provided per agricultural acre in government payouts to farmers.

```{r}
#### (A.) Percent of county acres covered by crop insurance in 2017
# county-level, in most recent year
i <- c %>% filter(GEOID %in% counties$GEOID, year == 2017) %>% mutate(perc_insur = insur_acres/tot_acres*100) %>% filter(!is.na(perc_insur))

#464 counties > 10%

i_sf <- merge(counties, i, by = "GEOID")

# Pull quantiles
q<- i_sf %>%
  pull(perc_insur) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() 

quantiles <- c(0,5,15,25,40,50,75,100)
labels <- c("0 - 5%",      "5 - 15%",    "15 - 25%",    "25 - 40%",   "40 - 50%", "50 - 75%",  "> 75%")

# Map ag contribution to GDP
perc_insur <- i_sf %>%
  mutate(quantiles = cut(perc_insur,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(year == 2017) %>% 
ggplot(.) +
  geom_sf(aes(fill = quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), legend.position="bottom",
          legend.key.size = unit(2, 'mm')) +
  scale_fill_brewer(palette = "YlOrBr") 

#### (B.) Dollars provided per agricultural acre in government payouts to farmers.
# county-level, in most recent year
p <- c %>% filter(GEOID %in% counties$GEOID, year == 2017) %>% mutate(gvt_acre = gvt_prog/tot_acres) %>% filter(!is.na(gvt_acre))

#464 counties > 10%

p_sf <- merge(counties, p, by = "GEOID")

# Pull quantiles
q<- p_sf %>%
  pull(gvt_acre) %>%
  quantile(probs = seq(0, 1, length.out = 8), na.rm = T) %>%
  as.vector() 

quantiles <- c(0,2.5,5,7.5,10,15,25,100)
labels <- c("$0 - $2.5",      "$2.5 - $5",    "$5 - $7.5",    "$7.5 - $10",   "$10 - $15", "$15 - $25",  "> $25")

# Map ag contribution to GDP
gvt_acre <- p_sf %>%
  mutate(quantiles = cut(gvt_acre,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(year == 2017) %>% 
ggplot(.) +
  geom_sf(aes(fill = quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), legend.position="bottom",
          legend.key.size = unit(2, 'mm')) +
  scale_fill_brewer(palette = "RdPu") 

# Build panel plots!
# (A.) % acres covered by crop insurance, (B.) $/ag acre in government payouts
library(ggpubr)
ggarrange(perc_insur, gvt_acre, labels = c("A.", "B."), ncol = 2, font.label = list(size = 8))
ggsave("./viz/SI-Figure19.png", dpi = 400, units = "mm", width = 200, height = 80)
```

### **SI Figure ??**: 

#### Net cash farm income of operations (measured in $/operation) reported by the USDA-NASS in 2017. Data: USDA NASS Quickstats
```{r}
nc <- c %>% filter(GEOID %in% counties$GEOID, year == 2017) %>% filter(!is.na(net_income))

# STATS
c %>% filter(year == 2017, net_income < 0) %>% arrange(net_income) # 444/3034 reporting counties

#464 counties > 10%

nc_sf <- merge(counties, nc, by = "GEOID")

# Pull quantiles
q<- nc_sf %>%
  pull(net_income) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() 

quantiles <- c(-60000,0,5000,1250,25000,50000,100000,2000000)
labels <- c("< $0",      "$0 - $5k",    "$5k - $12.5k",    "$12.5k - $25k",   "$25k - $50k", "$50k - $100k",  "> $100k")

# Map ag contribution to GDP
nc_sf %>%
  mutate(quantiles = cut(net_income,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(year == 2017) %>% 
ggplot(.) +
  geom_sf(aes(fill = quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), legend.position="bottom",
          legend.key.size = unit(2, 'mm')) +
    scale_fill_manual(values = c("#B2182B","#F7F7F7", "#D1E5F0", "#92C5DE", "#4393C3", "#2166AC", "#053061")) +
   ggsave("./viz/SI-Figure20.png", dpi = 400, width = 100, height = 80, units = "mm")

```

