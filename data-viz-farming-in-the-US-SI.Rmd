---
title: 'Data Visualizations & Stats, by SI Figure #'
author: "Britta Schumacher"
date: "Last updated: `r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    theme: yeti
    toc: yes
    toc_float: true
---

# Set-up

### Load relevant packages & common data
```{r message = FALSE, warning = FALSE}
library(tidyverse)
library(ggplot2)
library(ggpubr)
library(sf)

# common data
counties <- readRDS("./data/coterm_cty_sf.RDS") 
states <- readRDS("./data/states_sf.RDS") 
states <- states %>% filter(STATE_FIPS %in% counties$STATEFP)
bea <- readRDS("./data/bea.RDS")
c <- readRDS("./data/contemp-coa.RDS")
r <- readRDS("./data/coa-race.RDS")
h <- read.csv("./data/historical-coa.csv")
frr <- readRDS("./data/FRR.RDS")

# Build spatial
c_sf <- merge(counties, c, by = "GEOID")

# notes from EB
project_theme <- theme_bw() +
  theme(text = element_text(size=8))

# 
paste_noNA <- function(x,sep=", ") {
gsub(", " ,sep, toString(x[!is.na(x) & x!="" & x!="NA"] ) ) }
```


### Pull in theme for maps
```{r message = FALSE, warning = FALSE}
theme_map <- function(...) {
  theme_minimal() +
  theme(
    # remove all axes
    axis.line = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),

    # borders and margins
    panel.border = element_blank(),
    
    # titles
    legend.title = element_blank(),
    legend.text = element_text(size = 8, hjust = 0,
                               color = "black"),
    plot.title = element_text(size = 15, hjust = 0.5,
                              color = "black"),
    plot.subtitle = element_text(size = 10, hjust = 0.5,
                                 color = "black",
                                 margin = margin(b = -0.1,
                                                 t = -0.1,
                                                 l = 2,
                                                 unit = "cm"),
                                 debug = F),
    ...
  )
}
```

# Visualizations

### **SI Figure 1**: 

#### Average acres per operation in 2017, measured as the total number of agricultural acres in a county divided by the total number of operations. Data: USDA NASS QuickStats.
```{r message = FALSE, warning = FALSE}
############################################################
# Acres per operation, mean in 2017
############################################################
size <- c %>% select(c(1:4,6:7)) %>% filter(year == 2017)  %>% mutate(ave_apo = round(tot_acres/n_op))

size <- merge(counties, size, by = "GEOID")

### Extract quantiles; use these to estimate quantiles, below!
# Mean
q <- size %>% 
  pull(ave_apo) %>% # switch ave_apo
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() # to remove names of quantiles, so idx below is numeric

### What are the quantiles?
quantiles <- c(0,150,300,600,1200,2500,60000) # Mean

### Create custom labels
labels <- c("0 – 150 acres",      "150 – 300 acres",    "300 – 600 acres",    "600 – 1200 acres",   "1200 – 2500 acres",  "> 2500 acres") # Mean

### Create a new variable with the quantiles
# Mean
df <- size %>%
  mutate(mean_quantiles = cut(ave_apo,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(!is.na(ave_apo)) 

### PLOT
# Mean acres
ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "YlGn") +
  theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), 
          legend.position="right",
          legend.key.size = unit(4, 'mm'))

  ggsave('./visualizations/PNG/SI-Figure1.png', dpi = 400, width = 110, height = 60, units = "mm", bg = "white")
  ggsave('./visualizations/JPEG/SI-Figure1.jpg', dpi = 300, width = 110, height = 60, units = "mm", bg = "white")
```

### **SI Figure 2**: 

#### The agricultural contribution to a county’s GDP in 2019. Data: US BEA. 
```{r message = FALSE, warning = FALSE}
# county-level, in most recent year
g <- bea %>% filter(GEOID %in% counties$GEOID, YEAR == 2019) %>% mutate(contrib = current_GDP_ag / current_GDP * 100) %>% filter(!is.na(contrib))

#464 counties > 10%

g_sf <- merge(counties, g, by = "GEOID")

# Pull quantiles
q<- g_sf %>%
  pull(contrib) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() 

quantiles <- c(0,0.5,1,2.5,5,15,30,90)
labels <- c("0 - 0.5%",      "0.5 - 1%",    "1 - 2.5%",    "2.5 - 5%",   "5 - 15%", "15 - 30%",  "30 - 80%")

# Map ag contribution to GDP
g_sf %>%
  mutate(quantiles = cut(contrib,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(YEAR == 2019) %>% 
ggplot(.) +
  geom_sf(aes(fill = quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), 
          legend.position="right",
          legend.key.size = unit(4, 'mm')) +
  scale_fill_manual(values=c("#fef6b5","#ffdd9a","#ffc285","#ffa679","#fa8a76","#f16d7a","#e15383"),name="") 
  
  ggsave('./visualizations/PNG/SI-Figure2.png', dpi = 400, width = 110, height = 60, units = "mm", bg = "white")
  ggsave('./visualizations/JPEG/SI-Figure2.jpg', dpi = 300, width = 110, height = 60, units = "mm", bg = "white")
```
### **SI Figure 3**: 

#### The proportion of all workers engaged in the direct production of agricultural commodities, livestock or crops (includes sole proprietors, partners, and hired laborers) in 2019. Data: US BEA
```{r message = FALSE, warning = FALSE}
# Farm employment as percentage of total county employment
# county-level, in most recent year (sf/ggplot())
fc <- bea %>% filter(GEOID %in% counties$GEOID) %>% select(c(1:2,38:39,44:45)) 
fc$farmempl <- as.numeric(apply(fc[c(5:6)],1,paste_noNA))
fc$totjobs <- as.numeric(apply(fc[c(3:4)],1,paste_noNA))

fc <- fc %>% mutate(prop_farm = farmempl/totjobs*100) %>% select(1:2,7:9)

fc_sf <- merge(counties, fc, by = "GEOID")

# Pull quantiles
q<- fc_sf %>%
  pull(prop_farm) %>%
  quantile(probs = seq(0, 1, length.out = 8), na.rm = T) %>%
  as.vector() 

quantiles <- c(0,2.5,5,7.5,10,15,30,75)
labels <- c("0 – 2.5%",      "2.5 - 5.0%",    "5.0 - 7.5%",    "7.5 - 10.0%",   "10.0 - 15.0%",  "15.0 - 30.0%", "> 30.0%")

# Map ag contribution to GDP
fc_sf %>%
  mutate(quantiles = cut(prop_farm,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(YEAR == 2019) %>%
  filter(!is.na(prop_farm)) %>% 
ggplot(.) +
  geom_sf(aes(fill = quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), 
          legend.position="right",
          legend.key.size = unit(4, 'mm')) +
  scale_fill_manual(values=c("#f9ddda","#f2b9c4","#e597b9","#ce78b3","#ad5fad","#834ba0","#573b88"),name="") 

  ggsave('./visualizations/PNG/SI-Figure3.png', dpi = 400, width = 110, height = 60, units = "mm", bg = "white")
  ggsave('./visualizations/JPEG/SI-Figure3.jpg', dpi = 300, width = 110, height = 60, units = "mm", bg = "white") 
  
# labor expense statistics
coa_stand <- readRDS("./data/COA-vars.RDS")

labor_exp <- coa_stand %>% 
  filter(year == 2017) %>% 
  select(c(1:3,labor_expense)) %>% 
  filter(!is.na(labor_expense))

median(labor_exp$labor_expense)

labor_exp <- merge(labor_exp, frr, by = "GEOID")

labor_exp <- labor_exp %>%  select(c(1:4, 14))

heartland <- labor_exp %>% filter(FRR_NAME == "Heartland")
```

### **SI Figure 4**: 

#### (A.) Average age of primary operators in 2017. (B.) Change in average age between 1997 and 2017; where red, average age was less in 2017 than 1997. Data: USDA NASS QuickStats.
```{r message = FALSE, warning = FALSE}
############################################################
# Average Age
############################################################
age <- c_sf %>% select(c(1,9:13)) 

### Extract quantiles; use these to estimate quantiles, below!
q <- age %>% filter(year == 2017) %>% 
  pull(age) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() # to remove names of quantiles, so idx below is numeric

### What are the quantiles?
quantiles <- c(32.5,55,57.5,59,61.5,63,75)

### Create custom labels
labels <- c("32.5 – 55 years",      "55 – 57.5 years",    "57.5 – 59 years",    "59 – 61.5 years",   "61.5 – 63 years",  "> 63 years")

### Create a new variable with the quantiles
df <- age %>%
  mutate(mean_quantiles = cut(age,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(!is.na(age)) 

### PLOT
# Average age
ave_age <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "Reds") +
  theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), 
          legend.position="right",
          legend.key.size = unit(4, 'mm'))

############################################################
# Change in average Age between 1997 & 2017
############################################################
age_diff <- c %>% select(c(1:5)) %>%   
  filter(year %in% c(1997,2017)) %>% 
  group_by(GEOID, county) %>%
  summarise(age = diff(age)) %>% 
  filter(!is.na(age))

# percent cty's reporting reduction in average age
z<- age_diff %>% filter(age < 0) #67/3108 counties

t <- age_diff %>% filter(age <= 0)

age_diff <- merge(counties, age_diff, by = "GEOID")

### Extract quantiles; use these to estimate quantiles, below!
q<- age_diff %>%
  pull(age) %>%
  quantile(probs = seq(0, 1, length.out = 8), na.rm = T) %>%
  as.vector() # to remove names of quantiles, so idx below is numeric

quantiles <- c(-15,0,2.5,3.5,4.5,5.5,7.5,25)

labels <- c("< 0 years",      "0 - 2.5 years",    "2.5 - 3.5 years",    "3.5 - 4.5 years",   "4.5 - 5.5 years",  "5.5 - 7.5 years", "> 7.5 years")

age_diff <- age_diff %>%
  mutate(quantiles = cut(age,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(!is.na(age)) 

age_diff <- ggplot() +
  geom_sf(data = age_diff, aes(fill = quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_manual(values = c("#B2182B","#F7F7F7", "#D1E5F0", "#92C5DE", "#4393C3", "#2166AC", "#053061")) +
  theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), 
          legend.position="right",
          legend.key.size = unit(4, 'mm'))

# Build panel plots!
# (A.) % full owners, (B.) % tenants
library(ggpubr)
ggarrange(ave_age, age_diff, labels = c("A.", "B."), ncol = 2, font.label = list(size = 8))
ggsave("./visualizations/PNG/SI-Figure4.png", dpi = 400, units = "mm", width = 220, height = 60, bg = "white")
ggsave("./visualizations/JPEG/SI-Figure4.jpg", dpi = 300, units = "mm", width = 220, height = 60, bg = "white")
```

### **SI Figure 5**: 

American Indian or Alaska Native .......................................46,210

Asian ...................................................................................16,978

Black or African American ..................................................38,447

Native Hawaiian or Other Pacific Islander ...........................2,306

White ...................................................................................2,614,526

More than one race reported ...............................................21,986


**Hispanic principal producers' reported race:::**
American Indian or Alaska Native .......................................2,077

Asian ...................................................................................861

Black or African American ...................................................879

Native Hawaiian or Other Pacific Islander ...........................439

White ...................................................................................84,434

More than one race reported ...............................................1,654


**Principle Producers by race & hispanic origin (all races):**

American Indian or Alaska Native .......................................44133

Asian ...................................................................................16117

Black or African American ...................................................37568

Native Hawaiian or Other Pacific Islander ...........................1867

White ...................................................................................2530092

More than one race reported ...............................................20332

Hispanic (all races) ...............................................90344

#### Proportional bar charts showing (A.) the area operated by principal operators by their reported race, and (B.) operations by principal operator’s race; y-axis limits at proportion = 0.08 to show distinctions between races (ie. white operators represent over 90% of all operators and farm over 90% of all operated acres). Data: USDA NASS QuickStats.
```{r message = FALSE, warning = FALSE}
re <- read.csv("./data/race-ethnicity.csv")

re$RACE <- factor(re$RACE, levels = c("White", "More", "Hawaiian", "Black", "Asian", "American Indian", "Hispanic"))

# Stacked bar chart, race
# area operated
race_area <- re %>%
  filter(TYPE == "Area Operated") %>% 
ggplot(.) +
  geom_bar(aes(fill = RACE, y = VALUE, x = YEAR), position = "fill", stat = "identity") +
  scale_fill_manual(name = "", labels = c("White", "Multiple Races", "Native Hawaiian or Other Pacific Islander", "Black", "Asian", "American Indian or Alaskan Native", "Hispanic"), values=c("#332288","#117733","#CC6677", "#44AA99","#88CCEE","#DDCC77","#882255")) +
  labs(title = "", color = "", y = "Proportion of Area Operated", x = "") +
  project_theme +
  theme(legend.position="bottom") +
  coord_cartesian(ylim = c(0,0.080)) +
  scale_x_continuous(breaks = c(2007, 2012, 2017)) 

# operations
race_operations <- re %>%
  filter(TYPE == "Operations") %>% 
ggplot(.) +
  geom_bar(aes(fill = RACE, y = VALUE, x = YEAR), position = "fill", stat = "identity") +
  scale_fill_manual(name = "", labels = c("White", "Multiple Races", "Native Hawaiian or Other Pacific Islander", "Black", "Asian", "American Indian or Alaskan Native", "Hispanic"), values=c("#332288","#117733","#CC6677", "#44AA99","#88CCEE","#DDCC77","#882255")) +
  labs(title = "", color = "", y = "Proportion of Operations", x = "") +
  #geom_vline(xintercept=c(1997), linetype="dotted") +
  project_theme +
  theme(legend.position="bottom") +
  coord_cartesian(ylim = c(0,0.080)) +
  scale_x_continuous(breaks = c(2007, 2012, 2017)) 

# operators
race_operators <- re %>%
  filter(TYPE == "Operators") %>% 
ggplot(.) +
  geom_bar(aes(fill = RACE, y = VALUE, x = YEAR), position = "fill", stat = "identity") +
  scale_fill_manual(name = "", labels = c("White", "Multiple Races", "Native Hawaiian or Other Pacific Islander", "Black", "Asian", "American Indian or Alaskan Native", "Hispanic"), values=c("#332288","#117733","#CC6677", "#44AA99","#88CCEE","#DDCC77","#882255")) +
  labs(title = "", color = "", y = "Proportion of Operators", x = "") +
  #geom_vline(xintercept=c(1997), linetype="dotted") +
  project_theme +
  theme(legend.position="bottom") +
  coord_cartesian(ylim = c(0,0.080)) +
  scale_x_continuous(breaks = c(2007, 2012, 2017)) 


# Build panel plots!
ggarrange(race_operators, race_area, race_operations, labels = c("A.", "B.", "C."), ncol = 1, nrow = 3, common.legend = TRUE, legend = "bottom",
          font.label = list(size = 8))
ggsave("./visualizations/PNG/SI-Figure5.png", dpi = 400, width = 150, height = 220, units = "mm", bg = "white")
ggsave("./visualizations/JPEG/SI-Figure5.jpg", dpi = 300, width = 150, height = 220, units = "mm", bg = "white")
# race statistics
sum <- re %>% filter(YEAR == 2017) %>% group_by(TYPE) %>% summarise(total = sum(VALUE))

# nonwhite operations by race of principal producer
# ((total operations - white operations)/total operations*100)
((2063190-1955737)/2063190*100)
# nonwhite operated acres by race of principal producer
# ((total acreage - white acreage)/total acreage*100)
((907426277-843497615)/907426277*100)
```
### **SI Figure 6**: 

#### (A.) Percent agricultural acres operated by POC and Hispanic-identifying  (i.e., Black, American Indian or Native Alaskan, Multi-racial, Asian, Native Hawaiian or other Pacific Islander) principal operators in 2017, and (B.) Percent of all US farm operations operated by POC and Hispanic-identifying principal operators in 2017. Data: USDA NASS QuickStats
```{r message = FALSE, warning = FALSE}
############################################################
# Percent acres operated by folx identifying as black, hispanic, and white principal operators
############################################################

# proporation of each race
race_prop <- r %>% mutate(TOTAL = rowSums(.[7:13])) %>% 
  mutate(POC = (NATIVE_AMER + BLACK + MULTI + HISPANIC + ASIAN + PACIFIC_ISL)/TOTAL*100,
         NATIVE_AMER = NATIVE_AMER/TOTAL*100,
         BLACK = BLACK/TOTAL*100,
         MULTI = MULTI/TOTAL*100,
         WHITE = WHITE/TOTAL*100,
         HISPANIC = HISPANIC/TOTAL*100,
         ASIAN = ASIAN/TOTAL*100,
         PACIFIC_ISL = PACIFIC_ISL/TOTAL*100) %>% 
  filter(OPERATOR == "OPERATORS, PRINCIPAL") %>% 
  select("GEOID", "YEAR", "OPERATOR", "TYPE", "WHITE", "POC", "NATIVE_AMER", "BLACK", "MULTI", "HISPANIC", "ASIAN", "PACIFIC_ISL", "TOTAL") %>% 
  mutate_at(7:13, round, 3)

# build spatial
r_sf <- merge(counties, race_prop, by = "GEOID") 
############################################################
# Percent acres operated by POC principal operators
############################################################

### Extract quantiles; use these to estimate quantiles, below!
q <- r_sf %>% filter(YEAR == 2017, TYPE == "AREA OPERATED") %>% 
  pull(POC) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() # to remove names of quantiles, so idx below is numeric

### What are the quantiles?
quantiles <- c(0,0.125,0.75,2.5,5,25,100)

### Create custom labels
labels <- c("0 - 0.125%",      "0.125 - 0.75%",    "0.75 - 2.5%",    "2.5 - 5.0%",   "5.0 - 25.0%",  "> 25.0%")

### Create a new variable with the quantiles
df <- r_sf %>%
  mutate(mean_quantiles = cut(POC,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(!is.na(POC)) %>% 
  filter(YEAR == 2017, TYPE == "AREA OPERATED") 

### PLOT
# Percent POC operated acres - 2017
POC_acres <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "GnBu") +
  theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), 
          legend.position="right",
          legend.key.size = unit(4, 'mm'))

############################################################
# Percent operations operated by POC principle operators
############################################################

### Extract quantiles; use these to estimate quantiles, below!
q <- r_sf %>% filter(YEAR == 2017, TYPE == "OPERATIONS") %>% 
  pull(POC) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() # to remove names of quantiles, so idx below is numeric

### What are the quantiles?
quantiles <- c(0,1.25,2.5,5,10,25,100)

### Create custom labels
labels <- c("0 - 1.25%",      "1.25 - 2.5%",    "2.5 - 5.0%",    "5.0 - 10.0%",   "10.0 - 25.0%",  "> 25.0%")

### Create a new variable with the quantiles
df <- r_sf %>%
  mutate(mean_quantiles = cut(POC,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(!is.na(POC)) %>% 
  filter(YEAR == 2017, TYPE == "OPERATIONS") 

### PLOT
# Percent POC operated acres - 2017
POC_operations <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "YlGn") +
  theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), 
          legend.position="right",
          legend.key.size = unit(4, 'mm'))

# Build panel plots!
# (A.) Percent POC operated acres, (B.) Percent POC-run operations
library(ggpubr)
ggarrange(POC_acres, POC_operations, labels = c("A.", "B."), ncol = 2, font.label = list(size = 8))
ggsave("./visualizations/PNG/SI-Figure6.png", dpi = 400, units = "mm", width = 220, height = 60, bg = "white")
ggsave("./visualizations/JPEG/SI-Figure6.jpg", dpi = 300, units = "mm", width = 220, height = 60, bg = "white")
```

### **SI Figure 7**: 

#### Percent acreage operated by (A.) Black, (B.) Hispanic, (C.) white, and (D.) female identifying primary operators in 2017. Data: USDA QuickStats, 2017 COA.
```{r message = FALSE, warning = FALSE}
############################################################
# Percent acres operated by principal operators identifying as females
############################################################
female_acres <- c_sf %>% select(c(1,10:11,21)) 

### Extract quantiles; use these to estimate quantiles, below!
q <- female_acres %>% filter(year == 2017) %>% 
  pull(percf_acr) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() # to remove names of quantiles, so idx below is numeric

### What are the quantiles?
quantiles <- c(0,15,20,22.5,25,30,77)

### Create custom labels
labels <- c("0 – 15%",      "15 – 20%",    "20 – 22.5%",    "22.5 – 25.0%",   "25.0 – 30.0%",  "> 30.0%")

### Create a new variable with the quantiles
df <- female_acres %>%
  mutate(mean_quantiles = cut(percf_acr,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(!is.na(percf_acr)) %>% 
  filter(year == 2017)

### PLOT
# Percent acres operated by women - 2017
female_acres <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "Greens") +
  theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), 
          legend.position="right",
          legend.key.size = unit(4, 'mm'))

### Extract quantiles; use these to estimate quantiles, below!
q <- r_sf %>% filter(YEAR == 2017, TYPE == "AREA OPERATED") %>% 
  pull(WHITE) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() 

### What are the quantiles?
q_h <- c(0,0.25,0.5,1.0,2.5,5.0,101)
q_b <- c(0,0.25,0.5,1.0,2.5,5.0,72)
q_w <- c(0,90,95,97.5,98.5,99.5,100.1)

### Create custom labels
l_h <- c("0 - 0.25%",      "0.25 - 0.5%",    "0.5 - 1.0%",    "1.0 - 2.5%",   "2.5 - 5.0%",  "> 5.0%")
l_b <- c("0 - 0.25%",      "0.25 - 0.5%",    "0.5 - 1.0%",    "1.0 - 2.5%",   "2.5 - 5.0%",  "> 5.0%")
l_w <- c("0 - 90.0%",    "90.0 - 95.0%",   "95.0 - 97.5%",   "97.5 - 98.5%", "98.5 - 99.5%",  "> 99.5%")

### Create a new variable with the quantiles
df <- r_sf %>%
  mutate(mean_quantiles = cut(HISPANIC,
                               breaks = q_h,
                               labels = l_h,
                               include.lowest = T)) %>% 
  filter(!is.na(HISPANIC)) %>% 
  filter(YEAR == 2017, TYPE == "AREA OPERATED") 

### PLOT
# Percent HISPANIC operators - 2017
hisp_acres <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "Purples") +
  theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), 
          legend.position="right",
          legend.key.size = unit(4, 'mm'))

### Create a new variable with the quantiles
df <- r_sf %>%
  mutate(mean_quantiles = cut(BLACK,
                               breaks = q_b,
                               labels = l_b,
                               include.lowest = T)) %>% 
  filter(!is.na(BLACK)) %>% 
  filter(YEAR == 2017, TYPE == "AREA OPERATED") 

### PLOT
# Percent BLACK operators - 2017
black_acres <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "Oranges") +
  theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), 
          legend.position="right",
          legend.key.size = unit(4, 'mm'))

### Create a new variable with the quantiles
df <- r_sf %>%
  mutate(mean_quantiles = cut(WHITE,
                               breaks = q_w,
                               labels = l_w,
                               include.lowest = T)) %>% 
  filter(!is.na(WHITE)) %>% 
  filter(YEAR == 2017, TYPE == "AREA OPERATED") 

### PLOT
# Percent WHITE operators - 2017
white_acres <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "Reds") +
  theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), 
          legend.position="right",
          legend.key.size = unit(4, 'mm'))

# Build panel plots!
# (A.) Black, (B.) Hispanic, (C.) white and (D.) female operated acreage
library(ggpubr)
ggarrange(black_acres, hisp_acres, white_acres, female_acres, labels = c("A.", "B.", "C.", "D."), ncol = 2, nrow = 2, font.label = list(size = 8))
ggsave("./visualizations/PNG/SI-Figure7.png", dpi = 400, width = 220, height = 120, units = "mm", bg = "white")
ggsave("./visualizations/JPEG/SI-Figure7.jpg", dpi = 300, width = 220, height = 120, units = "mm", bg = "white")
```

### **SI Figure 8**:

Change in most expensive inputs to agriculture. Data: USDA ERS, 2021c.
```{r message = FALSE, warning = FALSE}
hist <- readRDS("./data/hist_cws.RDS")
recent <- readRDS("./data/recent_cws.RDS")

build_time_series <- function(vars) {
  
 his <- hist %>% filter(ITEM == vars[[1]]) %>% select(YEAR, VALUE, ITEM, CROP)
 rec <- recent %>% filter(REGION_ID == 10, ITEM == vars[[2]]) %>% select(YEAR, VALUE, ITEM, CROP)
 
 fullts <- rbind.data.frame(his, rec)
 
 return(fullts)

}

varlist <- list(
  # Variable cash expenses
  c("Seed", "Seed"),
  c("Fertilizer, lime, and gypsum", "Fertilizer"),
  c("Chemicals", "Chemicals"),
  c("Custom operations", "Custom services"), # cost of custom operations, technical services and commercial drying
  c("Fuel, lube, and electricity", "Fuel, lube, and electricity"),
  c("Repairs", "Repairs"),
  c("Hired labor", "Hired labor"),
  c("Other variable cash expenses", "Purchased irrigation water"), # cost of purchased irrigation water
  # Misc
  c("Interest", "Interest on operating capital"), # Check two interest categories
  c("Taxes and insurance", "Taxes and insurance"),
  # Economic (full ownership costs) 
  c("Land", "Opportunity cost of land"),
  c("Unpaid labor", "Opportunity cost of unpaid labor"),
  c( "Other nonland capital" , "Interest on operating inputs"),
  c("Capital replacement", "Capital recovery of machinery and equipment"),   
  c("Operating capital", "")) # unsure here

vn <- c("Seed", "Fertilizer", "Chemicals", "Custom services",
        "Fuel", "Repairs", "Hired labor", "Irrigation water", "Interest", "Taxes and insurance",
        "Land", "Unpaid labor", "Remove", "Capital replacement", "Remove")

all_exp <- list()

for (v in 1:length(varlist)) {
  
  df <- build_time_series(varlist[[v]])
  df$VARS <- vn[[v]]
  
  all_exp[[v]] <- df

}

all_exp <- do.call(rbind.data.frame, all_exp) 
all_exp <- all_exp %>% filter(!VARS %in% c("Remove"))

adj <- read.csv("./data/adjustment.csv") %>% filter(Period == "YEAR") %>%
  select(Year, Value)
colnames(adj) <- c("YEAR", "PRICE_ADJ")

pxnviz <- merge(all_exp, adj, by = "YEAR" , all = T)
pxnviz$VALUE_ADJ <- (pxnviz$VALUE * pxnviz$PRICE_ADJ)/100

all_exp <- pxnviz %>% filter(!is.na(VALUE_ADJ))
all_exp$OG_VALUE <- all_exp$VALUE
all_exp$VALUE <- all_exp$VALUE_ADJ # lazy and don't want to rewrite code below

max <- all_exp %>%
  group_by(YEAR, VARS) %>%
  summarize(AVG_EXP = mean(VALUE, na.rm=T)) %>%
  filter(YEAR == 2020) %>%
  arrange(VARS)

min <- all_exp %>%
  group_by(YEAR, VARS) %>%
  summarize(AVG_EXP = mean(VALUE, na.rm=T)) %>%
  filter(YEAR == 1990) %>%
  arrange(VARS)

max$DELTA <- max$AVG_EXP - min$AVG_EXP

max %>%
  ggplot(.) +
  geom_bar(aes(x = reorder(VARS, DELTA), y = DELTA ), stat = "identity") +
  project_theme +
  coord_flip() +
  labs(x = "", y = "$/acre", title = "Change in expenditures from 1990 to 2020") 

ggsave("./visualizations/PNG/SI-Figure8.png", dpi = 400, width = 200, height = 80, units = "mm")
ggsave("./visualizations/JPEG/SI-Figure8.jpg", dpi = 300, width = 200, height = 80, units = "mm")
```



### **SI Figure 9**: 

#### Share of gross farm cash receipts spent on all agricultural inputs. During the height of the Farm Crisis of the 1980s, for instance, US farmers spent over 90% of their gross earnings (ie. earnings before subtracting production expenses) on inputs to agriculture. 
```{r message = FALSE, warning = FALSE}
bea$YEAR<-as.numeric(bea$YEAR) 
bea %>% select(c(1:3,11,23)) %>% filter(GeoName == "United States") %>% mutate(prod_exp = (prod_exp)/cash_income*100) %>% 
  ggplot(.) +
  geom_line(aes(x = YEAR, y = prod_exp), color = "#88CCEE", size = 1.5) +
  project_theme +
  labs(title = "", color = "", y = "Share of Earnings (%) Spent on Inputs", x = "") 

  ggsave("./visualizations/PNG/SI-Figure9.png", dpi = 400, width = 100, height = 80, units = "mm")
  ggsave("./visualizations/JPEG/SI-Figure9.jpg", dpi = 300, width = 100, height = 80, units = "mm")
```

### **SI Figure 10**:

National Expenditure on inputs to agricultural production. Data: USDA ERS, 2021c.
```{r message = FALSE, warning = FALSE}
prop <- all_exp %>% select(-c(ITEM)) %>% pivot_wider(names_from = VARS, values_from = VALUE)
prop$SUM <- rowSums(prop[3:ncol(prop)])
prop$Seed <- prop$Seed/prop$SUM
prop$Fertilizer <- prop$Fertilizer/prop$SUM
prop$Chemicals <- prop$Chemicals/prop$SUM
prop$`Custom services` <- prop$`Custom services`/prop$SUM
prop$Fuel <- prop$Fuel/prop$SUM
prop$Repairs <- prop$Repairs/prop$SUM
prop$`Hired labor` <- prop$`Hired labor`/prop$SUM
prop$`Irrigation water` <- prop$`Irrigation water`/prop$SUM
prop$Interest <- prop$Interest/prop$SUM
prop$`Taxes and insurance` <- prop$`Taxes and insurance`/prop$SUM
prop$Land <- prop$Land/prop$SUM
prop$`Unpaid labor` <- prop$`Unpaid labor`/prop$SUM
prop$`Capital replacement` <- prop$`Capital replacement`/prop$SUM

library(viridis)
library(RColorBrewer)

myColors <- c(brewer.pal(12, "Set3"), "dark blue")
ggplot(all_exp %>% filter(YEAR %in% seq(1990, 2020, by = 1))) +
  geom_bar(aes(fill = VARS, y = VALUE, x = YEAR), position = "stack", stat = "identity") +
  project_theme +
  labs(x = "", y = "$/acre", fill = "") + facet_wrap(~CROP) +
  scale_fill_manual(name = "", values = myColors)

ggsave("./visualizations/PNG/SI-Figure10.png", dpi = 400, width = 200, height = 100, units = "mm")
ggsave("./visualizations/JPEG/SI-Figure10.jpg", dpi = 300, width = 200, height = 100, units = "mm")
```

### **SI Figure 11**: 

#### Agricultural input expenditure as a proportion of gross farm cash receipts in 2017; where values are > 100% county input expenditures surpassed gross farm earnings. For example, in Chattahoochee, GA expenditure on inputs surpassed gross earnings for the county by just under 1000%. Data: US BEA. 
```{r message = FALSE, warning = FALSE}
# county-level, in most recent year
g <- bea %>% select(c(1:3,11,23)) %>% mutate(perc = prod_exp/cash_income*100) %>% filter(!is.na(perc),                                                                                   YEAR == 2019) 
g_sf <- merge(counties, g, by = "GEOID")

# Pull quantiles
q<- g_sf %>%
  pull(perc) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() 

quantiles <- c(0,70,85,100,125,150,200,1000)
labels <- c("0 - 70%",      "70 - 85%",    "85 - 100%",    "100 - 125%",   "125 - 150%",  "150 - 200%", "> 200%")

# Map ag contribution to GDP
g_sf %>%
  mutate(quantiles = cut(perc,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
ggplot(.) +
  geom_sf(aes(fill = quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_manual(values=c("#053061", "#4393C3", "#92C5DE",  "#FDDBC7", "#D6604D", "#B2182B", "#67001F"),name="") +
  theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), 
          legend.position="right",
          legend.key.size = unit(4, 'mm'))

  ggsave('./visualizations/PNG/SI-Figure11.png', dpi = 400, width = 110, height = 60, units = "mm", bg = "white")
  ggsave('./visualizations/JPEG/SI-Figure11.jpg', dpi = 300, width = 110, height = 60, units = "mm", bg = "white")
```

### **SI Figure 12**: 

#### Proportion of acres operated by tenancy status. Data: USDA NASS QuickStats.
```{r message = FALSE, warning = FALSE}
c %>%
  select(c(1:2,18:20)) %>% 
  pivot_longer(!c(1,2), names_to = "tenancy", values_to = "acres") %>% 
ggplot(.) +
  geom_bar(aes(fill = forcats::fct_rev(tenancy), y = acres, x = year), position = "fill", stat = "identity") +
  scale_fill_manual(name = "", labels = c("Tenant", "Part Owner", "Full Owner"), values=c("#44AA99","#88CCEE","#882255")) +
  labs(title = "", color = "", y = "", x = "") +
  project_theme +
  theme(legend.position="bottom") +
  scale_x_continuous(breaks = c(1997, 2002, 2007, 2012, 2017)) 
  ggsave("./visualizations/PNG/SI-Figure12.png", dpi = 400, width = 100, height = 80, units = "mm")
  ggsave("./visualizations/JPEG/SI-Figure12.jpg", dpi = 300, width = 100, height = 80, units = "mm")

# STATS
# tenancy through time

z <- c %>%
  select(c(1:2,18:20)) %>% 
  filter(year == 2017)   

z[is.na(z)] <- 0 

z <- z %>% group_by(year) %>% 
  summarise(full_owner = sum(full_owner),
            part_owner = sum(part_owner),
            tenant = sum(tenant))

# proportion of acres operated by tenancy status
# full owner
294702960/879236316
# part owner
501792110/879236316
# tenant
82741246/879236316
```

### **SI Figure 13**: 

#### Agricultural real estate debt from 1969 to 2019, adjusted for inflation using the chain-type GDP deflator provided by the USDA ERS. Data: USDA ERS.
```{r message = FALSE, warning = FALSE}
# tidy data
library(viridis)
w <- read.csv("./data/ers-wealthstatdata.csv")
w <- w[c(1,2,4:8,11)]

debt <- w %>% 
  filter(VariableDescriptionPart1 %in% c("Real estate","Farm sector debt","Non-real estate"))

debt$variable <- paste(debt$VariableDescriptionPart1, debt$VariableDescriptionPart2, sep="_")

debt <- debt[c(1,2,6,8:9)]
unique(debt$variable)

debt <- debt %>% mutate(REAL_GDP = Amount / (ChainType_GDP_Deflator/100))

debt_tidy <- debt %>% pivot_wider(names_from = variable, values_from = Amount)

# VIZ
debt %>%
  filter(variable %in% c("Real estate_Commercial banks","Real estate_CCC storage and drying loans","Real estate_Farm Credit System","Real estate_Farm Service Agency","Real estate_Farmer Mac","Real estate_Individuals and others","Real estate_Life insurance companies"),
         Year >= 1960) %>%
ggplot(.) +
    geom_bar(aes(fill=variable, y=REAL_GDP*1000, x=Year), position="stack", stat="identity") +
    scale_fill_viridis(discrete = T, option = "magma",labels = c("CCC Loans", "Commercial Banks", "Farm Credit System","Farm Service Agency","Farmer Mac","Individuals & Others", "Life Insurance"),name="Holder") +
    project_theme +
  #scale_fill_discrete(labels = c("CCC Loans", "Commercial Banks", "Farm Credit System","Farm Service Agency","Farmer Mac","Individuals & Others", "Life Insurance"), values = c("#000004FF", "#2D1160FF", "#721F81FF", "#B63679FF", "#F1605DFF", "#FEAF77FF", "#FCFDBFFF")) +
    xlab("") +
  labs(title = "", y = "Real US Dollars") +
  scale_y_continuous(breaks=c(100000000000,200000000000,300000000000),
        labels=c("$100B","$200B","$300B")) +
  theme(legend.position="bottom") 

  ggsave("./visualizations/PNG/SI-Figure13.png", dpi = 400, width = 140, height = 80, units = "mm")
  ggsave("./visualizations/JPEG/SI-Figure13.jpg", dpi = 300, width = 140, height = 80, units = "mm")
```

### **SI Figure 14**: 

#### Agricultural non-real estate debt from 1969 to 2019, adjusted for inflation using the chain-type GDP deflator provided by the USDA ERS. Data: USDA ERS.
```{r message = FALSE, warning = FALSE}
debt %>%
  filter(variable %in% c("Non-real estate_Farm Credit System","Non-real estate_Farm Service Agency","Non-real estate_Individuals and others","Non-real estate_Commerical banks"),
         Year >= 1960) %>%
ggplot(.) +
    geom_bar(aes(fill=variable, y=REAL_GDP*1000, x=Year), position="stack", stat="identity") +
    scale_fill_viridis(discrete = T, labels = c("Farm Credit System","Farm Service Agency","Individuals & Others", "Commercial Banks"), name = "Holder") +
    ggtitle("Proportion of Non-real Estate Debt: By holder") +
    project_theme +
  labs(title = "", y = "Real US Dollars") +
  scale_y_continuous(breaks=c(50000000000,100000000000,150000000000,200000000000),
        labels=c("$50B","$100B","$150B","$200B")) +
  theme(legend.position="bottom") 

  ggsave("./visualizations/PNG/SI-Figure14.png", dpi = 400, width = 140, height = 80, units = "mm")
  ggsave("visualizations/JPEG/SI-Figure14.jpg", dpi = 300, width = 140, height = 80, units = "mm")
```

### **SI Figure 15**: 

#### Average realized net income of farmers from (A.) 1969-1973 and (B.) 2015-2019 (adjusted to 2019 dollars). Net income is defined as total cash receipts from all farms less production expenses and is analogous to USDA NASS measures of net cash farm income. We visualize BEA realized net income data because it dates back to 1969 while USDA NASS county-level data only dates back to 1997. Counties in which net income is negative (red) had average production expenses that surpassed total cash receipts. Over the period from 2015-2019, 28.9% of counties reported negative average net income compared to 26.4% in 2019 alone, while from 1969-1973, 0.9% of counties reported negative average net income compared to 2.3% in 1969 alone. Data: US BEAb.
```{r message = FALSE, warning = FALSE}

options(scipen = 100)
library(blscrapeR) 

df<-inflation_adjust(2019) #this pulls a table of adjustment values (adjustment to 2019 $) 
glimpse(df) 

df$year<-as.numeric(df$year) 
bea <- readRDS("./data/bea.RDS")
bea$YEAR <- as.numeric(bea$YEAR)

dat<-left_join(bea,df[,c(1,3)], by=c("YEAR"="year")) #this basically joins the inflation adjustment values to the dataset you want to adjust by joining by year of the data (so the current year data in the BEA dataset) in this case I am inflation adjusting the per capita income levels (pci) 
dat$net_income_adj<-dat$net_income/dat$adj_value 

# build averages from 2015-2019
i <- dat %>% 
  filter(GEOID %in% counties$GEOID, YEAR %in% c(2015:2019)) %>% 
  select(c(1:3,69)) %>% 
  filter(!is.na(net_income_adj)) %>% 
  mutate(net_income = net_income_adj*1000) %>% 
  group_by(GEOID) %>% 
  mutate(average = mean(net_income)) %>% 
  select(1,3,6) %>% 
  unique()

i_sf <- merge(counties, i, by = "GEOID")
glimpse(i_sf)

# Pull quantiles
q<- i_sf %>%
  pull(average) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() 

quantiles <- c(-80000000,0,5000000, 10000000,20000000,40000000,60000000,8000000000)
labels <- c("< $0",      "$0 - $5M",    "$5 - $10M",    "$10 - $20M",   "$20 - $40M",  "$40 - $60M", "> $60M")

income_ave19 <- i_sf %>%
  mutate(quantiles = cut(average,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
ggplot(.) +
  geom_sf(aes(fill = quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  theme_map() +
   theme(panel.grid.major = element_line(colour = "white"), 
          legend.position="outside",
          legend.key.size = unit(4, 'mm')) +
  scale_fill_manual(values = c("#B2182B", "#ebf8ff", "#D1E5F0", "#92C5DE", "#4393C3", "#2166AC", "#053061"),name="") 

# less than zero over five years
885/3057
t <- i_sf %>% 
  filter(average < 0)

# build averages from 1969-1973
i <- dat %>% 
  filter(GEOID %in% counties$GEOID, YEAR %in% c(1969:1973)) %>% 
  select(c(1:3,69)) %>% 
  filter(!is.na(net_income_adj)) %>% 
  mutate(net_income = net_income_adj*1000) %>% 
  group_by(GEOID) %>% 
  mutate(average = mean(net_income)) %>% 
  select(1,3,6) %>% 
  unique()

i_sf <- merge(counties, i, by = "GEOID")
glimpse(i_sf)

# Pull quantiles
q<- i_sf %>%
  pull(average) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() 

quantiles <- c(-80000000,0,5000000, 10000000,20000000,40000000,60000000,8000000000)
labels <- c("< $0",      "$0 - $5M",    "$5 - $10M",    "$10 - $20M",   "$20 - $40M",  "$40 - $60M", "> $60M")

income_ave69 <- i_sf %>%
  mutate(quantiles = cut(average,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
ggplot(.) +
  geom_sf(aes(fill = quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  theme_map() +
   theme(panel.grid.major = element_line(colour = "white"), 
          legend.position="outside",
          legend.key.size = unit(4, 'mm')) +
  scale_fill_manual(values = c("#B2182B", "#ebf8ff", "#D1E5F0", "#92C5DE", "#4393C3", "#2166AC", "#053061"),name="") 

# less than zero over five years
29/3052
t <- i_sf %>% 
  filter(average < 0)

# Build panel plots!
# (A.) net income 1969 (adjusted), (B.) net income 2019
ggarrange(income_ave69, income_ave19, labels = c("A.", "B."), font.label = list(size = 8), common.legend = TRUE, legend = "right")
ggsave("./visualizations/PNG/SIFigure15.png", dpi = 400, width = 220, height = 60, units = "mm", bg = "white")
ggsave("./visualizations/JPEG/SIFigure15.jpg", dpi = 300, width = 200, height = 60, units = "mm", bg = "white")
```

