---
title: 'Data Visualizations, by Figure #'
author: "Britta Schumacher"
date: "Last updated: `r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    theme: yeti
    toc: yes
    toc_float: true
---

## Load relevant packages & common data
```{r}
library(tidyverse)
library(ggplot2)
library(ggpubr)
library(sf)

# common data
counties <- readRDS("./data/coterm_cty_sf.RDS") 
states <- readRDS("./data/states_sf.RDS") 
states <- states %>% filter(STATE_FIPS %in% counties$STATEFP)
bea <- readRDS("./data/bea.RDS")
c <- readRDS("./data/contemp-coa.RDS")
r <- readRDS("./data/coa-race.RDS")
h <- read.csv("./data/historical-coa.csv")

# Build spatial
c_sf <- merge(counties, c, by = "GEOID")

# notes from EB
project_theme <- theme_bw() +
  theme(text = element_text(size=8))

# 
paste_noNA <- function(x,sep=", ") {
gsub(", " ,sep, toString(x[!is.na(x) & x!="" & x!="NA"] ) ) }
```


# Pull in theme for maps
```{r}
theme_map <- function(...) {
  theme_minimal() +
  theme(
    # remove all axes
    axis.line = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),

    # borders and margins
    panel.border = element_blank(),
    
    # titles
    legend.title = element_blank(),
    legend.text = element_text(size = 7, hjust = 0,
                               color = "black"),
    plot.title = element_text(size = 15, hjust = 0.5,
                              color = "black"),
    plot.subtitle = element_text(size = 10, hjust = 0.5,
                                 color = "black",
                                 margin = margin(b = -0.1,
                                                 t = -0.1,
                                                 l = 2,
                                                 unit = "cm"),
                                 debug = F),
    ...
  )
}
```

### SI Figure 1: The agricultural contribution to a county’s GDP in 2019. Data: US BEA. 
```{r}
# county-level, in most recent year
g <- bea %>% filter(GEOID %in% counties$GEOID, YEAR == 2019) %>% mutate(contrib = current_GDP_ag / current_GDP * 100) %>% filter(!is.na(contrib))

#464 counties > 10%

g_sf <- merge(counties, g, by = "GEOID")
glimpse(g_sf)

# Pull quantiles
q<- g_sf %>%
  pull(contrib) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() 

quantiles <- c(0,0.5,1,2.5,5,15,30,90)
labels <- c("0 - 0.5%",      "0.5 - 1%",    "1 - 2.5%",    "2.5 - 5%",   "5 - 15%", "15 - 30%",  "30 - 80%")

# Map ag contribution to GDP
g_sf %>%
  mutate(quantiles = cut(contrib,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(YEAR == 2019) %>% 
ggplot(.) +
  geom_sf(aes(fill = quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), legend.position="bottom",
          legend.key.size = unit(2, 'mm')) +
  scale_fill_manual(values=c("#fef6b5","#ffdd9a","#ffc285","#ffa679","#fa8a76","#f16d7a","#e15383"),name="") +
  ggsave('./viz/SI-Figure1.png', dpi = 400, width = 100, height = 80, units = "mm")
```
### SI Figure 2: The proportion of all workers engaged in the direct production of agricultural commodities, livestock or crops (includes sole proprietors, partners, and hired laborers) in 2019. Data: US BEA
```{r}
# Farm employment as percentage of total county employment
# county-level, in most recent year (sf/ggplot())
fc <- bea %>% filter(GEOID %in% counties$GEOID) %>% select(c(1:2,38:39,44:45)) 
fc$farmempl <- as.numeric(apply(fc[c(5:6)],1,paste_noNA))
fc$totjobs <- as.numeric(apply(fc[c(3:4)],1,paste_noNA))

fc <- fc %>% mutate(prop_farm = farmempl/totjobs*100) %>% select(1:2,7:9)

fc_sf <- merge(counties, fc, by = "GEOID")

# Pull quantiles
q<- fc_sf %>%
  pull(prop_farm) %>%
  quantile(probs = seq(0, 1, length.out = 8), na.rm = T) %>%
  as.vector() 

quantiles <- c(0,2.5,5,7.5,10,15,30,75)
labels <- c("0 – 2.5%",      "2.5 - 5.0%",    "5.0 - 7.5%",    "7.5 - 10.0%",   "10.0 - 15.0%",  "15.0 - 30.0%", "> 30.0%")

# Map ag contribution to GDP
fc_sf %>%
  mutate(quantiles = cut(prop_farm,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(YEAR == 2019) %>%
  filter(!is.na(prop_farm)) %>% 
ggplot(.) +
  geom_sf(aes(fill = quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), legend.position="bottom",
          legend.key.size = unit(2, 'mm')) +
  scale_fill_manual(values=c("#f9ddda","#f2b9c4","#e597b9","#ce78b3","#ad5fad","#834ba0","#573b88"),name="") +
  ggsave('./viz/SI-Figure2.png', dpi = 400, width = 100, height = 80, units = "mm")
```

### SI Figure 3: (A.) Average age of primary operators in 2017. (B.) Change in average age between 1997 and 2017; where red, average age was less in 2017 than 1997. Data: USDA NASS QuickStats.
```{r}
############################################################
# Average Age
############################################################
age <- c_sf %>% select(c(1,9:13)) 

### Extract quantiles; use these to estimate quantiles, below!
q <- age %>% filter(year == 2017) %>% 
  pull(age) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() # to remove names of quantiles, so idx below is numeric

### What are the quantiles?
quantiles <- c(32.5,55,57.5,59,61.5,63,75)

### Create custom labels
labels <- c("32.5 – 55 years",      "55 – 57.5 years",    "57.5 – 59 years",    "59 – 61.5 years",   "61.5 – 63 years",  "> 63 years")

### Create a new variable with the quantiles
df <- age %>%
  mutate(mean_quantiles = cut(age,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(!is.na(age)) 

### PLOT
# Average age
ave_age <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "Reds") +
  theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), legend.position="bottom",
          legend.key.size = unit(2, 'mm'))

############################################################
# Change in average Age between 1997 & 2017
############################################################
age_diff <- c %>% select(c(1:5)) %>%   
  filter(year %in% c(1997,2017)) %>% 
  group_by(GEOID, county) %>%
  #pivot_wider(names_from = year, values_from = age) %>% 
  summarise(age = diff(age))

t <- age_diff %>% filter(age <= 0)

age_diff <- merge(counties, age_diff, by = "GEOID")

### Extract quantiles; use these to estimate quantiles, below!
q<- age_diff %>%
  pull(age) %>%
  quantile(probs = seq(0, 1, length.out = 8), na.rm = T) %>%
  as.vector() # to remove names of quantiles, so idx below is numeric

quantiles <- c(-15,0,2.5,3.5,4.5,5.5,7.5,25)

labels <- c("< 0 years",      "0 - 2.5 years",    "2.5 - 3.5 years",    "3.5 - 4.5 years",   "4.5 - 5.5 years",  "5.5 - 7.5 years", "> 7.5 years")

age_diff <- age_diff %>%
  mutate(quantiles = cut(age,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(!is.na(age)) 

age_diff <- ggplot() +
  geom_sf(data = age_diff, aes(fill = quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  theme_map() +
  scale_fill_manual(values = c("#B2182B","#F7F7F7", "#D1E5F0", "#92C5DE", "#4393C3", "#2166AC", "#053061")) +
  theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), legend.position="bottom",
          legend.key.size = unit(2, 'mm'))

# Build panel plots!
# (A.) % full owners, (B.) % tenants
ggarrange(ave_age, age_diff, labels = c("A.", "B."), ncol = 2, font.label = list(size = 8))
ggsave("./viz/SI-Figure3.png", dpi = 400, width = 200, height = 80, units = "mm")
```

### SI Figure 4: Experience, years on present farm; The vertical line in 1997 reflects USDA-NASS implementation of adjustments for under-coverage. We do not include the non-adjusted ‘97 values. Data: Robert Hoppe, USDA ERS.
```{r}
# Experience

z <- h %>%
  select(c(1,18:20)) %>% filter(!is.na(exp_05)) %>% mutate(perc = exp_10/(exp_05+exp_09+exp_10)) %>%
  pivot_longer(!c(1,5), names_to = "exp", values_to = "count") %>%  
ggplot(.) +
  geom_bar(aes(fill = exp, y = count, x = year), position = "fill", stat = "identity") +
  scale_fill_manual(name = "", labels = c("Less than 5", "5 to 9", "Greater than 10"), values=c("#117733","#44AA99","#88CCEE")) +
  labs(title = "", color = "", y = "", x = "") +
  geom_vline(xintercept=c(1997), linetype="dotted") +
  project_theme +
  theme(legend.position="bottom") +
  ggsave('./viz/SI-Figure4.png', dpi = 400, width = 100, height = 80, units = "mm")
```

### SI Figure 5: Primary operators reported years’ experience on any operation in 2017. Data: USDA NASS QuickStats.
```{r}
############################################################
# Years on any operation
############################################################

exp <- c_sf %>% select(c(1,10,12,17)) 

### Extract quantiles; use these to estimate quantiles, below!
q <- exp %>% filter(year == 2017) %>% 
  pull(exp) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() # to remove names of quantiles, so idx below is numeric

### What are the quantiles?
quantiles <- c(5,15,20,22.5,25,27.5,32.6)

### Create custom labels
labels <- c("5 - 15 years",      "15 - 20 years",    "20 – 22.5 years",    "22.5 - 25 years",   "25 - 27.5 years",  "> 27.5 years")

### Create a new variable with the quantiles
df <- exp %>%
  mutate(mean_quantiles = cut(exp,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(!is.na(exp)) %>% 
  filter(year == 2017) 

### PLOT
ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "Blues") +
  theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), legend.position="bottom",
          legend.key.size = unit(2, 'mm')) +
  ggsave('./viz/SI-Figure5.png', dpi = 400, width = 100, height = 80, units = "mm")
  
# STATS
t <- c %>% select(c(1,2,8)) %>% filter(year == 2017) %>% filter(exp >= 10)
```

### SI Figure 6: Proportional bar charts showing (A.) the area operated by principal operators by their reported race, and (B.) operations by principal operator’s race; y-axis limits at proportion = 0.08 to show distinctions between races (ie. white operators represent over 90% of all operators and farm over 90% of all operated acres). Data: USDA NASS QuickStats.
```{r}
# Stacked bar chart, race
# area operated
race_area <- r %>%
  filter(OPERATOR == "OPERATORS, PRINCIPAL", TYPE == "AREA OPERATED") %>% 
  select(c(1,4,7:13)) %>% 
  pivot_longer(!c(1,2), names_to = "race", values_to = "acres") %>% 
ggplot(.) +
  geom_bar(aes(fill = forcats::fct_rev(race), y = acres, x = YEAR), position = "fill", stat = "identity") +
  scale_fill_manual(name = "", labels = c("White", "Native Hawaiian or Other Pacific Islander", "American Indian or Alaskan Native", "Multiple Races", "Hispanic", "Black", "Asian"), values=c("#332288","#117733","#44AA99","#88CCEE","#DDCC77","#CC6677","#AA4499")) +
  labs(title = "", color = "", y = "Proportion of Area Operated", x = "") +
  #geom_vline(xintercept=c(1997), linetype="dotted") +
  project_theme +
  theme(legend.position="bottom") +
  coord_cartesian(ylim = c(0,0.085)) +
  scale_x_continuous(breaks = c(2007, 2012, 2017)) 

# operations
race_operations <- r %>%
  filter(OPERATOR == "OPERATORS, PRINCIPAL", TYPE == "OPERATIONS") %>% 
  select(c(1,4,7:13)) %>% 
  pivot_longer(!c(1,2), names_to = "race", values_to = "acres") %>% 
ggplot(.) +
  geom_bar(aes(fill = forcats::fct_rev(race), y = acres, x = YEAR), position = "fill", stat = "identity") +
  scale_fill_manual(name = "", labels = c("White", "Native Hawaiian or Other Pacific Islander", "American Indian or Alaskan Native", "Multiple Races", "Hispanic", "Black", "Asian"), values=c("#332288","#117733","#44AA99","#88CCEE","#DDCC77","#CC6677","#AA4499")) +
  labs(title = "", color = "", y = "Proportion of Operations", x = "") +
  #geom_vline(xintercept=c(1997), linetype="dotted") +
  project_theme +
  theme(legend.position="bottom") +
  coord_cartesian(ylim = c(0,0.085)) +
  scale_x_continuous(breaks = c(2007, 2012, 2017)) 

# Build panel plots!
ggarrange(race_area, race_operations, labels = c("A.", "B."), ncol = 2, nrow = 1, common.legend = TRUE, legend = "bottom",
          font.label = list(size = 8))
ggsave("./viz/SI-Figure6.png", dpi = 400, width = 200, height = 80, units = "mm")
```

### SI Figure 7: Percent acreage operated by (A.) Black, (B.) Hispanic, (C.) white, and (D.) female identifying primary operators in 2017. Data: USDA QuickStats, 2017 COA.
```{r}
############################################################
# Percent acres operated by principal operators identifying as females
############################################################
female_acres <- c_sf %>% select(c(1,10:11,21)) 

### Extract quantiles; use these to estimate quantiles, below!
q <- female_acres %>% filter(year == 2017) %>% 
  pull(percf_acr) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() # to remove names of quantiles, so idx below is numeric

### What are the quantiles?
quantiles <- c(0,15,20,22.5,25,30,77)

### Create custom labels
labels <- c("0 – 15%",      "15 – 20%",    "20 – 22.5%",    "22.5 – 25.0%",   "25.0 – 30.0%",  "> 30.0%")

### Create a new variable with the quantiles
df <- female_acres %>%
  mutate(mean_quantiles = cut(percf_acr,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(!is.na(percf_acr)) %>% 
  filter(year == 2017)

### PLOT
# Percent acres operated by women - 2017
female_acres <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "Greens") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), legend.position="bottom",
          legend.key.size = unit(2, 'mm'))

############################################################
# Percent acres operated by folx identifying as black, hispanic, and white principal operators
############################################################

# proporation of each race
race_prop <- r %>% mutate(TOTAL = rowSums(.[7:13])) %>% 
  mutate(POC = (NATIVE_AMER + BLACK + MULTI + HISPANIC + ASIAN + PACIFIC_ISL)/TOTAL*100,
         NATIVE_AMER = NATIVE_AMER/TOTAL*100,
         BLACK = BLACK/TOTAL*100,
         MULTI = MULTI/TOTAL*100,
         WHITE = WHITE/TOTAL*100,
         HISPANIC = HISPANIC/TOTAL*100,
         ASIAN = ASIAN/TOTAL*100,
         PACIFIC_ISL = PACIFIC_ISL/TOTAL*100) %>% 
  filter(OPERATOR == "OPERATORS, PRINCIPAL") %>% 
  select("GEOID", "YEAR", "OPERATOR", "TYPE", "WHITE", "POC", "NATIVE_AMER", "BLACK", "MULTI", "HISPANIC", "ASIAN", "PACIFIC_ISL", "TOTAL") %>% 
  mutate_at(7:13, round, 3)

# build spatial
r_sf <- merge(counties, race_prop, by = "GEOID") 

### Extract quantiles; use these to estimate quantiles, below!
q <- r_sf %>% filter(YEAR == 2017, TYPE == "AREA OPERATED") %>% 
  pull(WHITE) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() 

### What are the quantiles?
q_h <- c(0,0.25,0.5,1.0,2.5,5.0,101)
q_b <- c(0,0.25,0.5,1.0,2.5,5.0,72)
q_w <- c(0,90,95,97.5,98.5,99.5,100.1)

### Create custom labels
l_h <- c("0 - 0.25%",      "0.25 - 0.5%",    "0.5 - 1.0%",    "1.0 - 2.5%",   "2.5 - 5.0%",  "> 5.0%")
l_b <- c("0 - 0.25%",      "0.25 - 0.5%",    "0.5 - 1.0%",    "1.0 - 2.5%",   "2.5 - 5.0%",  "> 5.0%")
l_w <- c("0 - 90.0%",    "90.0 - 95.0%",   "95.0 - 97.5%",   "97.5 - 98.5%", "98.5 - 99.5%",  "> 99.5%")

### Create a new variable with the quantiles
df <- r_sf %>%
  mutate(mean_quantiles = cut(HISPANIC,
                               breaks = q_h,
                               labels = l_h,
                               include.lowest = T)) %>% 
  filter(!is.na(HISPANIC)) %>% 
  filter(YEAR == 2017, TYPE == "AREA OPERATED") 

### PLOT
# Percent HISPANIC operators - 2017
hisp_acres <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "Purples") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), legend.position="bottom",
          legend.key.size = unit(2, 'mm'))

### Create a new variable with the quantiles
df <- r_sf %>%
  mutate(mean_quantiles = cut(BLACK,
                               breaks = q_b,
                               labels = l_b,
                               include.lowest = T)) %>% 
  filter(!is.na(BLACK)) %>% 
  filter(YEAR == 2017, TYPE == "AREA OPERATED") 

### PLOT
# Percent BLACK operators - 2017
black_acres <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "Oranges") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), legend.position="bottom",
          legend.key.size = unit(2, 'mm'))

### Create a new variable with the quantiles
df <- r_sf %>%
  mutate(mean_quantiles = cut(WHITE,
                               breaks = q_w,
                               labels = l_w,
                               include.lowest = T)) %>% 
  filter(!is.na(WHITE)) %>% 
  filter(YEAR == 2017, TYPE == "AREA OPERATED") 

### PLOT
# Percent WHITE operators - 2017
white_acres <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "Reds") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), legend.position="bottom",
          legend.key.size = unit(2, 'mm'))

# Build panel plots!
# (A.) Black, (B.) Hispanic, (C.) white and (D.) female operated acreage
library(ggpubr)
ggarrange(black_acres, hisp_acres, white_acres, female_acres, labels = c("A.", "B.", "C.", "D."), ncol = 2, nrow = 2, font.label = list(size = 8))
ggsave("./viz/SI-Figure7.png", dpi = 400, width = 180, height = 120, units = "mm")
```
### SI Figure 8. (A.) Percent agricultural acres operated by POC (i.e., Black, American Indian or Native Alaskan, Multi-racial, Hispanic, Asian, Native Hawaiian or other Pacific Islander) principal operators in 2017, and (B.) Percent of all US farm operations operated by POC principal operators in 2017. Data: USDA NASS QuickStats
```{r}
############################################################
# Percent acres operated by POC principal operators
############################################################

### Extract quantiles; use these to estimate quantiles, below!
q <- r_sf %>% filter(YEAR == 2017, TYPE == "AREA OPERATED") %>% 
  pull(POC) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() # to remove names of quantiles, so idx below is numeric

### What are the quantiles?
quantiles <- c(0,0.125,0.75,2.5,5,25,100)

### Create custom labels
labels <- c("0 - 0.125%",      "0.125 - 0.75%",    "0.75 - 2.5%",    "2.5 - 5.0%",   "5.0 - 25.0%",  "> 25.0%")

### Create a new variable with the quantiles
df <- r_sf %>%
  mutate(mean_quantiles = cut(POC,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(!is.na(POC)) %>% 
  filter(YEAR == 2017, TYPE == "AREA OPERATED") 

### PLOT
# Percent POC operated acres - 2017
POC_acres <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "GnBu") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), legend.position="bottom",
          legend.key.size = unit(2, 'mm'))

############################################################
# Percent operations operated by POC principle operators
############################################################

### Extract quantiles; use these to estimate quantiles, below!
q <- r_sf %>% filter(YEAR == 2017, TYPE == "OPERATIONS") %>% 
  pull(POC) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() # to remove names of quantiles, so idx below is numeric

### What are the quantiles?
quantiles <- c(0,1.25,2.5,5,10,25,100)

### Create custom labels
labels <- c("0 - 1.25%",      "1.25 - 2.5%",    "2.5 - 5.0%",    "5.0 - 10.0%",   "10.0 - 25.0%",  "> 25.0%")

### Create a new variable with the quantiles
df <- r_sf %>%
  mutate(mean_quantiles = cut(POC,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(!is.na(POC)) %>% 
  filter(YEAR == 2017, TYPE == "OPERATIONS") 

### PLOT
# Percent POC operated acres - 2017
POC_operations <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "YlGn") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), legend.position="bottom",
          legend.key.size = unit(2, 'mm'))

# Build panel plots!
# (A.) Percent POC operated acres, (B.) Percent POC-run operations
library(ggpubr)
ggarrange(POC_acres, POC_operations, labels = c("A.", "B."), ncol = 2, font.label = list(size = 8))
ggsave("./viz/SI-Figure8.png", dpi = 400, width = 200, height = 80, units = "mm")
```

### SI Figure 9: Proportion of acres operated by tenancy status. Data: USDA NASS QuickStats.
```{r}
z <- c %>%
  select(c(1:2,18:20)) %>% 
  pivot_longer(!c(1,2), names_to = "tenancy", values_to = "acres") %>% 
ggplot(.) +
  geom_bar(aes(fill = forcats::fct_rev(tenancy), y = acres, x = year), position = "fill", stat = "identity") +
  scale_fill_manual(name = "", labels = c("Tenant", "Part Owner", "Full Owner"), values=c("#44AA99","#88CCEE","#882255")) +
  labs(title = "", color = "", y = "", x = "") +
  project_theme +
  theme(legend.position="bottom") +
  scale_x_continuous(breaks = c(1997, 2002, 2007, 2012, 2017)) +
  ggsave("./viz/SI-Figure9.png", dpi = 400, width = 100, height = 80, units = "mm")
```

### SI Figure 10: Average acres per operation in 2017, measured as the total number of agricultural acres in a county divided by the total number of operations. Data: USDA NASS QuickStats.
```{r}
############################################################
# Acres per operation, mean in 2017
############################################################
size <- c_sf %>% select(c(1,10:12,,14:15)) %>% filter(year == 2017)  %>% summarise(ave_apo = round(tot_acres/n_op))

### Extract quantiles; use these to estimate quantiles, below!
# Mean
q <- size %>% filter(year == 2017) %>% 
  pull(acres_per_op) %>% # switch ave_apo & acres_per_op
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() # to remove names of quantiles, so idx below is numeric

### What are the quantiles?
quantiles <- c(0,150,300,600,1200,2500,60000) # Mean

### Create custom labels
labels <- c("0 – 150 acres",      "150 – 300 acres",    "300 – 600 acres",    "600 – 1200 acres",   "1200 – 2500 acres",  "> 2500 acres") # Mean

### Create a new variable with the quantiles
# Mean
df <- size %>%
  mutate(mean_quantiles = cut(ave_apo,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(year == 2017) %>% 
  filter(!is.na(ave_apo)) 

### PLOT
# Mean acres
mean_acres <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "YlGn") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), legend.position="bottom",
          legend.key.size = unit(2, 'mm'))
  ggsave('./viz/SI-Figure10.png', dpi = 400, width = 100, height = 80, units = "mm")

```

