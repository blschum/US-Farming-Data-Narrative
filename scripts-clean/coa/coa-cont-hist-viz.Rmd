---
title: "data-inventory"
author: "Britta Schumacher"
date: "February 8, 2021"
output: 
  html_document:
    theme: flatly
    toc: yes
    toc_float: true
    code_folding: hide
---

```{r}
library(tidyverse)
library(ggplot2)
library(sf)
library(RColorBrewer)
library(viridis)
library(ggpubr)
```


# Who are our (US) farmers? 

(see https://usafacts.org/articles/farmer-demographics/

# COA historical data, built from multiple sources (historical-coa.csv); national-level summaries for operator age, race, sex, years on present farm, & white v. nonwhite owndership/tenancy

```{r}
h <- read.csv("./data/historical-coa.csv")

# Average Operator Age
h %>% 
  ggplot(.) +
  geom_line(aes(x = year, y = ave_age), color = "#88CCEE", size = 1.5) +
  theme_bw() +
  labs(title = "", color = "", y = "", x = "") +
  coord_cartesian(xlim = c(1940,2017)) +
  geom_vline(xintercept=c(1997), linetype="dotted") +
  ggsave("./viz/ave-age.jpeg", width = 6, height = 4, dpi = 300)

# Farm operators by race through time
h %>% filter(!is.na(black)) %>% 
  ggplot(.) +
  geom_line(aes(x = year, y = white/1000000, color = "White operators (in 1Ms)"), size = 1, linetype = "longdash") +
  geom_line(aes(x = year, y = black/100000, color = "Black operators (in 100ks)"), size = 1, linetype = "longdash") +
  geom_line(aes(x = year, y = other/100000, color = "All Other Races operators (in 100ks)"), size = 1, linetype = "longdash") +
  theme_bw() +
  labs(title = "", color = "", y = "", x = "") +
  scale_color_manual(name="",values = c("White operators (in 1Ms)" = "#88CCEE", "Black operators (in 100ks)" = "#CC6677", "All Other Races operators (in 100ks)" = "#DDCC77")) +
  coord_cartesian(xlim = c(1900,2017)) +
  geom_vline(xintercept=c(1997), linetype="dotted") +
    theme(legend.position="bottom") +
  ggsave("./viz/race.jpeg", width = 6.5, height = 4, dpi = 300)


# Number of Farm operators by sex through time

h %>%
  select(year, male, female) %>% filter (!is.na(female)) %>% mutate(perc = female/male*100) %>% 
  pivot_longer(-c(year, perc), names_to = "variable", values_to = "count") %>% 
ggplot(.) +
  geom_bar(aes(fill=variable, y=count/100000, x=year), position="dodge", stat="identity") +
  geom_line(aes(x = year, y = perc, color = "% Female Primary Operators"), stat = "identity", size = 1.5) +
  theme_bw() +
  scale_fill_manual(name="",labels = c("Female", "Male"), values = c("#44AA99", "#332288")) +
  scale_color_manual(name="",values = c("% Female Primary Operators" = "#DDCC77")) +
  geom_vline(xintercept=c(1997), linetype="dotted") +
  theme(legend.position="bottom") +
  labs(title = "", y = "", x = "") +
  ggsave('./viz/gender.jpeg', width = 6, height = 4, dpi = 300)

# Experience

z <- h %>%
  select(c(1,18:20)) %>% filter(!is.na(exp_05)) %>% mutate(perc = exp_10/(exp_05+exp_09+exp_10)) %>%
  pivot_longer(!c(1,5), names_to = "exp", values_to = "count") %>%  
ggplot(.) +
  geom_bar(aes(fill = exp, y = count, x = year), position = "fill", stat = "identity") +
  scale_fill_manual(name = "", labels = c("Less than 5", "5 to 9", "Greater than 10"), values=c("#117733","#44AA99","#88CCEE")) +
  labs(title = "", color = "", y = "", x = "") +
  geom_vline(xintercept=c(1997), linetype="dotted") +
    theme_bw() +
  theme(legend.position="bottom") +
  ggsave('./viz/experience.jpeg', width = 6, height = 4, dpi = 300)

# White v. Nonwhite ownership/tenancy
t <- h %>% select(1,12:17) %>% filter(!is.na(w_tenant)) %>% 
  pivot_longer(!c(1), names_to = "tenancy", values_to = "count") %>% 
  mutate(
    race = case_when(
      tenancy %in% c("w_fullowner","w_partowner","w_tenant") ~ "White",
      tenancy %in% c("nw_fullowner","nw_partowner","nw_tenants") ~ "POC"),
    type = case_when(
      tenancy %in% c("w_fullowner","nw_fullowner") ~ "Full Owner",
      tenancy %in% c("w_partowner","nw_partowner") ~ "Part Owner",
      tenancy %in% c("w_tenant","nw_tenants") ~ "Tenants"
    ))

t$race <- as.factor(t$race)
t$type <- as.factor(t$type)
t$year <- as.factor(t$year)

t %>% filter(race == "POC")

t$alpharace <- as.factor(ifelse(t$race == "White", 0.6, 1))

ggplot(t, aes(x = race, y=count , fill=type, alpha = factor(alpharace))) +
  geom_bar(position = "fill", stat = "identity") +
      scale_fill_manual(name = "", labels = c("Full Owner", "Part Owner", "Tenant"), values=c("#44AA99","#88CCEE","#DDCC77"))  +
      theme(strip.background = element_rect(color="transparent",fill = "transparent")) +
  theme(legend.position="bottom") +
  theme_minimal() +
  scale_alpha_manual(values = c("0.6"=0.6, "1"=1), guide='none') +
  scale_x_discrete(labels = NULL, breaks = NULL) + labs(x = "") +
  facet_wrap(~year,nrow=1) +
    labs(title = "", color = "", y = "", x = "") +
 ggsave('./viz/race-tenancy.jpeg', width = 9.5, height = 5, dpi = 300) 

```

# Pull in theme for maps
```{r}
theme_map <- function(...) {
  theme_minimal() +
  theme(
    # remove all axes
    axis.line = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),

    # borders and margins
    panel.border = element_blank(),
    
    # titles
    legend.title = element_blank(),
    legend.text = element_text(size = 7, hjust = 0,
                               color = "black"),
    plot.title = element_text(size = 15, hjust = 0.5,
                              color = "black"),
    plot.subtitle = element_text(size = 10, hjust = 0.5,
                                 color = "black",
                                 margin = margin(b = -0.1,
                                                 t = -0.1,
                                                 l = 2,
                                                 unit = "cm"),
                                 debug = F),
    ...
  )
}
```

# Load contemporary data & build stacked bar charts
```{r}
# load data
c <- readRDS("./data/contemp-coa.RDS")
r <- readRDS("./data/coa-race.RDS")
FIPS <- read.csv("./data/stateFIPS.csv")
counties <- readRDS("C:/Users/bls54/OneDrive/Grad/Emory/Horst&Marion-Expansion/coa/data/coterm_cty_sf.RDS") 
states <- readRDS("C:/Users/bls54/OneDrive/Grad/Emory/Horst&Marion-Expansion/coa/data/states_sf.RDS") 
states <- states %>% filter(STATE_FIPS %in% counties$STATEFP)

# Stacked bar chart, race
# area operated
race_area <- r %>%
  filter(OPERATOR == "OPERATORS, PRINCIPAL", TYPE == "AREA OPERATED") %>% 
  select(c(1,4,7:13)) %>% 
  pivot_longer(!c(1,2), names_to = "race", values_to = "acres") %>% 
ggplot(.) +
  geom_bar(aes(fill = forcats::fct_rev(race), y = acres, x = YEAR), position = "fill", stat = "identity") +
  scale_fill_manual(name = "", labels = c("White", "Native Hawaiian or Other Pacific Islander", "American Indian or Alaskan Native", "Multiple Races", "Hispanic", "Black", "Asian"), values=c("#332288","#117733","#44AA99","#88CCEE","#DDCC77","#CC6677","#AA4499")) +
  labs(title = "", color = "", y = "Proportion of Area Operated", x = "") +
  #geom_vline(xintercept=c(1997), linetype="dotted") +
    theme_bw() +
  theme(legend.position="bottom") +
  coord_cartesian(ylim = c(0,0.085)) +
  scale_x_continuous(breaks = c(2007, 2012, 2017)) +
  ggsave('./viz/propacr-race.jpeg', width = 7, height = 4, dpi = 300)

# operations
race_operations <- r %>%
  filter(OPERATOR == "OPERATORS, PRINCIPAL", TYPE == "OPERATIONS") %>% 
  select(c(1,4,7:13)) %>% 
  pivot_longer(!c(1,2), names_to = "race", values_to = "acres") %>% 
ggplot(.) +
  geom_bar(aes(fill = forcats::fct_rev(race), y = acres, x = YEAR), position = "fill", stat = "identity") +
  scale_fill_manual(name = "", labels = c("White", "Native Hawaiian or Other Pacific Islander", "American Indian or Alaskan Native", "Multiple Races", "Hispanic", "Black", "Asian"), values=c("#332288","#117733","#44AA99","#88CCEE","#DDCC77","#CC6677","#AA4499")) +
  labs(title = "", color = "", y = "Proportion of Operations", x = "") +
  #geom_vline(xintercept=c(1997), linetype="dotted") +
    theme_bw() +
  theme(legend.position="bottom") +
  coord_cartesian(ylim = c(0,0.085)) +
  scale_x_continuous(breaks = c(2007, 2012, 2017)) +
  ggsave('./viz/propop-race.jpeg', width = 7, height = 4, dpi = 300)

# Build panel plots!
ggarrange(race_area, race_operations, labels = c("A.", "B."), ncol = 2, nrow = 1, common.legend = TRUE, legend = "bottom")
ggsave("./viz/race-bar_panelplot.png", width = 9, height = 4, dpi = 300)

# stacked bar chart, sex
# acres operated
c %>%
  select(c(1:2,10:11)) %>% 
  pivot_longer(!c(1,2), names_to = "sex", values_to = "acres") %>% 
ggplot(.) +
  geom_bar(aes(fill = forcats::fct_rev(sex), y = acres, x = year), position = "fill", stat = "identity") +
  scale_fill_manual(name = "", labels = c("Male", "Female"), values=c("#44AA99","#88CCEE")) +
  labs(title = "", color = "", y = "", x = "") +
  #geom_vline(xintercept=c(1997), linetype="dotted") +
    theme_bw() +
  theme(legend.position="bottom") +
  coord_cartesian(ylim = c(0,0.25)) +
  scale_x_continuous(breaks = c(1997, 2002, 2007, 2012, 2017)) +
  ggsave('./viz/propacr-sex.jpeg', width = 6, height = 4, dpi = 300)

# operations
c %>%
  select(c(1:2,13:14)) %>% 
  pivot_longer(!c(1,2), names_to = "sex", values_to = "op") %>% 
ggplot(.) +
  geom_bar(aes(fill = forcats::fct_rev(sex), y = op, x = year), position = "fill", stat = "identity") +
  scale_fill_manual(name = "", labels = c("Male", "Female"), values=c("#44AA99","#88CCEE")) +
  labs(title = "", color = "", y = "", x = "") +
  #geom_vline(xintercept=c(1997), linetype="dotted") +
    theme_bw() +
  theme(legend.position="bottom") +
  coord_cartesian(ylim = c(0,0.4)) +
  scale_x_continuous(breaks = c(1997, 2002, 2007, 2012, 2017)) +
  ggsave('./viz/propop-sex.jpeg', width = 6, height = 4, dpi = 300)

# tenancy
c %>%
  select(c(1:2,17:19)) %>% 
  pivot_longer(!c(1,2), names_to = "tenancy", values_to = "acres") %>% 
ggplot(.) +
  geom_bar(aes(fill = forcats::fct_rev(tenancy), y = acres, x = year), position = "fill", stat = "identity") +
  scale_fill_manual(name = "", labels = c("Tenant", "Part Owner", "Full Owner"), values=c("#44AA99","#88CCEE","#882255")) +
  labs(title = "", color = "", y = "", x = "") +
    theme_bw() +
  theme(legend.position="bottom") +
  scale_x_continuous(breaks = c(1997, 2002, 2007, 2012, 2017)) +
  ggsave('./viz/prop-tenancy.jpeg', width = 6, height = 4, dpi = 300)

```
 

# Maps in most recent year
```{r}

# Build spatial
c_sf <- merge(counties, c, by = "GEOID")
# mutate w/RowSums doesn't like r_sf, so I build this below!

############################################################
# Average Age
############################################################
age <- c_sf %>% select(c(1,10:12)) 

### Extract quantiles; use these to estimate quantiles, below!
q <- age %>% filter(year == 2017) %>% 
  pull(age) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() # to remove names of quantiles, so idx below is numeric

### What are the quantiles?
quantiles <- c(32.5,55,57.5,59,61.5,63,75)

### Create custom labels
labels <- c("32.5 – 55 years",      "55 – 57.5 years",    "57.5 – 59 years",    "59 – 61.5 years",   "61.5 – 63 years",  "> 63 years")

### Create a new variable with the quantiles
df <- age %>%
  mutate(mean_quantiles = cut(age,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(!is.na(age)) 

### PLOT
# Average age
ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "Reds") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white")) +
  ggsave('./viz/ave-age-2017.jpeg', width = 6, height = 4, dpi = 300)

############################################################
# Percent female-run operations
############################################################

female_op <- c_sf %>% select(c(1,10:11,21:23))

### Extract quantiles; use these to estimate quantiles, below!
q <- female_op %>% filter(year == 2017) %>% 
  pull(percf_op) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() # to remove names of quantiles, so idx below is numeric

### What are the quantiles?
quantiles <- c(9,22.5,27.5,30,35,40,84)

### Create custom labels
labels <- c("0 – 22.5%",      "22.5 – 27.5%",    "27.5 – 30.0%",    "30.0 – 35.0%",   "35.0 – 40.0%",  "> 40.0%")

### Create a new variable with the quantiles
df <- female_op %>%
  mutate(mean_quantiles = cut(percf_op,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(!is.na(percf_op)) %>% 
  filter(year == 2017) 

### PLOT
# Percent female operations - 2017
female_operations <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "Oranges") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white")) +
  ggsave('./viz/female-operations-2017.jpeg', width = 6, height = 4, dpi = 300)

############################################################
# Years on any operation
############################################################

exp <- c_sf %>% select(c(1,10:11,16)) 

t <- c %>% select(c(1,2,8)) %>% filter(year == 2017) %>% filter(exp >= 10)

### Extract quantiles; use these to estimate quantiles, below!
q <- exp %>% filter(year == 2017) %>% 
  pull(exp) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() # to remove names of quantiles, so idx below is numeric

### What are the quantiles?
quantiles <- c(5,15,20,22.5,25,27.5,32.6)

### Create custom labels
labels <- c("5 - 15 years",      "15 - 20 years",    "20 – 22.5 years",    "22.5 - 25 years",   "25 - 27.5 years",  "> 27.5 years")

### Create a new variable with the quantiles
df <- exp %>%
  mutate(mean_quantiles = cut(exp,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(!is.na(exp)) %>% 
  filter(year == 2017) 

### PLOT
# Percent female operations - 2017
ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "Blues") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white")) +
  ggsave('./viz/yrs-any-operation-2017.jpeg', width = 6, height = 4, dpi = 300)

############################################################
# Acres per operation, median and mean in 2017
############################################################
size <- c_sf %>% select(c(1,10:11,14:16)) %>% filter(year == 2017)  %>% summarise(ave_apo = round(tot_acres/n_op))

### Extract quantiles; use these to estimate quantiles, below!
# Mean
q <- size %>% filter(year == 2017) %>% 
  pull(acres_per_op) %>% # switch ave_apo & acres_per_op
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() # to remove names of quantiles, so idx below is numeric

### What are the quantiles?
quantiles <- c(0,150,300,600,1200,2500,60000) # Mean
quantiles_med <- c(0,50,75,100,150,300,40000) # Median

### Create custom labels
labels <- c("0 – 150 acres",      "150 – 300 acres",    "300 – 600 acres",    "600 – 1200 acres",   "1200 – 2500 acres",  "> 2500 acres") # Mean
labels_med <- c("0 – 50 acres",      "50 – 75 acres",    "75 – 100 acres",    "100 – 150 acres",   "150 – 300 acres",  "> 300 acres") # Median

### Create a new variable with the quantiles
# Mean
df <- size %>%
  mutate(mean_quantiles = cut(ave_apo,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(year == 2017) %>% 
  filter(!is.na(ave_apo)) 

### PLOT
# Mean acres
mean_acres <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "YlGn") +
  theme_map() +
    theme(panel.grid.major = element_line(colour = "white")) +
  ggsave('./viz/mean-acres-2017.jpeg', width = 6, height = 4, dpi = 300)

### Create a new variable with the quantiles
# Median
df_op <- size %>%
  mutate(median_quantiles = cut(acres_per_op,
                               breaks = quantiles_med,
                               labels = labels_med,
                               include.lowest = T)) %>% 
  filter(year == 2017) %>% 
  filter(!is.na(acres_per_op)) 

### PLOT
# Median acres
median_acres <- ggplot(data = df_op) +
  geom_sf(mapping = aes(fill = median_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "BuPu") +
  theme_map() +
    theme(panel.grid.major = element_line(colour = "white")) +
  ggsave('./viz/median-acres-2017.jpeg', width = 6, height = 4, dpi = 300)

############################################################
# Tenancy as % county acres rented in 2017
############################################################
tenancy <- c_sf %>% select(c(1:2,10:12,26:28)) %>% 
  mutate(perc_rent = tenant/(tenant+part_owner+full_owner)*100) %>% 
  filter(year == 2017)

### Extract quantiles; use these to estimate quantiles, below!
q <- tenancy %>% filter(year == 2017) %>% 
  pull(perc_rent) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() # to remove names of quantiles, so idx below is numeric

### What are the quantiles?
quantiles <- c(0,2,3.5,5.5,7.5,15,70)

### Create custom labels
labels <- c("0 - 2.0%",      "2.0 - 3.5%",    "3.5 – 5.5%",    "5.5 - 7.5%",   "7.5 - 15.0%",  "> 15.0%")

### Create a new variable with the quantiles
df <- tenancy %>%
  mutate(mean_quantiles = cut(perc_rent,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(!is.na(perc_rent)) %>% 
  filter(year == 2017) 

### PLOT
# Percent tenants - 2017
tenants <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "PuBuGn") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white")) +
  ggsave('./viz/perc-tenants-2017.jpeg', width = 6, height = 4, dpi = 300)


# Build panel plots!
# (A.) Median acres per operation, (B.) % tenants
library(ggpubr)
ggarrange(median_acres, tenants, labels = c("A.", "B."), ncol = 2, nrow = 1)
ggsave("./viz/medianacres-tenants-panelplot.png", height = 2.2, width = 7.29)
```

### Number of laborers, cost of labor and cost of labor/acre
```{r}
labor <- c_sf %>% select(c(1,10,15,18,25)) %>%
  mutate(lpa = labor_n/tot_acres,
         cpa = labor_expense/tot_acres,
         cpl = labor_expense/labor_n) %>% 
  filter(year == 2017)

t<- c_sf %>% filter(complete.cases(labor_expense,tot_acres)) %>%  filter(year == 2017) %>% group_by(year) %>% summarise(epa = sum(labor_expense)/sum(tot_acres))
t <- labor %>% filter(!is.na(cpa)) %>% summarise(median = median(cpa))
  
### Extract quantiles; use these to estimate quantiles, below!
q <- labor %>% filter(year == 2017) %>% 
  pull(lpa) %>% # switch out labor_n, labor_expense, cpa, lpa
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() # to remove names of quantiles, so idx below is numeric

### What are the quantiles?
quantiles <- c(0,500,750,1500,2500,5000,72000)
quantiles_e <- c(2000, 1500000, 3000000,6000000,7500000,30000000,1240294000)
quantiles_cpa <- c(0,7.5,15,30,45,90,110000)
quantiles_lpa <- c(0,0.0025,0.005,0.01,0.025,0.05,9.5)

### Create custom labels
labels <- c("0 - 500",      "500 - 750",    "750 – 1500",    "1500 - 2500",   "2500 - 5000",  "> 5000")
labels_e <- c("$2k - $1.5M",    "$1.5M – $3M",    "$3M - $6M",  "$6M - $7.5M", "$7.5M - $30M",  "> $30M")
labels_cpa <- c("$0 - $7.50/acre",      "$7.50 - $15/acre",    "$15 – $30/acre",    "$30 - $45/acre",   "$45 - $90/acre",  "> $90/acre")
labels_lpa <- c("0 - 0.0025",      "0.0025 - 0.005",    "0.005 – 0.01",    "0.01 - 0.025",   "0.025 - 0.05",  "> 0.05")

### Create a new variable with the quantiles
df <- labor %>%
  mutate(mean_quantiles = cut(labor_n,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(!is.na(labor_n)) %>% 
  filter(year == 2017) 

### PLOT
# number of laborers - 2017
ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "Oranges") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white")) +
  ggsave('./viz/labor-2017.jpeg', width = 6, height = 4, dpi = 300)

### Create a new variable with the quantiles
df <- labor %>%
  mutate(mean_quantiles = cut(labor_expense,
                               breaks = quantiles_e,
                               labels = labels_e,
                               include.lowest = T)) %>% 
  filter(!is.na(labor_expense)) %>% 
  filter(year == 2017) 

### PLOT
# Labor expense - 2017
ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "Reds") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white")) +
  ggsave('./viz/laborexpense-2017.jpeg', width = 6, height = 4, dpi = 300)

### Create a new variable with the quantiles
df <- labor %>%
  mutate(mean_quantiles = cut(cpa,
                               breaks = quantiles_cpa,
                               labels = labels_cpa,
                               include.lowest = T)) %>% 
  filter(!is.na(cpa)) %>% 
  filter(year == 2017) 

### PLOT
# Labor cost per acre - 2017
laborexpenseperacre <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "YlOrRd") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white")) +
  ggsave('./viz/labor-cpa-2017.jpeg', width = 6, height = 4, dpi = 300)

### Create a new variable with the quantiles
df <- labor %>%
  mutate(mean_quantiles = cut(lpa,
                               breaks = quantiles_lpa,
                               labels = labels_lpa,
                               include.lowest = T)) %>% 
  filter(!is.na(lpa)) %>% 
  filter(year == 2017) 

### PLOT
# Laborers per acre - 2017
laborperacre <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "RdPu") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white")) +
  ggsave('./viz/labor-lpa-2017.jpeg', width = 6, height = 4, dpi = 300)

# Build panel plots!
# (A.) Labor expense per acre, (B.) Number of laborers per acre
library(ggpubr)
ggarrange(laborexpenseperacre, laborperacre, labels = c("A.", "B."), ncol = 2, nrow = 1)
ggsave("./viz/labor-panelplot.png", height = 2.2, dpi = 300)

# number of laborers in US in 2017
l <- c %>% filter(year == 2017) %>% drop_na(labor_n) %>% summarise(sum(labor_n))
```

### Percent acres operated and percent total operations by POC principal operators
```{r}
############################################################
# Percent acres operated by POC principal operators
############################################################

### Extract quantiles; use these to estimate quantiles, below!
q <- r_sf %>% filter(YEAR == 2017, TYPE == "AREA OPERATED") %>% 
  pull(POC) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() # to remove names of quantiles, so idx below is numeric

### What are the quantiles?
quantiles <- c(0,0.125,0.75,2.5,5,25,100)

### Create custom labels
labels <- c("0 - 0.125%",      "0.125 - 0.75%",    "0.75 - 2.5%",    "2.5 - 5.0%",   "5.0 - 25.0%",  "> 25.0%")

### Create a new variable with the quantiles
df <- r_sf %>%
  mutate(mean_quantiles = cut(POC,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(!is.na(POC)) %>% 
  filter(YEAR == 2017, TYPE == "AREA OPERATED") 

### PLOT
# Percent POC operated acres - 2017
POC_acres <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "GnBu") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white")) +
  ggsave('./viz/perc-POC-op-acres-2017.jpeg', width = 6, height = 4, dpi = 300)

############################################################
# Percent operations operated by POC principle operators
############################################################

### Extract quantiles; use these to estimate quantiles, below!
q <- r_sf %>% filter(YEAR == 2017, TYPE == "OPERATIONS") %>% 
  pull(POC) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() # to remove names of quantiles, so idx below is numeric

### What are the quantiles?
quantiles <- c(0,1.25,2.5,5,10,25,100)

### Create custom labels
labels <- c("0 - 1.25%",      "1.25 - 2.5%",    "2.5 - 5.0%",    "5.0 - 10.0%",   "10.0 - 25.0%",  "> 25.0%")

### Create a new variable with the quantiles
df <- r_sf %>%
  mutate(mean_quantiles = cut(POC,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(!is.na(POC)) %>% 
  filter(YEAR == 2017, TYPE == "OPERATIONS") 

### PLOT
# Percent POC operated acres - 2017
POC_operations <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "YlGn") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white")) +
  ggsave('./viz/perc-POC-operations-2017.jpeg', width = 6, height = 4, dpi = 300)

# Build panel plots!
# (A.) Percent POC operated acres, (B.) Percent POC-run operations
library(ggpubr)
ggarrange(POC_acres, POC_operations, labels = c("A.", "B."), ncol = 2, nrow = 1)
ggsave("./viz/perc-POC-panelplot.png", height = 2.2, dpi = 300)
```


### Percent (A.) Black, (B.) Hispanic, (C.) white and (D.) female operated acres in 2017
```{r}
############################################################
# Percent acres operated by principal operators identifying as females
############################################################
female_acres <- c_sf %>% select(c(1,10:11,21)) 

### Extract quantiles; use these to estimate quantiles, below!
q <- female_acres %>% filter(year == 2017) %>% 
  pull(percf_acr) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() # to remove names of quantiles, so idx below is numeric

### What are the quantiles?
quantiles <- c(0,15,20,22.5,25,30,77)

### Create custom labels
labels <- c("0 – 15%",      "15 – 20%",    "20 – 22.5%",    "22.5 – 25.0%",   "25.0 – 30.0%",  "> 30.0%")

### Create a new variable with the quantiles
df <- female_acres %>%
  mutate(mean_quantiles = cut(percf_acr,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(!is.na(percf_acr)) %>% 
  filter(year == 2017)

### PLOT
# Percent acres operated by women - 2017
female_acres <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "Greens") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white")) +
  ggsave('./viz/female-acres-2017.jpeg', width = 6, height = 4, dpi = 300)

############################################################
# Percent acres operated by folx identifying as black, hispanic, and white principal operators
############################################################

# proporation of each race
race_prop <- r %>% mutate(TOTAL = rowSums(.[7:13])) %>% 
  mutate(POC = (NATIVE_AMER + BLACK + MULTI + HISPANIC + ASIAN + PACIFIC_ISL)/TOTAL*100,
         NATIVE_AMER = NATIVE_AMER/TOTAL*100,
         BLACK = BLACK/TOTAL*100,
         MULTI = MULTI/TOTAL*100,
         WHITE = WHITE/TOTAL*100,
         HISPANIC = HISPANIC/TOTAL*100,
         ASIAN = ASIAN/TOTAL*100,
         PACIFIC_ISL = PACIFIC_ISL/TOTAL*100) %>% 
  filter(OPERATOR == "OPERATORS, PRINCIPAL") %>% 
  select("GEOID", "YEAR", "OPERATOR", "TYPE", "WHITE", "POC", "NATIVE_AMER", "BLACK", "MULTI", "HISPANIC", "ASIAN", "PACIFIC_ISL", "TOTAL") %>% 
  mutate_at(7:13, round, 3)

# build spatial
r_sf <- merge(counties, race_prop, by = "GEOID") 

### Extract quantiles; use these to estimate quantiles, below!
q <- r_sf %>% filter(YEAR == 2017, TYPE == "AREA OPERATED") %>% 
  pull(WHITE) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() 

### What are the quantiles?
q_h <- c(0,0.25,0.5,1.0,2.5,5.0,101)
q_b <- c(0,0.25,0.5,1.0,2.5,5.0,72)
q_w <- c(0,90,95,97.5,98.5,99.5,100.1)

### Create custom labels
l_h <- c("0 - 0.25%",      "0.25 - 0.5%",    "0.5 - 1.0%",    "1.0 - 2.5%",   "2.5 - 5.0%",  "> 5.0%")
l_b <- c("0 - 0.25%",      "0.25 - 0.5%",    "0.5 - 1.0%",    "1.0 - 2.5%",   "2.5 - 5.0%",  "> 5.0%")
l_w <- c("0 - 90.0%",    "90.0 - 95.0%",   "95.0 - 97.5%",   "97.5 - 98.5%", "98.5 - 99.5%",  "> 99.5%")

### Create a new variable with the quantiles
df <- r_sf %>%
  mutate(mean_quantiles = cut(HISPANIC,
                               breaks = q_h,
                               labels = l_h,
                               include.lowest = T)) %>% 
  filter(!is.na(HISPANIC)) %>% 
  filter(YEAR == 2017, TYPE == "AREA OPERATED") 

### PLOT
# Percent HISPANIC operators - 2017
hisp_acres <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "Purples") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white")) +
  ggsave('./viz/perc-HIS-acres-2017.jpeg', width = 6, height = 4, dpi = 300)

### Create a new variable with the quantiles
df <- r_sf %>%
  mutate(mean_quantiles = cut(BLACK,
                               breaks = q_b,
                               labels = l_b,
                               include.lowest = T)) %>% 
  filter(!is.na(BLACK)) %>% 
  filter(YEAR == 2017, TYPE == "AREA OPERATED") 

### PLOT
# Percent BLACK operators - 2017
black_acres <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "Oranges") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white")) +
  ggsave('./viz/perc-BLACK-acres-2017.jpeg', width = 6, height = 4, dpi = 300)

### Create a new variable with the quantiles
df <- r_sf %>%
  mutate(mean_quantiles = cut(WHITE,
                               breaks = q_w,
                               labels = l_w,
                               include.lowest = T)) %>% 
  filter(!is.na(WHITE)) %>% 
  filter(YEAR == 2017, TYPE == "AREA OPERATED") 

### PLOT
# Percent WHITE operators - 2017
white_acres <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "Reds") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white")) +
  ggsave('./viz/perc-WHITE-acres-2017.jpeg', width = 6, height = 4, dpi = 300)

# Build panel plots!
# (A.) Black, (B.) Hispanic, (C.) white and (D.) female operated acreage
library(ggpubr)
ggarrange(black_acres, hisp_acres, white_acres, female_acres, labels = c("A.", "B.", "C.", "D."), ncol = 2, nrow = 2)
ggsave("./viz/perc-acres-panelplot.png")
```


### Percent (A.) Black, (B.) Hispanic, (C.) white and (D.) female operators
```{r}
############################################################
# Percent operators identifying as female
############################################################

fem_operators <- c_sf %>% select(c(1,10:11,31)) %>% filter(!is.na(percf_operators))

### Extract quantiles; use these to estimate quantiles, below!
q <- fem_operators %>% 
  pull(percf_operators) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() # to remove names of quantiles, so idx below is numeric

### What are the quantiles?
quantiles <- c(6,22.5,27.5,30,35,40,86)

### Create custom labels
labels <- c("0 – 22.5%",      "22.5 – 27.5%",    "27.5 – 30.0%",    "30.0 – 35.0%",   "35.0 – 40.0%",  "> 40.0%")

### Create a new variable with the quantiles
df <- fem_operators %>%
  mutate(mean_quantiles = cut(percf_operators,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(!is.na(percf_operators)) 

### PLOT
# Percent female operators - 2017
female_operators <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "Greens") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white")) +
  ggsave('./viz/female-operators-2017.jpeg', width = 6, height = 4, dpi = 300)


############################################################
# Percent black, hispanic and white operators
############################################################

### Extract quantiles; use these to estimate quantiles, below!
q <- r_sf %>% filter(YEAR == 2017, TYPE == "OPERATORS") %>% 
  pull(WHITE) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() 

### What are the quantiles?
q_h <- c(0,0.25,0.5,1.0,2.5,5.0,56)
q_b <- c(0,0.25,0.5,1.0,2.5,5.0,56)
q_w <- c(0,85,90,95,97.5,98.5,100.1)

### Create custom labels
l_h <- c("0 - 0.25%",      "0.25 - 0.5%",    "0.5 - 1.0%",    "1.0 - 2.5%",   "2.5 - 5.0%",  "> 5.0%")
l_b <- c("0 - 0.25%",      "0.25 - 0.5%",    "0.5 - 1.0%",    "1.0 - 2.5%",   "2.5 - 5.0%",  "> 5.0%")
l_w <- c("0 - 85.0%",    "85.0 - 90.0%",    "90.0 - 95.0%",   "95.0 - 97.5%",   "97.5 - 98.5%",  "> 98.5%")

### Create a new variable with the quantiles
df <- r_sf %>%
  mutate(mean_quantiles = cut(HISPANIC,
                               breaks = q_h,
                               labels = l_h,
                               include.lowest = T)) %>% 
  filter(!is.na(HISPANIC)) %>% 
  filter(YEAR == 2017, TYPE == "OPERATORS") 

### PLOT
# Percent HISPANIC operators - 2017
hisp_operators <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "Purples") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white")) +
  ggsave('./viz/perc-HIS-op-2017.jpeg', width = 6, height = 4, dpi = 300)

### Create a new variable with the quantiles
df <- r_sf %>%
  mutate(mean_quantiles = cut(BLACK,
                               breaks = q_b,
                               labels = l_b,
                               include.lowest = T)) %>% 
  filter(!is.na(BLACK)) %>% 
  filter(YEAR == 2017, TYPE == "OPERATORS") 

### PLOT
# Percent BLACK operators - 2017
black_operators <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "Oranges") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white")) +
  ggsave('./viz/perc-BLACK-op-2017.jpeg', width = 6, height = 4, dpi = 300)

### Create a new variable with the quantiles
df <- r_sf %>%
  mutate(mean_quantiles = cut(WHITE,
                               breaks = q_w,
                               labels = l_w,
                               include.lowest = T)) %>% 
  filter(!is.na(WHITE)) %>% 
  filter(YEAR == 2017, TYPE == "OPERATORS") 

### PLOT
# Percent WHITE operators - 2017
white_operators <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "Reds") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white")) +
  ggsave('./viz/perc-WHITE-op-2017.jpeg', width = 6, height = 4, dpi = 300)

# Build panel plots!
# (A.) Black, (B.) Hispanic, (C.) white and (D.) female operators
ggarrange(black_operators, hisp_operators, white_operators, female_operators, labels = c("A.", "B.", "C.", "D."), ncol = 2, nrow = 2)
ggsave("./viz/perc-operators-panelplot.png")
```



# Difference (2017-1997) maps
```{r}
# c_sf is not playing well with creating difference columns.... so.... we'll build the data first, then merge to sf!

############################################################
# Change in average Age between 1997 & 2017
############################################################
age_diff <- c %>% select(c(1:4)) %>%   
  filter(year %in% c(1997,2017)) %>% 
  group_by(GEOID, county) %>%
  #pivot_wider(names_from = year, values_from = age) %>% 
  summarise(age = diff(age))

t <- age_diff %>% filter(age <= 0)

age_diff <- merge(counties, age_diff, by = "GEOID")

### Extract quantiles; use these to estimate quantiles, below!
q<- age_diff %>%
  pull(age) %>%
  quantile(probs = seq(0, 1, length.out = 8), na.rm = T) %>%
  as.vector() # to remove names of quantiles, so idx below is numeric

quantiles <- c(-15,0,2.5,3.5,4.5,5.5,7.5,25)

labels <- c("< 0 years",      "0 - 2.5 years",    "2.5 - 3.5 years",    "3.5 - 4.5 years",   "4.5 - 5.5 years",  "5.5 - 7.5 years", "> 7.5 years")

age_diff <- age_diff %>%
  mutate(quantiles = cut(age,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(!is.na(age)) 

ggplot() +
  geom_sf(data = age_diff, aes(fill = quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  theme_map() +
  scale_fill_manual(values = c("#B2182B","#F7F7F7", "#D1E5F0", "#92C5DE", "#4393C3", "#2166AC", "#053061")) +
  #scale_fill_brewer(type = "div",palette = "RdBu",name="") +
  theme(legend.position = "right") +
  theme(panel.grid.major = element_line(colour = "white")) + 
  ggsave('./viz/diff_age.jpeg', width = 6, height = 4, dpi = 300)

############################################################
# Raw percent change in % acres operated by females
############################################################
fa_diff <- c %>% select(c(1:3, 10:12)) %>%   
  filter(year %in% c(1997,2017)) %>% 
  group_by(GEOID, county) %>% 
  summarise(percf_acr = diff(percf_acr))

fa_diff <- merge(counties, fa_diff, by = "GEOID")

### Extract quantiles; use these to estimate quantiles, below!
q<- fa_diff %>%
  pull(percf_acr) %>%
  quantile(probs = seq(0, 1, length.out = 8), na.rm = T) %>%
  as.vector() # to remove names of quantiles, so idx below is numeric

quantiles <- c(-21.06,0,10,12.5,15,17.5,22.5,57.06)

labels <- c("< 0%",      "0 - 10.0%",    "10 - 12.5%",    "12.5 - 15.0%",   "15.0 - 17.5%",  "17.5 - 22.5%", "> 22.5%")

fa_diff <- fa_diff %>%
  mutate(quantiles = cut(percf_acr,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(!is.na(percf_acr)) 

ggplot() +
  geom_sf(data = fa_diff, aes(fill = quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  theme_map() +
  scale_fill_manual(values = c("#B2182B","#F7F7F7", "#D1E5F0", "#92C5DE", "#4393C3", "#2166AC", "#053061")) +
  #scale_fill_brewer(type = "div",palette = "RdBu",name="") +
  theme(legend.position = "right") +
  theme(panel.grid.major = element_line(colour = "white")) + 
  ggsave('./viz/diff_percf_acr.jpeg', width = 6, height = 4, dpi = 300)

############################################################
# Percent change in acres operated by females
############################################################
fap_diff <- c %>% select(c(1:3, 10)) %>%   
  filter(year %in% c(1997,2017)) %>% 
  pivot_wider(names_from = year, values_from = fem_acr) %>% 
  `colnames<-`(c("GEOID", "county", "a97", "a17")) %>% 
  mutate(diff = a17 - a97,
         percf_acr = diff/a97*100)

fap_diff <- merge(counties, fa_diff, by = "GEOID")

# EB, do we want this, in some cases like 42k% increase

############################################################
# Raw change in percent operations operated by females
############################################################
fo_diff <- c %>% select(c(1:3, 13:15)) %>%   
  filter(year %in% c(1997,2017)) %>% 
  group_by(GEOID, county) %>% 
  summarise(percf_op = diff(percf_op))

fo_diff <- merge(counties, fo_diff, by = "GEOID")

### Extract quantiles; use these to estimate quantiles, below!
q <- fo_diff %>% 
  pull(percf_op) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() # to remove names of quantiles, so idx below is numeric

quantiles <- c(-38,0,10,15,20,22.5, 25,50.01)

labels <- c("< 0%",      "0 - 10.0%",    "10 - 15.0%",    "15.0 - 20.0%",   "20.0 - 22.5%",  "22.5 - 25.0%", "> 25.0%")

fo_diff <- fo_diff %>%
  mutate(quantiles = cut(percf_op,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(!is.na(percf_op)) 

ggplot() +
  geom_sf(data = fo_diff, aes(fill = quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  theme_map() +
  scale_fill_manual(values = c("#B2182B","#F7F7F7", "#D1E5F0", "#92C5DE", "#4393C3", "#2166AC", "#053061")) +
  #scale_fill_brewer(type = "div",palette = "RdBu",name="") +
  theme(legend.position = "right") +
  theme(panel.grid.major = element_line(colour = "white")) + 
  ggsave('./viz/diff_percf_op.jpeg', width = 6, height = 4, dpi = 300)

############################################################
# Years on any operation
############################################################

exp_diff <- c %>% select(c(1:3,8)) %>%   
  filter(year %in% c(2002,2017)) %>% 
  group_by(GEOID, county) %>% 
  summarise(exp = diff(exp))

exp_diff <- merge(counties, exp_diff, by = "GEOID")

### Extract quantiles; use these to estimate quantiles, below!
q <- exp_diff %>% 
  pull(exp) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() # to remove names of quantiles, so idx below is numeric

### What are the quantiles?
quantiles <- c(-16,-1,0,1,2.5,5,13)

### Create custom labels
labels <- c("< -1 year",      "-1 - 0 years",    "0 - 1 years",    "1 - 2.5 years",   "2.5 - 5 years",  "> 5 years")

### Create a new variable with the quantiles
df <- exp_diff %>%
  mutate(mean_quantiles = cut(exp,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(!is.na(exp)) 

### PLOT
# years on any operation
ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_manual(values = c("#B2182B","#F4A582", "#D1E5F0", "#92C5DE", "#4393C3", "#2166AC", "#053061")) +
  #scale_fill_brewer(type = "div",palette = "RdBu",name="") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white")) +
  ggsave('./viz/yrs-any-operation-diff.jpeg', width = 6, height = 4, dpi = 300)

############################################################
# Raw change in percent acres operated by POC principal operators
############################################################
poca_diff <- race_prop %>% select(c(1:3, 13:15)) %>%   
  filter(year %in% c(1997,2017)) %>% 
  group_by(GEOID, county) %>% 
  summarise(percf_op = diff(percf_op))

fo_diff <- merge(counties, fo_diff, by = "GEOID")


############################################################
# Acres per operation, median and mean difference between 1997 & 2017
############################################################
area_op_diff <- c_sf %>% 
  filter(year %in% c(1997,2017)) %>% 
  select(1,10:16) %>% 
  group_by(GEOID, county) %>% 
  summarise(n_op = diff(n_op),
            tot_acres = diff(tot_acres),
            ave = diff(ave))

### Extract quantiles; use these to estimate quantiles, below!
q<- area_op_diff %>%
  pull(ave) %>%
  quantile(probs = seq(0, 1, length.out = 9), na.rm = T) %>%
  as.vector() # to remove names of quantiles, so idx below is numeric

quantiles_nop <- c(-2500,-250,-100,-50,0,50,100,250,5250)
quantiles_totac <- c(-900000,-100000,-25000,-10000,0,10000,25000,100000,1500000)
quantiles_ave <- c(-35000,-500,-50,-25,0,25,50,500,11000)
### Create custom labels
# n_op
labels_nop <- c("< -250 acres",      "-250 – -100 acres",    "-100 – -50 acres",    "-50 – 0 acres",   "0 – 50 acres",  "50 - 100 acres", "100 - 250 acres", "> 250 acres")
labels_totac <- c("< -100000 acres",      "-100000 – -25500 acres",    "-25000 – -10000 acres",    "-10000 – 0 acres",   "0 – 10000 acres",  "10000 - 25000 acres", "25000 - 100000 acres", "> 100000 acres")
labels_ave <- c("< -500 acres",      "-500 – -50 acres",    "-50 – -25 acres",    "-25 – 0 acres",   "0 – 25 acres",  "25 - 50 acres", "50 - 500 acres", "> 500 acres")

### Create a new variable with the quantiles
# Number of operations (n_op)
area_op_diff <- area_op_diff %>%
  mutate(nop_quantiles = cut(n_op,
                               breaks = quantiles_nop,
                               labels = labels_nop,
                               include.lowest = T)) %>% 
  filter(!is.na(n_op)) 

ggplot() +
  geom_sf(data = area_op_diff, aes(fill = nop_quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  theme_map() +
  scale_fill_brewer(type = "div",palette = "RdBu",name="") +
  theme(legend.position = "right") +
  theme(panel.grid.major = element_line(colour = "white")) + 
  ggsave('./viz/diff_nop.jpeg', width = 6, height = 4, dpi = 300)

# Total agricultural acres
area_op_diff <- area_op_diff %>%
  mutate(totac_quantiles = cut(tot_acres,
                               breaks = quantiles_totac,
                               labels = labels_totac,
                               include.lowest = T)) %>% 
  filter(!is.na(tot_acres)) 

ggplot() +
  geom_sf(data = area_op_diff, aes(fill = totac_quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  theme_map() +
  scale_fill_brewer(type = "div",palette = "RdBu",name="") +
  theme(legend.position = "right") +
  theme(panel.grid.major = element_line(colour = "white")) + 
  ggsave('./viz/diff_totacres.jpeg', width = 6, height = 4, dpi = 300)

# Average acres / operation
area_op_diff <- area_op_diff %>%
  mutate(ave_quantiles = cut(ave,
                               breaks = quantiles_ave,
                               labels = labels_ave,
                               include.lowest = T)) %>% 
  filter(!is.na(ave)) 

ggplot() +
  geom_sf(data = area_op_diff, aes(fill = ave_quantiles), color = "transparent") +
   geom_sf(data = states, fill = "transparent", color = "dark gray") +
  theme_map() +
  scale_fill_brewer(type = "div",palette = "RdBu",name="") +
  theme(legend.position = "right") +
  theme(panel.grid.major = element_line(colour = "white")) + 
  ggsave('./viz/diff_ave.jpeg', width = 6, height = 4, dpi = 300)
```

SEX: So there's some cool stuff here.... female primary operators and operators in general have a HUGE bump in 2017 compared to the previous 3 COA years and almost ALL counties experience an increase in % female operatorship on agricultural lands between 2002 and 2017. Booya, ladies! Get it! Plus the data availability is REAL good.

RACE: Interesting stuff here, too. As Horst & Marion point out, and as we know, the COA is inconsistent--in this case, for disclosure reasons (I'm guessing). So in some counties, we see that there are 2 Hispanic operators, but do not see their acreage recorded and visa versa. So we would have to lead with this caveat. There is very little missing data for 'OPERATIONS' or 'OPERATORS', but much more missing for 'ACRES OPERATED'. The racial composition of counties is changing variably across space and time, with some places like the southwest becoming more Native operated (so cool!). Lots of other trends to be aware of here, too!

# FRR viz
```{r}
frr <- readRDS("./data/FRR.RDS") 

frr <- st_as_sf(frr)

ggplot() +
  geom_sf(data = frr, aes(fill = FRR_NAME), color = "transparent") +
   geom_sf(data = states, fill = "transparent", color = "dark gray") +
  theme_map() +
  scale_fill_manual(values = c("#332288", "#117733", "#44AA99", "#88CCEE", "#DDCC77", "#CC6677", "#AA4499", "#882255", "#1D1C1C")) +
  theme(legend.position = "right") +
  theme(panel.grid.major = element_line(colour = "white")) + 
  ggsave('./viz/FRRs.jpeg', width = 6, height = 4, dpi = 300)

```

Stats for manuscript
```{r}
# Raw race by county
s <- r %>% group_by(YEAR, STATE, TYPE) %>% 
  summarise(NATIVE_AMER = sum(NATIVE_AMER),
         BLACK = sum(BLACK),
         MULTI = sum(MULTI),
         WHITE = sum(WHITE),
         HISPANIC = sum(HISPANIC),
         ASIAN = sum(ASIAN),
         PACIFIC_ISL = sum(PACIFIC_ISL)) 
  #filter(TYPE == "OPERATORS")

# Percent race by state
p <- r %>% mutate(TOTAL = rowSums(.[7:13])) %>% 
  group_by(YEAR, STATE, TYPE) %>% 
  filter(YEAR == 2017) %>% 
  summarise(TOTAL = sum(TOTAL),
         NATIVE_AMER = sum(NATIVE_AMER)/TOTAL*100,
         BLACK = sum(BLACK)/TOTAL*100,
         MULTI = sum(MULTI)/TOTAL*100,
         WHITE = sum(WHITE)/TOTAL*100,
         HISPANIC = sum(HISPANIC)/TOTAL*100,
         ASIAN = sum(ASIAN)/TOTAL*100,
         PACIFIC_ISL = sum(PACIFIC_ISL)/TOTAL*100) %>% 
    filter(TYPE == "AREA OPERATED") 

# Percent by POC, nationally
l <- r %>% mutate(TOTAL = rowSums(.[7:13])) %>% 
  filter(YEAR == 2017) %>% 
  group_by(TYPE) %>% 
  summarise(TOTAL = sum(TOTAL),
         NATIVE_AMER = sum(NATIVE_AMER)/TOTAL*100,
         BLACK = sum(BLACK)/TOTAL*100,
         MULTI = sum(MULTI)/TOTAL*100,
         WHITE = sum(WHITE)/TOTAL*100,
         HISPANIC = sum(HISPANIC)/TOTAL*100,
         ASIAN = sum(ASIAN)/TOTAL*100,
         PACIFIC_ISL = sum(PACIFIC_ISL)/TOTAL*100,
         POC = NATIVE_AMER + BLACK + MULTI + HISPANIC + ASIAN + PACIFIC_ISL) 
    filter(TYPE == "AREA OPERATED") 

# percent race by state
p <- r %>% mutate(TOTAL = rowSums(.[7:13])) %>% 
  group_by(YEAR, STATE, TYPE) %>% 
  filter(YEAR == 2017) %>% 
  summarise(TOTAL = sum(TOTAL),
         NATIVE_AMER = sum(NATIVE_AMER)/TOTAL*100,
         BLACK = sum(BLACK)/TOTAL*100,
         MULTI = sum(MULTI)/TOTAL*100,
         WHITE = sum(WHITE)/TOTAL*100,
         HISPANIC = sum(HISPANIC)/TOTAL*100,
         ASIAN = sum(ASIAN)/TOTAL*100,
         PACIFIC_ISL = sum(PACIFIC_ISL)/TOTAL*100) %>% 
    filter(TYPE == "OPERATORS") 

# percent nonblack and nonwhite in 2017
p <- r %>% mutate(TOTAL = rowSums(.[7:13])) %>% 
  group_by(YEAR, STATE, TYPE) %>% 
  filter(YEAR == 2017) %>% 
  summarise(TOTAL = sum(TOTAL),
         NATIVE_AMER = sum(NATIVE_AMER)/TOTAL*100,
         BLACK = sum(BLACK)/TOTAL*100,
         MULTI = sum(MULTI)/TOTAL*100,
         WHITE = sum(WHITE)/TOTAL*100,
         HISPANIC = sum(HISPANIC)/TOTAL*100,
         ASIAN = sum(ASIAN)/TOTAL*100,
         PACIFIC_ISL = sum(PACIFIC_ISL)/TOTAL*100,
         POC = NATIVE_AMER + BLACK + MULTI + HISPANIC + ASIAN + PACIFIC_ISL) %>%
  mutate_if(is.numeric,round,3)

write.csv(p, "./out/perc_race.csv")

# percent nonblack and nonwhite in 2017
p <- r %>% mutate(TOTAL = rowSums(.[7:13])) %>% 
  group_by(YEAR, STATE, TYPE) %>% 
  filter(YEAR == 2017) %>% 
  summarise(TOTAL = sum(TOTAL),
         NATIVE_AMER = sum(NATIVE_AMER)/TOTAL*100,
         BLACK = sum(BLACK)/TOTAL*100,
         MULTI = sum(MULTI)/TOTAL*100,
         WHITE = sum(WHITE)/TOTAL*100,
         HISPANIC = sum(HISPANIC)/TOTAL*100,
         ASIAN = sum(ASIAN)/TOTAL*100,
         PACIFIC_ISL = sum(PACIFIC_ISL)/TOTAL*100,
         POC = NATIVE_AMER + BLACK + MULTI + HISPANIC + ASIAN + PACIFIC_ISL) %>%
  mutate_if(is.numeric,round,3)

write.csv(p, "./out/perc_race.csv")

# percent female in 2017
f <- c %>% select(c(1:4,13,16)) %>% 
  filter(year == 2017) %>% 
  mutate(diff = percf_acr - percf_op)

write.csv(f, "./out/perc_fem.csv")

# average farm size
fs <-c %>% filter(year == 2017) %>% select(c(6:8)) %>% mutate(ave = tot_acres/n_op) %>% drop_na()  %>%  summarise(median = mean(acres_per_op),
                                                                                                  mean = mean(ave))

```

# map of difference in percent land operated by and percent operators
```{r}

# BLACK
bl <- r %>% mutate(TOTAL = rowSums(.[7:13])) %>% 
  group_by(YEAR, GEOID, TYPE) %>% 
  filter(YEAR == 2017) %>% 
  summarise(TOTAL = sum(TOTAL),
         BLACK = sum(BLACK)/TOTAL*100) %>% 
  filter(TYPE == "AREA OPERATED" | TYPE == "OPERATORS") %>% 
  select(!TOTAL) %>% 
  pivot_wider(names_from = TYPE, values_from = BLACK) %>% 
  `colnames<-`(c("YEAR", "GEOID", "AREA", "OPERATORS")) %>% 
  mutate(diff = AREA - OPERATORS)

bl_sf <- merge(counties, bl, by = "GEOID")

### Extract quantiles; use these to estimate quantiles, below!
q <- bl_sf %>% 
  pull(diff) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() # to remove names of quantiles, so idx below is numeric

### What are the quantiles?
quantiles <- c(-50,-1.5,-1.0,-0.5,-0.25,0,100)

### Create custom labels
labels <- c("< -2.5",      "-2.5 - -0.5",    "-0.5 - 0",    "0 - 0.5",   "0.5 - 2.5",  "> 2.5")

### Create a new variable with the quantiles
df <- bl_sf %>%
  mutate(mean_quantiles = cut(diff,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(!is.na(diff)) 

ggplot() +
  geom_sf(data = df, aes(fill = mean_quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  theme_map() +
  scale_fill_manual(values = c("#B2182B", "#EF8A62", "#FDDBC7", "#D1E5F0", "#67A9CF", "#2166AC")) +
  theme(legend.position = "right") +
  theme(panel.grid.major = element_line(colour = "white"))

# Female
f_sf <- merge(counties, f, by = "GEOID")

### Extract quantiles; use these to estimate quantiles, below!
q <- f_sf %>% 
  pull(diff) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() # to remove names of quantiles, so idx below is numeric

### What are the quantiles?
quantiles <- c(-50,-12.5,-7.5,-5,-2.5,0,100)

### Create custom labels
labels <- c("< -12.5",      "-12.5 - -7.5",    "-7.5 - -5.0",    "-5.0 - -2.5",   "-2.5 - 0",  "> 0")

### Create a new variable with the quantiles
df <- f_sf %>%
  mutate(mean_quantiles = cut(diff,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(!is.na(diff)) 

ggplot() +
  geom_sf(data = df, aes(fill = mean_quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  theme_map() +
  scale_fill_manual(values = c("#A50F15", "#EF3B2C", "#FC9272", "#FCBBA1", "#FEE0D2", "#9ECAE1")) +
  theme(legend.position = "right") +
  theme(panel.grid.major = element_line(colour = "white"), 
          legend.position="bottom",
          legend.key.size = unit(2, 'mm')) +
ggsave("./viz/FigureX-female.png", dpi = 400, width = 100, height = 80, units = "mm")
```


Sex stats for manuscript
```{r}
#see historical data
```

Tenancy stats for manuscript
```{r}
y <- c %>% 
  filter(!is.na(part_owner),
                  !is.na(full_owner),
                  !is.na(tenant)) %>%  
  group_by(year, FRR_NAME) %>% 
  summarise(part_owner = sum(part_owner),
                                        full_owner = sum(full_owner),
                                        tenant = sum(tenant),
                                        ppo = part_owner/(part_owner+full_owner+tenant)*100,
                                        fo = full_owner/(part_owner+full_owner+tenant)*100,
                                        pt = tenant/(part_owner+full_owner+tenant)*100)

t <- c %>% 
  filter(!is.na(part_owner),
                  !is.na(full_owner),
                  !is.na(tenant)) %>%  
  group_by(year) %>% 
  summarise(part_owner = sum(part_owner),
                                        full_owner = sum(full_owner),
                                        tenant = sum(tenant),
                                        ppo = part_owner/(part_owner+full_owner+tenant)*100,
                                        fo = full_owner/(part_owner+full_owner+tenant)*100,
                                        pt = tenant/(part_owner+full_owner+tenant)*100)
```

