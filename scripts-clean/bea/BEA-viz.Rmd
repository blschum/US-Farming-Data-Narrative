---
title: "BEA Vizualizations"
author: "Britta Schumacher"
date: "Last updated: `r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    theme: yeti
    toc: yes
    toc_float: true
    code_folding: hide
---

```{r}
# Load packages
library(tidyverse)
library(sf)

# Load data
bea <- readRDS("./data/bea.RDS")
bea$YEAR <- as.numeric(bea$YEAR)
counties <- readRDS("./data/coterm_cty_sf.RDS") 
states <- readRDS("./data/states_sf.RDS") 
states <- states %>% filter(STATE_FIPS %in% counties$STATEFP)

# I honestly forget what this does.... but I know we need it!
paste_noNA <- function(x,sep=", ") {
gsub(", " ,sep, toString(x[!is.na(x) & x!="" & x!="NA"] ) ) }
```

# Pull in theme for maps
```{r}
theme_map <- function(...) {
  theme_minimal() +
  theme(
    # remove all axes
    axis.line = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),

    # borders and margins
    panel.border = element_blank(),
    
    # titles
    legend.title = element_blank(),
    legend.text = element_text(size = 7, hjust = 0,
                               color = "black"),
    plot.title = element_text(size = 15, hjust = 0.5,
                              color = "black"),
    plot.subtitle = element_text(size = 10, hjust = 0.5,
                                 color = "black",
                                 margin = margin(b = -0.1,
                                                 t = -0.1,
                                                 l = 2,
                                                 unit = "cm"),
                                 debug = F),
    ...
  )
}
```

Corporate v. Family-owned farms
```{r}
corp <- bea %>% select(1:3,25:26) %>% 
  mutate(perc_corp = net_income_corp/net_income_inclcorp*100)

# US over time
corp %>% filter(GeoName == "United States") %>% 
ggplot(.) +
  geom_line(aes(x = YEAR, y = perc_corp), color = "#CC6677", size = 1.5) +
  theme_bw() +
  labs(title = "", color = "", y = "", x = "") +
  ggsave("./viz/perc-corp-income.jpeg", width = 6, height = 4, dpi = 300)

# Cty in 2019
co <- corp %>% filter(YEAR == 2019) 

co_sf <- merge(counties, co, by = "GEOID")

# Pull quantiles
q <- co_sf %>%
  pull(perc_corp) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() 

quantiles <- c(0,2.5,5,10,15,25,100)
labels <- c("0 - 2.5%",      "2.5 - 5.0%",    "5.0 - 10.0%",    "10.0 - 15.0%",   "15.0 - 25.0%",  "> 25.0%")

# Map ag contribution to GDP
co_sf %>%
  mutate(quantiles = cut(perc_corp,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(!is.na(perc_corp)) %>% 
ggplot(.) +
  geom_sf(aes(fill = quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  theme_map() +
  scale_fill_brewer(palette = "Greens") +
  theme(legend.position = "right", legend.title = element_blank()) +
  theme(panel.grid.major = element_line(colour = "white"))  +
  ggsave('./viz/perc-corp-income-2019.jpeg', width = 6, height = 4, dpi = 300)

t <- corp %>% filter(YEAR == 1983)
```


Poverty and food security: SNAP benefits ($1000s of USD)
```{r}
bea$YEAR <- as.numeric(bea$YEAR)
bea %>%
  filter(GeoName == "United States") %>% 
ggplot(.) +
  geom_line(aes(x = YEAR, y = snap*1000), alpha = 0.8) +
  theme_bw() +
  labs(title = "US SNAP Benefits", y = "Nominal Dollars") +
    scale_y_continuous(breaks=c(20000000000,40000000000,60000000000),
        labels=c("$20B", "$40B","$60B")) +
  theme(legend.position="bottom") +
  ggsave('./viz/debt.jpeg', width = 6, height = 4, dpi = 300)

# bring in alternative SNAP data
fns <- read.csv("./data/fns.csv")

# Bring in inflation data (Index 2012=100)
infl <- read.csv("./data/PCEPI.csv")
infl$DATE <- as.POSIXct(infl$DATE, format = "%m/%d/%Y")
infl$YEAR <- format(infl$DATE, format="%Y")

infl_annual <- infl %>% group_by(YEAR) %>% summarise(ave_PCEPI = ave(PCEPI)) %>% distinct() %>% filter(YEAR >= 1980 & YEAR <= 2020)

# merge
snap <- merge(fns, infl_annual, by = "YEAR")

snap_real <- snap %>% 
  mutate(benefits = benefits / (ave_PCEPI/100),
         ben_hh = ben_hh / (ave_PCEPI/100),
         ben_pers = ben_pers / (ave_PCEPI/100))


# how do we want to visualize this data? multiple y-axes?
snap_real %>% 
   mutate(household = household/100000,
          persons = persons/1000000,
          benefits = benefits/1000000000) %>% 
   select(1:4) %>% 
   pivot_longer(cols = 2:4, names_to = "variable", values_to = "value") %>% 
ggplot(.) +
  geom_line(aes(x = YEAR, y = value, color = variable), alpha = 0.8, size = 1) +
  theme_bw() +
  scale_color_manual(labels = c("Households (in millions)", "Persons (in millions)", "Benefits (in billions)"), values = c("#56B4E9","#009E73","#0072B2")) +
  labs(title = "", color = "", y = "", x = "Year") +
  theme_bw() +
  theme(legend.position="bottom") +
  ggsave('./viz/snap.jpeg', width = 6, height = 5, dpi = 300)
```


Proportion production expenses through time
```{r}
bea %>% select(c(1:3,11:18)) %>% filter(GeoName == "United States") %>% pivot_longer(!c(1:3), names_to = "type", values_to = "expense") %>%  filter(type != "prod_exp") %>% 
  ggplot(.) +
  geom_bar(aes(fill = type, y = expense, x = YEAR), position = "fill", stat = "identity") +
  scale_fill_manual(name = "Production Expense", labels = c("Feed", "Fertilizer", "Hired Labor", "Livestock", "Other", "Petrol","Seeds"), values=c("#332288","#117733","#44AA99","#88CCEE","#DDCC77","#CC6677","#AA4499")) +
  labs(title = "", color = "Production Expense", y = "") +
    theme_bw() +
  theme(legend.position="bottom") +
  ggsave('./viz/prop-prodexp.jpeg', width = 6, height = 4, dpi = 300)

# hired labor expense in 2019
h <- bea %>% select(c(1:3,17))  %>% filter(YEAR == 2019) %>% filter(!is.na(hired_labor))

h_sf <- merge(counties, h, by = "GEOID")
glimpse(h_sf)

# Pull quantiles
q<- h_sf %>%
  pull(hired_labor) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() 

quantiles <- c(0,1250,2500,5000,10000,15000,1500000)
labels <- c("0 - 1.25k",      "1.25 - 2.5k",    "2.5 - 5k",    "5 - 10k",   "10 - 15k",  "> 15k")

# Map ag contribution to GDP
h_sf %>%
  mutate(quantiles = cut(hired_labor,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
ggplot(.) +
  geom_sf(aes(fill = quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  theme_map() +
  scale_fill_brewer(palette = "Greens") +
  theme(legend.position = "right", legend.title = element_blank()) +
  theme(panel.grid.major = element_line(colour = "white"))  +
  ggsave('./viz/raw-laborexpense-2019.jpeg', width = 6, height = 4, dpi = 300)
  
```

Input expenditure as a proportion of farm earnings
```{r}
t<- bea %>% select(c(1:3,11,23)) %>% filter(GeoName == "United States") %>% mutate(prod_exp = prod_exp/cash_income*100) %>% 
  ggplot(.) +
  geom_line(aes(x = YEAR, y = prod_exp), color = "#88CCEE", size = 1.5) +
  theme_bw() +
  labs(title = "", color = "", y = "Share of Earnings (%) Spent on Inputs") +
  ggsave("./viz/input-prop-earnings.jpeg", width = 6, height = 4, dpi = 300)

bea %>% select(c(1:3,12:18,23)) %>% filter(GeoName == "United States") %>% 
  mutate(feed = feed/cash_income*100,
         livestock = livestock/cash_income*100,
         seeds = seeds/cash_income*100,
         fert_lime = fert_lime/cash_income*100,
         petrol = petrol/cash_income*100,
         hired_labor = hired_labor/cash_income*100,
         oth_exp = oth_exp/cash_income*100) %>% 
  select(2,4:10) %>% 
  pivot_longer(!c(1), values_to = "prop_exp", names_to = "expense") %>% 
  ggplot(.) +
  geom_line(aes(x = YEAR, y = prop_exp, color = expense), size = 1.3) +
  theme_bw() +
  scale_color_manual(name="",labels = c("Feed", "Fertilizer & Lime","Hired Labor", "Livestock","Other Expenses", "Petrol", "Seeds"), values = c("#332288", "#117733", "#44AA99",  "#88CCEE", "#DDCC77", "#CC6677", "#882255")) + 
  labs(title = "", color = "", y = "Share of Earnings (%) Spent on Inputs") +
  theme(legend.position="bottom") +
  ggsave("./viz/input-ind-prop-earnings.jpeg", width = 6, height = 4, dpi = 300)

# county-level, in most recent year
g <- bea %>% select(c(1:3,11,23)) %>% mutate(perc = prod_exp/cash_income*100) %>% filter(!is.na(perc),
                                                                                         YEAR == 2019) 

g_sf <- merge(counties, g, by = "GEOID")
glimpse(g_sf)

# Pull quantiles
q<- g_sf %>%
  pull(perc) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() 

quantiles <- c(0,70,85,100,125,150,200,1000)
labels <- c("0 - 70%",      "70 - 85%",    "85 - 100%",    "100 - 125%",   "125 - 150%",  "150 - 200%", "> 200%")

# Map ag contribution to GDP
g_sf %>%
  mutate(quantiles = cut(perc,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
ggplot(.) +
  geom_sf(aes(fill = quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  theme_map() +
  scale_fill_manual(values=c("#053061", "#4393C3", "#92C5DE",  "#FDDBC7", "#D6604D", "#B2182B", "#67001F"),name="") +
  theme(legend.position = "right", legend.title = element_blank()) +
  theme(panel.grid.major = element_line(colour = "white"))  +
  ggsave('./viz/inputs-prop-earnings-sf.jpeg', width = 6, height = 4, dpi = 300)
```


# Agricultural contribution to GDP

-	National averages of agricultural contribution to GDP through time (sd)
-	Map of agricultural contribution to GDP in most recent year
```{r}
bea %>% filter(GeoName == "United States", !is.na(current_GDP)) %>% select(c(2,33,35)) %>% mutate(contrib = current_GDP_ag / current_GDP * 100) %>% 
ggplot(.) +
  geom_line(aes(x = YEAR, y = contrib),color = "#882255", size = 1.5) +
  theme_bw() +
  #coord_cartesian(ylim = c(0,1.5)) +
  labs(title = "", color = "", y = "Contribution (%)") +
  ggsave("./viz/farm_contrib_GDP.jpeg", width = 6, height = 4, dpi = 300)

# county-level, in most recent year
g <- bea %>% filter(GEOID %in% counties$GEOID, YEAR == 2019) %>% select(c(1,2,33,35)) %>% mutate(contrib = current_GDP_ag / current_GDP * 100) %>% filter(!is.na(contrib))

#464 counties > 10%

g_sf <- merge(counties, g, by = "GEOID")
glimpse(g_sf)

# Pull quantiles
q<- g_sf %>%
  pull(contrib) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() 

quantiles <- c(0,0.5,1,2.5,5,15,30,90)
labels <- c("0 - 0.5%",      "0.5 - 1%",    "1 - 2.5%",    "2.5 - 5%",   "5 - 15%", "15 - 30%",  "30 - 80%")

# Map ag contribution to GDP
g_sf <- g_sf %>%
  mutate(quantiles = cut(contrib,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(YEAR == 2019) %>% 
ggplot(.) +
  geom_sf(aes(fill = quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  theme_map() +
  scale_fill_manual(values=c("#fef6b5","#ffdd9a","#ffc285","#ffa679","#fa8a76","#f16d7a","#e15383"),name="") +
  theme(legend.position = "right") +
  theme(panel.grid.major = element_line(colour = "white"))  +
  ggsave('./viz/farm_contrib_GDP_2019.jpeg', width = 6, height = 4, dpi = 300)
```

# Farm/agricultural employment

-	National averages of agricultural employment through time (sd)
-	Map of agricultural employment in most recent year
-	Delta maps (2019-1969)
```{r}
### National level - geom_line()
# Slect relevant data
f <- bea %>% filter(GeoName == "United States") %>% select(c(2,44:45))

f$farmempl <- as.numeric(apply(f[c(2:3)],1,paste_noNA))

f %>% 
ggplot(.) +
  geom_line(aes(x = YEAR, y = farmempl),color = "#009392", size = 1.5) +
  theme_bw() +
  labs(title = "US Farm Employment", color = "", y = "Number of jobs (in millions)") +
  scale_y_continuous(breaks=c(3000000,3500000,4000000),
        labels=c("3.0", "3.5M", "4.0")) +
  #coord_cartesian(ylim = c(0,4000000)) +
  ggsave("./viz/farm-employment.jpeg", width = 6, height = 4, dpi = 300)

# county-level, in most recent year (sf/ggplot())
fc <- bea %>% filter(GEOID %in% counties$GEOID) %>% select(c(1:2,44:45)) 
fc$farmempl <- as.numeric(apply(fc[c(3:4)],1,paste_noNA))

fc_sf <- merge(counties, fc, by = "GEOID")
glimpse(fc_sf)

# Pull quantiles
q<- fc_sf %>%
  pull(farmempl) %>%
  quantile(probs = seq(0, 1, length.out = 8), na.rm = T) %>%
  as.vector() 

quantiles <- c(0,250,500,750,1000,1500,5000,38000)
labels <- c("0 – 250",      "250 - 500",    "500 - 750",    "750 - 1000",   "1000 - 1500",  "1500 - 5000", "> 5000")

# Map ag contribution to GDP
fc_sf %>%
  mutate(quantiles = cut(farmempl,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(YEAR == 2019) %>%
  filter(!is.na(farmempl)) %>% 
ggplot(.) +
  geom_sf(aes(fill = quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  theme_map() +
  scale_fill_manual(values=c("#f9ddda","#f2b9c4","#e597b9","#ce78b3","#ad5fad","#834ba0","#573b88"),name="") +
  theme(legend.position = "right") +
  theme(panel.grid.major = element_line(colour = "white")) + 
  ggsave('./viz/employ_2019.jpeg', width = 6, height = 4, dpi = 300)

# Farm employment as percentage of total county employment
# county-level, in most recent year (sf/ggplot())
fc <- bea %>% filter(GEOID %in% counties$GEOID) %>% select(c(1:2,38:39,44:45)) 
fc$farmempl <- as.numeric(apply(fc[c(5:6)],1,paste_noNA))
fc$totjobs <- as.numeric(apply(fc[c(3:4)],1,paste_noNA))

fc <- fc %>% mutate(prop_farm = farmempl/totjobs*100) %>% select(1:2,7:9)

fc_sf <- merge(counties, fc, by = "GEOID")

# Pull quantiles
q<- fc_sf %>%
  pull(prop_farm) %>%
  quantile(probs = seq(0, 1, length.out = 8), na.rm = T) %>%
  as.vector() 

quantiles <- c(0,2.5,5,7.5,10,15,30,75)
labels <- c("0 – 2.5%",      "2.5 - 5.0%",    "5.0 - 7.5%",    "7.5 - 10.0%",   "10.0 - 15.0%",  "15.0 - 30.0%", "> 30.0%")

# Map ag contribution to GDP
fc_sf %>%
  mutate(quantiles = cut(prop_farm,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(YEAR == 2019) %>%
  filter(!is.na(prop_farm)) %>% 
ggplot(.) +
  geom_sf(aes(fill = quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  theme_map() +
  scale_fill_manual(values=c("#f9ddda","#f2b9c4","#e597b9","#ce78b3","#ad5fad","#834ba0","#573b88"),name="") +
  theme(legend.position = "right") +
  theme(panel.grid.major = element_line(colour = "white")) + 
  ggsave('./viz/propfarm_employ_2019.jpeg', width = 6, height = 4, dpi = 300)

###################################################################
# Difference between 2019 and 1969
###################################################################
fd <- fc %>% filter(YEAR == 1969 | YEAR == 2019) %>% select(c(1,2,5)) %>%  group_by(GEOID) %>% summarise(diff = diff(prop_farm))

fd_sf <- merge(counties, fd, by = "GEOID")
glimpse(fd_sf)

# Pull quantiles
q<- fd_sf %>%
  pull(diff) %>%
  quantile(probs = seq(0, 1, length.out = 8), na.rm = T) %>%
  as.vector() 

quantiles <- c(-51,-20,-15,-10,-5,-2.5,0,17)
labels <- c("< -20",      "-20 - -15",    "-15 - -10",    "-10 - -5",   "-5 - -2.5",  "-2.5 - 0", "> 0")

# Map ag contribution to GDP
fd_sf %>%
  mutate(quantiles = cut(diff,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(!is.na(diff)) %>% 
ggplot(.) +
  geom_sf(aes(fill = quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  theme_map() +
  scale_fill_manual(values = c("#67001F", "#B2182B", "#D6604D", "#F4A582", "#FDDBC7", "#fff1e8","#92C5DE")) +
  theme(legend.position = "right") +
  theme(panel.grid.major = element_line(colour = "white")) + 
  ggsave('./viz/diff_capita_employ.jpeg', width = 6, height = 4, dpi = 300)
```

# Income & earnings in 2019
```{r}
# Realized net income
# county-level, in most recent year
i <- bea %>% filter(GEOID %in% counties$GEOID, YEAR == 2019) %>% select(c(1:3,24)) %>% filter(!is.na(net_income)) %>% mutate(net_income = net_income*1000)

i_sf <- merge(counties, i, by = "GEOID")
glimpse(i_sf)

# Pull quantiles
q<- i_sf %>%
  pull(net_income) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() 

quantiles <- c(-70000000,-2500000,0,2500000, 5000000,20000000,40000000,2000000000)
labels <- c("< -$2.5M",      "-$2.5 - $0",    "$0 - $2.5M",    "$2.5 - $5M",   "$5 - $20M",  "$20 - $40M", "> $40M")

# Map net income
i_sf %>%
  mutate(quantiles = cut(net_income,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
ggplot(.) +
  geom_sf(aes(fill = quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  theme_map() +
  scale_fill_manual(values = c("#B2182B", "#FDDBC7", "#D1E5F0", "#92C5DE", "#4393C3", "#2166AC", "#053061"),name="") +
  theme(legend.position = "right") +
  theme(panel.grid.major = element_line(colour = "white"))  +
  ggsave('./viz/netincome-2019.jpeg', width = 6, height = 4, dpi = 300)
```

# Income & earnings over time
```{r}
#inflation adjust to 2019 dollars 
options(scipen = 100)
library(blscrapeR) 

df<-inflation_adjust(2019) #this pulls a table of adjustment values (adjustment to 2019 $) 
glimpse(df) 

df$year<-as.numeric(df$year) 

dat<-left_join(bea,df[,c(1,3)], by=c("YEAR"="year")) #this basically joins the inflation adjustment values to the dataset you want to adjust by joining by year of the data (so the current year data in the BEA dataset) in this case I am inflation adjusting the per capita income levels (pci) 

dat$net_income_adj<-dat$net_income/dat$adj_value #this performs the actual dollar value adjustment



# Net adjusted income over time
n <- dat %>% filter(GeoName == "United States") %>% select(c(2,24,71))

n %>% 
ggplot(.) +
  geom_line(aes(x = YEAR, y = net_income_adj*1000/1000000000),color = "#009392", size = 1.5) +
  theme_bw() +
  labs(title = "", color = "", y = "Realized Net Income (in billions of USD$)", x = "") +
  ggsave("./viz/realized-net-income-adj.jpeg", width = 6, height = 4, dpi = 300)

# Realized net income in 1969
i <- dat %>% filter(GEOID %in% counties$GEOID, YEAR == 1969) %>% select(c(1:3,71)) %>% filter(!is.na(net_income_adj)) %>% mutate(net_income_adj = net_income_adj*1000)

i_sf <- merge(counties, i, by = "GEOID")
glimpse(i_sf)

# Pull quantiles
q<- i_sf %>%
  pull(net_income_adj) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() 

quantiles <- c(-8000000,0,5000000, 10000000,20000000,40000000,60000000,800000000)
labels <- c("< $0",      "$0 - $5M",    "$5 - $10M",    "$10 - $20M",   "$20 - $40M",  "$40 - $60M", "> $60M")

# Map net income
i_sf %>%
  mutate(quantiles = cut(net_income_adj,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
ggplot(.) +
  geom_sf(aes(fill = quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  theme_map() +
  scale_fill_manual(values = c("#B2182B", "#ebf8ff", "#D1E5F0", "#92C5DE", "#4393C3", "#2166AC", "#053061"),name="") +
  theme(legend.position = "right") +
  theme(panel.grid.major = element_line(colour = "white"))  +
  ggsave('./viz/netincome-1969.jpeg', width = 6, height = 4, dpi = 300)
```

# Farm vs. nonfarm proprietors income
```{r}
p <- dat %>% select(c(1:3,farmprop_income, farmprop_employ, nonfarmprop_income, nonfarmprop_employ,70))

p$farmprop_income_adj<-p$farmprop_income/p$adj_value
p$nonfarmprop_income_adj<-p$nonfarmprop_income/p$adj_value

p <- p %>% 
  mutate(ave_farm = farmprop_income_adj*1000/farmprop_employ,
         ave_nonfarm = nonfarmprop_income_adj*1000/nonfarmprop_employ)

p %>% filter(GeoName == "United States") %>% select(2,11:12) %>% pivot_longer(-c(1), names_to = "type", values_to = "income") %>% 
  ggplot(.) +
  geom_line(aes(x = YEAR, y = income, color = type), size = 1.5) +
  theme_bw() +
  labs(title = "", color = "", y = "Average Proprietors Income", x = "") +
  scale_color_manual(name="",labels = c("Farm", "Nonfarm"), values = c("#CC6677", "#DDCC77")) +
   theme(legend.position="bottom") +
  ggsave("./viz/ave-proprietors-income.jpeg", width = 6, height = 4, dpi = 300)

# county-level data; average farm proprietors income, 2019
i <- p %>% filter(GEOID %in% counties$GEOID, YEAR == 2019) %>% select(c(1:3,11:12)) %>% filter(!is.na(ave_farm)) 
i_sf <- merge(counties, i, by = "GEOID")
# Pull quantiles
q<- i_sf %>%
  pull(ave_farm) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() 

quantiles <- c(-14000,-100,0,100,200,400,800,31000)
labels <- c("< $100",  "-$100 - $0",    "$0 - $100",   "$100 - $200",  "$200 - $400", "$400 - $800", "> $800")

# Map net income
i_sf %>%
  mutate(quantiles = cut(ave_farm,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
ggplot(.) +
  geom_sf(aes(fill = quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  theme_map() +
  scale_fill_manual(values = c("#B2182B", "#FDDBC7", "#D1E5F0", "#92C5DE", "#4393C3", "#2166AC", "#053061"),name="") +
  theme(legend.position = "right") +
  theme(panel.grid.major = element_line(colour = "white"))  +
  ggsave('./viz/ave-farmincome-2019.jpeg', width = 6, height = 4, dpi = 300)

# county-level data; average farm proprietors income, 1969
i <- p %>% filter(GEOID %in% counties$GEOID, YEAR == 1969) %>% select(c(1:3,11:12)) %>% filter(!is.na(ave_farm)) 
i_sf <- merge(counties, i, by = "GEOID")
# Pull quantiles
q<- i_sf %>%
  pull(ave_farm) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() 

quantiles <- c(-26000,0,500,1500,3000,6000,12000,101000)
labels <- c("< $0",  "-$0 - $500",    "$500 - $1.5k",   "$1.5k - $3k",  "$3k - $6k", "$6k - $12k", "> $12k")

# Map net income
i_sf %>%
  mutate(quantiles = cut(ave_farm,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
ggplot(.) +
  geom_sf(aes(fill = quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  theme_map() +
  scale_fill_manual(values = c("#B2182B", "#ebf8ff", "#D1E5F0", "#92C5DE", "#4393C3", "#2166AC", "#053061"),name="") +
  theme(legend.position = "right") +
  theme(panel.grid.major = element_line(colour = "white"))  +
  ggsave('./viz/ave-farmincome-1969.jpeg', width = 6, height = 4, dpi = 300)
```

