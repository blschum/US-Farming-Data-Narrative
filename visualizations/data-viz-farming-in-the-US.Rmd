---
title: 'Data Visualizations & Stats, by Figure #'
author: "Britta Schumacher"
date: "Last updated: `r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    theme: yeti
    toc: yes
    toc_float: true
---

## Load relevant packages & common data
```{r warning = F, message = F}
library(tidyverse)
library(ggplot2)
library(ggpubr)
library(sf)

counties <- readRDS("./data/coterm_cty_sf.RDS") 
states <- readRDS("./data/states_sf.RDS") 
states <- states %>% filter(STATE_FIPS %in% counties$STATEFP)

# notes from EB
project_theme <- theme_bw() +
  theme(text = element_text(size=9))

# 
paste_noNA <- function(x,sep=", ") {
gsub(", " ,sep, toString(x[!is.na(x) & x!="" & x!="NA"] ) ) }
```


### Pull in theme for maps
```{r warning = F, message = F}
theme_map <- function(...) {
  theme_minimal() +
  theme(
    # remove all axes
    axis.line = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),

    # borders and margins
    panel.border = element_blank(),
    
    # titles
    legend.title = element_blank(),
    legend.text = element_text(size = 9, hjust = 0,
                               color = "black"),
    plot.title = element_text(size = 15, hjust = 0.5,
                              color = "black"),
    plot.subtitle = element_text(size = 10, hjust = 0.5,
                                 color = "black",
                                 margin = margin(b = -0.1,
                                                 t = -0.1,
                                                 l = 2,
                                                 unit = "cm"),
                                 debug = F),
    ...
  )
}
```


### Figure 1: 

The nine US Farm Resource Regions delineated by the USDA ERS (2000). 
```{r warning = F, message = F}
frr <- readRDS("./data/FRR.RDS") 

frr <- st_as_sf(frr)

ggplot() +
  geom_sf(data = frr, aes(fill = FRR_NAME), color = "transparent") +
   geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_manual(values = c("#332288", "#117733", "#44AA99", "#88CCEE", "#DDCC77", "#CC6677", "#AA4499", "#882255", "#1D1C1C")) +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), legend.position="right",
          legend.key.size = unit(3, 'mm'), legend.text = element_text(size = 7)) 

ggsave('./visualizations/PNG/Figure1.png', dpi = 400, width = 110, height = 60, units = "mm", bg = "white")
ggsave('./visualizations/JPEG/Figure1.jpg', dpi = 300, width = 110, height = 60, units = "mm", bg = "white")
```

### Figure 2. 

(A.) US farms, land in farms, and average farm size from 1850 to 2017. The vertical line in 1978 reflects USDA-NASS implementation of adjustments for under-coverage. Data: Robert Hoppe, USDA ERS. (B.) Number of agricultural jobs from 1969 to 2019. Data: US BEA.

```{r warning = F, message = F}
# US land assets, historical data from Robert Hoppe at the USDA ERS

land <- read.csv("./data/ERS-farmop.csv")

land_assets <- land %>% 
   filter(YEAR %in% c(1850:2012,2017,2020)) %>% 
  select(1:4) %>% 
   pivot_longer(cols = 2:4, names_to = "variable", values_to = "value") %>% 
ggplot(.) +
  geom_line(aes(x = YEAR, y = value, color = variable), alpha = 0.8, size = 1.3) +
  project_theme +
  scale_color_manual(values = c("#DDCC77","#117733","#332288")) +
  labs(title = "", color = "", y = "", x = "") +
  annotate("text", x = c(1959,1987,1967), y = c(6.4,5.1,1.75), label = c("Farms (millions)", "Average farm size\n(hundred acres/farm)", "Land in farms\n(billion acres)"), size = 2.8) + 
  scale_x_continuous(breaks = seq(1850, 2020, by = 20)) +
  scale_y_continuous(breaks=c(0,2,4,6,8)) +
  coord_cartesian(xlim = c(1858,2012), ylim = c(0.35,7.5)) +
  theme(legend.position="") +
  geom_vline(xintercept=c(1997), linetype="dotted") 

# US employment in agriculture
bea <- readRDS("./data/bea.RDS")
bea$YEAR <- as.numeric(bea$YEAR)

employ <- bea %>% filter(GeoName == "United States") %>% select(c(2,44:45))

employ$farmempl <- as.numeric(apply(employ[c(2:3)],1,paste_noNA))

employment <- employ %>% 
ggplot(.) +
  geom_line(aes(x = YEAR, y = farmempl),color = "#88CCEE", size = 1.3) +
  project_theme +
  labs(title = "", color = "", x = "", y = "Number of jobs (in millions)") +
  scale_y_continuous(breaks=c(3000000,3500000,4000000),
        labels=c("3.0", "3.5", "4.0"))


ggarrange(land_assets, employment, ncol = 2, labels = c('A.', 'B.'),
          font.label = list(size = 8))
ggsave("./visualizations/PNG/Figure2.png", dpi = 400, width = 200, height = 80, units = "mm")
ggsave("./visualizations/JPEG/Figure2.jpg", dpi = 300, width = 200, height = 80, units = "mm")

# STATS
# number of farm operations in 1935 and 2017
land %>% filter(YEAR == 1935 | YEAR == 2017 )

# average farm size in 1900 and 2017
land %>% filter(YEAR == 1900 | YEAR == 2017 )

# difference in employment between 1983 and 2017
employ %>% filter(YEAR == 1983 | YEAR == 2017)
```

### Figure 3. 

(A.) The average age of primary operators from 1940 to 2017. (B.) The number of US farms with primary operators identifying as Black (red), white (blue), and members of all other races (yellow) from 1900 to 2017. For scale, it is important to note that farms operated by Black operators and members of all other races are shown in hundred thousands, while white operated farms are shown in millions. (C.) Number of primary operators by reported gender, shown in hundred thousands; overlayed with percent female primary operators. The USDA began statistical adjustments for under coverage in 1997, reflected in the vertical change (dotted vertical line) in average age in 1997 from 54.3 (unadjusted) to 54.0 (adjusted). Data: Compiled by Robert Hoppe of the USDA Economic Research Service and shared with the authors.
```{r warning = F, message = F}
h <- read.csv("./data/historical-coa.csv")

project_theme <- theme_bw() +
  theme(text = element_text(size=10))

age <- h %>% 
  ggplot(.) +
  geom_line(aes(x = year, y = ave_age), color = "#88CCEE", size = 1.5) +
  project_theme +
  labs(title = "", color = "", y = "Average Age", x = "") +
  coord_cartesian(xlim = c(1940,2018), ylim = c(47,59)) +
  geom_vline(xintercept=c(1997), linetype="dotted") 

# Farm operators by race through time
race <- h %>% filter(!is.na(black)) %>% 
  ggplot(.) +
  geom_line(aes(x = year, y = white/1000000, color = "White operators (in 1Ms)"), size = 1, linetype = "dotted") +
  geom_line(aes(x = year, y = black/100000, color = "Black operators (in 100ks)"), size = 1, linetype = "longdash") +
  geom_line(aes(x = year, y = other/100000, color = "All Other Races operators (in 100ks)"), size = 1, linetype = "longdash") +
  project_theme +
  scale_color_manual(name="",values = c("White operators (in 1Ms)" = "#88CCEE", "Black operators (in 100ks)" = "#CC6677", "All Other Races operators (in 100ks)" = "#DDCC77")) +
  scale_x_continuous(breaks=seq(1900,2020,20)) +
  geom_vline(xintercept=c(1997), linetype="dotted") +
    theme(legend.position="bottom") 

race2 <- h %>% filter(!is.na(black)) %>% 
  ggplot(.) +
  geom_line(aes(x = year, y = white/1000000, color = "White operators (in 1Ms)"), size = 1, linetype = "dotted") +
  geom_line(aes(x = year, y = black/100000, color = "Black operators (in 100ks)"), size = 1, linetype = "longdash") +
  geom_line(aes(x = year, y = other/100000, color = "All Other Races operators (in 100ks)"), size = 1, linetype = "longdash") +
  project_theme +
  annotate("text", x = c(1958,1980,1920), y = c(7.5,3.5,1.5), label = c("Black operators (in 100ks)", "White operators (in 1Ms)", "All Other Races Operators\n(in 100ks)"), size = 3.5) + # comment out if decide otherwise
  labs(title = "", color = "", y = "Number of Operators", x = "") + # comment out if decide otherwise
  scale_color_manual(name="",values = c("White operators (in 1Ms)" = "#88CCEE", "Black operators (in 100ks)" = "#CC6677", "All Other Races operators (in 100ks)" = "#DDCC77")) +
  scale_x_continuous(breaks=seq(1900,2020,20)) +
  scale_y_continuous(breaks = seq(0,10,2)) +
  geom_vline(xintercept=c(1997), linetype="dotted") +
  theme(legend.position="none") 

# STATS
# Percent black in 1900
746717/5739657
# Percent black in 2017
38447/2740453

# Number of Farm operators by sex through time
sex <- h %>%
  select(year, male, female) %>% filter (!is.na(female)) %>% mutate(perc = (female/(female+male))*100) %>% 
  pivot_longer(-c(year, perc), names_to = "variable", values_to = "count") %>% 
ggplot(.) +
  geom_bar(aes(fill=variable, y=count/100000, x=year), position="dodge", stat="identity") +
  geom_line(aes(x = year, y = perc, color = "% Female Operators"), stat = "identity", size = 1.5) +
  project_theme +
  scale_fill_manual(name="",labels = c("Female", "Male"), values = c("#44AA99", "#332288")) +
  scale_color_manual(name="",values = c("% Female Operators" = "#DDCC77")) +
  geom_vline(xintercept=c(1997), linetype="dotted") +
  theme(legend.position="bottom") +
  labs(title = "", y = "Number of Operators \n(in hundreds of thousands)", x = "") 

ggarrange(age, race2, sex, nrow = 3, labels = c('A.', 'B.', 'C.'),
          font.label = list(size = 8))
ggsave("./visualizations/PNG/Figure3.png", dpi = 400, width = 150, height = 240, units = "mm")
ggsave("./visualizations/JPEG/Figure3.jpg", dpi = 300, width = 150, height = 240, units = "mm")
# Average Operator Age


# STATS
# percent female
h %>% select(year, male, female) %>% filter (!is.na(female)) %>% mutate(perc = (female/(female+male))*100)

# difference in % female operated acres and operators
c <- readRDS("./data/contemp-coa.RDS")
f <- c %>% select(c(1:4,13,16)) %>% 
  filter(year == 2017) %>% 
  mutate(diff = percf_acr - percf_op) %>% 
  filter(!is.na(diff)) %>%  #3028 total counties with non-NA observations
  filter(diff > 0)

187/3028
```


### Figure 4. 

Percent primary operators identifying as (A.) Black, (B.) Hispanic, (C.) white, and (D.) female in 2017.  Data: USDA QuickStats, 2017 COA.

```{r warning = F, message = F}
# load data
c <- readRDS("./data/contemp-coa.RDS")
r <- readRDS("./data/coa-race.RDS")

# Build spatial
c_sf <- merge(counties, c, by = "GEOID")


# proporation of each race
race_prop <- r %>% mutate(TOTAL = rowSums(.[7:13])) %>% 
  mutate(POC = (NATIVE_AMER + BLACK + MULTI + HISPANIC + ASIAN + PACIFIC_ISL)/TOTAL*100,
         NATIVE_AMER = NATIVE_AMER/TOTAL*100,
         BLACK = BLACK/TOTAL*100,
         MULTI = MULTI/TOTAL*100,
         WHITE = WHITE/TOTAL*100,
         HISPANIC = HISPANIC/TOTAL*100,
         ASIAN = ASIAN/TOTAL*100,
         PACIFIC_ISL = PACIFIC_ISL/TOTAL*100) %>% 
  filter(OPERATOR == "OPERATORS, PRINCIPAL") %>% 
  select("GEOID", "YEAR", "OPERATOR", "TYPE", "WHITE", "POC", "NATIVE_AMER", "BLACK", "MULTI", "HISPANIC", "ASIAN", "PACIFIC_ISL", "TOTAL") %>%
  mutate_at(7:13, round, 3)

# build spatial
r_sf <- merge(counties, race_prop, by = "GEOID") 

############################################################
# Percent operators identifying as female
############################################################

fem_operators <- c_sf %>% select(c(1,10:11,31)) %>% filter(!is.na(percf_operators))

### Extract quantiles; use these to estimate quantiles, below!
q <- fem_operators %>% 
  pull(percf_operators) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() # to remove names of quantiles, so idx below is numeric

### What are the quantiles?
quantiles <- c(6,22.5,27.5,30,35,40,86)

### Create custom labels
labels <- c("0 – 22.5%",      "22.5 – 27.5%",    "27.5 – 30.0%",    "30.0 – 35.0%",   "35.0 – 40.0%",  "> 40.0%")

### Create a new variable with the quantiles
df <- fem_operators %>%
  mutate(mean_quantiles = cut(percf_operators,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(!is.na(percf_operators)) 

### PLOT
# Percent female operators - 2017
female_operators <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "Greens") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), legend.position="right",
          legend.key.size = unit(4, 'mm')) 


############################################################
# Percent black, hispanic and white operators
############################################################

### Extract quantiles; use these to estimate quantiles, below!
q <- r_sf %>% filter(YEAR == 2017, TYPE == "OPERATORS") %>% 
  pull(WHITE) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() 

### What are the quantiles?
q_h <- c(0,0.25,0.5,1.0,2.5,5.0,56)
q_b <- c(0,0.25,0.5,1.0,2.5,5.0,56)
q_w <- c(0,85,90,95,97.5,98.5,100.1)

### Create custom labels
l_h <- c("0 - 0.25%",      "0.25 - 0.5%",    "0.5 - 1.0%",    "1.0 - 2.5%",   "2.5 - 5.0%",  "> 5.0%")
l_b <- c("0 - 0.25%",      "0.25 - 0.5%",    "0.5 - 1.0%",    "1.0 - 2.5%",   "2.5 - 5.0%",  "> 5.0%")
l_w <- c("0 - 85.0%",    "85.0 - 90.0%",    "90.0 - 95.0%",   "95.0 - 97.5%",   "97.5 - 98.5%",  "> 98.5%")

### Create a new variable with the quantiles
df <- r_sf %>%
  mutate(mean_quantiles = cut(HISPANIC,
                               breaks = q_h,
                               labels = l_h,
                               include.lowest = T)) %>% 
  filter(!is.na(HISPANIC)) %>% 
  filter(YEAR == 2017, TYPE == "OPERATORS") 

### PLOT
# Percent HISPANIC operators - 2017
hisp_operators <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "Purples") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), legend.position="right",
          legend.key.size = unit(4, 'mm')) 

### Create a new variable with the quantiles
df <- r_sf %>%
  mutate(mean_quantiles = cut(BLACK,
                               breaks = q_b,
                               labels = l_b,
                               include.lowest = T)) %>% 
  filter(!is.na(BLACK)) %>% 
  filter(YEAR == 2017, TYPE == "OPERATORS") 

### PLOT
# Percent BLACK operators - 2017
black_operators <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "Oranges") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), legend.position="right",
          legend.key.size = unit(4, 'mm')) 

### Create a new variable with the quantiles
df <- r_sf %>%
  mutate(mean_quantiles = cut(WHITE,
                               breaks = q_w,
                               labels = l_w,
                               include.lowest = T)) %>% 
  filter(!is.na(WHITE)) %>% 
  filter(YEAR == 2017, TYPE == "OPERATORS") 

### PLOT
# Percent WHITE operators - 2017
white_operators <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "Reds") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), legend.position="right",
          legend.key.size = unit(4, 'mm')) 

# Build panel plots!
# (A.) Black, (B.) Hispanic, (C.) white and (D.) female operators
ggarrange(black_operators, hisp_operators, white_operators, female_operators, labels = c("A.", "B.", "C.", "D."), ncol = 2, nrow = 2, font.label = list(size = 8))
ggsave("./visualizations/PNG/Figure4.png", dpi = 400, width = 220, height = 120, units = "mm", bg = "white")
ggsave("./visualizations/JPEG/Figure4.jpg", dpi = 300, width = 200, height = 120, units = "mm", bg = "white")

# STATS
# Percent by POC, nationally
r %>% mutate(TOTAL = rowSums(.[7:13])) %>% 
  filter(YEAR == 2017) %>% 
  group_by(TYPE) %>% 
  filter(OPERATOR == "OPERATORS, PRINCIPAL") %>% 
  summarise(TOTAL = sum(TOTAL),
         NATIVE_AMER = sum(NATIVE_AMER)/TOTAL*100,
         BLACK = sum(BLACK)/TOTAL*100,
         MULTI = sum(MULTI)/TOTAL*100,
         WHITE = sum(WHITE)/TOTAL*100,
         HISPANIC = sum(HISPANIC)/TOTAL*100,
         ASIAN = sum(ASIAN)/TOTAL*100,
         PACIFIC_ISL = sum(PACIFIC_ISL)/TOTAL*100,
         POC = NATIVE_AMER + BLACK + MULTI + HISPANIC + ASIAN + PACIFIC_ISL) 

# Raw counts, nationally
r %>% mutate(TOTAL = rowSums(.[7:13])) %>% 
  filter(YEAR == 2017) %>% 
  group_by(TYPE) %>% 
  filter(OPERATOR == "OPERATORS, PRINCIPAL") %>% 
  summarise(NATIVE_AMER = sum(NATIVE_AMER),
         BLACK = sum(BLACK),
         MULTI = sum(MULTI),
         WHITE = sum(WHITE),
         HISPANIC = sum(HISPANIC),
         ASIAN = sum(ASIAN),
         PACIFIC_ISL = sum(PACIFIC_ISL)) 

# percent race by state
rs <- r %>% mutate(TOTAL = rowSums(.[7:13])) %>% 
  group_by(YEAR, STATE, TYPE) %>% 
  filter(YEAR == 2017) %>% 
  filter(OPERATOR == "OPERATORS, PRINCIPAL") %>% 
  summarise(TOTAL = sum(TOTAL),
         NATIVE_AMER = sum(NATIVE_AMER)/TOTAL*100,
         BLACK = sum(BLACK)/TOTAL*100,
         MULTI = sum(MULTI)/TOTAL*100,
         WHITE = sum(WHITE)/TOTAL*100,
         HISPANIC = sum(HISPANIC)/TOTAL*100,
         ASIAN = sum(ASIAN)/TOTAL*100,
         PACIFIC_ISL = sum(PACIFIC_ISL)/TOTAL*100) %>% 
  arrange(-BLACK)

#head(rs,10)

rs <- r %>% mutate(TOTAL = rowSums(.[7:13])) %>% 
  group_by(YEAR, STATE, TYPE) %>% 
  filter(YEAR == 2017) %>%   
  filter(OPERATOR == "OPERATORS, PRINCIPAL") %>% 
  summarise(TOTAL = sum(TOTAL),
         NATIVE_AMER = sum(NATIVE_AMER)/TOTAL*100,
         BLACK = sum(BLACK)/TOTAL*100,
         MULTI = sum(MULTI)/TOTAL*100,
         WHITE = sum(WHITE)/TOTAL*100,
         HISPANIC = sum(HISPANIC)/TOTAL*100,
         ASIAN = sum(ASIAN)/TOTAL*100,
         PACIFIC_ISL = sum(PACIFIC_ISL)/TOTAL*100) %>% 
  arrange(-HISPANIC)

#head(rs,10)

rs <- r %>% mutate(TOTAL = rowSums(.[7:13])) %>% 
  group_by(YEAR, STATE, TYPE) %>% 
  filter(YEAR == 2017) %>% 
  filter(OPERATOR == "OPERATORS, PRINCIPAL") %>% 
  summarise(TOTAL = sum(TOTAL),
         NATIVE_AMER = sum(NATIVE_AMER)/TOTAL*100,
         BLACK = sum(BLACK)/TOTAL*100,
         MULTI = sum(MULTI)/TOTAL*100,
         WHITE = sum(WHITE)/TOTAL*100,
         HISPANIC = sum(HISPANIC)/TOTAL*100,
         ASIAN = sum(ASIAN)/TOTAL*100,
         PACIFIC_ISL = sum(PACIFIC_ISL)/TOTAL*100) %>% 
  arrange(-NATIVE_AMER)

#head(rs,10)

```

### Figure 5.

(A.) Average Farm HH income and US HH income in Current $; (B.) Contribution of government payments to net farm sector income, in current dollars. Data: US BEA.

```{r warning = F, message = F}
#inflation adjust to 2019 dollars 

hi <- read.csv("./data/table13-householdincome.csv")

hi <- hi %>%
  select(1:4,6) %>% 
  pivot_longer(-c(YEAR, USHH_Total), names_to = "variable", values_to = "income") %>% 
  filter(variable != "FH_total") %>% 
ggplot(.) +
  geom_bar(aes(fill=variable, y=income, x=YEAR), position="stack", stat="identity") +
  geom_line(aes(x = YEAR, y = USHH_Total, color = "US HH Total Income"), stat = "identity", size = 1.2) +
  project_theme +
  scale_fill_manual(name="",labels = c("Farm HH Income: Farm Portion", "Farm HH Income: Nonfarm Portion"), values = c("#882255", "#CC6677")) +
  scale_color_manual(name="",values = c("US HH Total Income" = "#DDCC77")) +
  theme(legend.position="bottom") +
  labs(title = "", y = "Average Income in Current $", x = "") +
  guides(fill=guide_legend(nrow=2)) +
  scale_y_continuous(breaks=c(50000,100000),
        labels=c("$50k", "$100k"))

# Government reciepts contribution to farm sector net income
options(scipen = 100)
library(blscrapeR) 
library(patchwork)

df<-inflation_adjust(2019) #this pulls a table of adjustment values (adjustment to 2019 $) 
#glimpse(df) 

df$year<-as.numeric(df$year) 
bea <- readRDS("./data/bea.RDS")
bea$YEAR <- as.numeric(bea$YEAR)

dat<-left_join(bea,df[,c(1,3)], by=c("YEAR"="year")) #this basically joins the inflation adjustment values to the dataset you want to adjust by joining by year of the data (so the current year data in the BEA dataset) in this case I am inflation adjusting the per capita income levels (pci) 
dat$net_income<-dat$net_income/dat$adj_value 
dat$gov_pay<-dat$gov_pay/dat$adj_value 

sub <- dat %>% 
  filter(GeoName == "United States") %>% 
  select(YEAR, net_income, gov_pay) %>% 
  mutate(prop = gov_pay/net_income)

gov_port <- ggplot(sub, aes(x = YEAR)) +
  
  geom_bar(aes(y=prop, fill = "#44AA99"), stat="identity") +
  scale_fill_manual(name="",labels = c("Proportion Net Income from Government Payments"), values = c("#44AA99")) +
  geom_line(aes(y = (net_income*1000)/175000000000, color = "#117733"), size = 1.5) + # devide by 1 M
  labs(x = "") +
  scale_y_continuous(breaks=seq(0,1.0,0.25),
    
    # Features of the first axis
    name = "Government Payments\nContribution",
    
    # Add a second axis and specify its features
    sec.axis = sec_axis(~.*175000000000, breaks = c(50000000000,100000000000,150000000000,200000000000),
                        labels=c("$50B", "$100B", "$150B","$200B"), name="Current USD$") 
  ) +
  scale_color_manual(name="",labels = c("Net Income Farm Sector"), values = c("#117733")) +
  project_theme +
  theme(legend.position="bottom") 

# Build panel plots!
# (A.) net income 1969 (adjusted), (B.) net income 2019
ggarrange(hi, gov_port, labels = c("A.", "B."), nrow = 2, font.label = list(size = 8))
ggsave("./visualizations/PNG/Figure5.png", dpi = 400, width = 150, height = 160, units = "mm", bg = "white")
ggsave("./visualizations/JPEG/Figure5.jpg", dpi = 300, width = 150, height = 160, units = "mm", bg = "white")
```

### Figure 6: 

Net cash farm income of operations (measured in $/operation) reported by the USDA-NASS in A) 2002, and B) 2017. Data: USDA NASS Quickstats
```{r warning = F, message = F}
options(scipen = 100)
library(blscrapeR) 

df<-inflation_adjust(2017) #this pulls a table of adjustment values (adjustment to 2019 $) 
#glimpse(df) 

df$year<-as.numeric(df$year) 
c <- readRDS("./data/contemp-coa.RDS")

dat<-left_join(c,df[,c(1,3)], by=c("year"="year")) #this basically joins the inflation adjustment values to the dataset you want to adjust by joining by year of the data (so the current year data in the BEA dataset) in this case I am inflation adjusting the per capita income levels (pci) 
dat$net_income_adj<-dat$net_income/dat$adj_value #this performs the actual dollar value adjustment

nc <- dat %>% filter(GEOID %in% counties$GEOID) %>% filter(year == 2017 | year == 2002) %>% filter(!is.na(net_income_adj))

# STATS
t17 <- nc %>% filter(year == 2017, net_income < 0) %>% arrange(net_income_adj) # 441/3034 reporting counties
t02 <- nc %>% filter(year == 2002, net_income < 0) %>% arrange(net_income_adj) #413/3032

nc_sf <- merge(counties, nc, by = "GEOID")

# First, 2017
# Pull quantiles
q<- nc_sf %>%
  filter(year == 2017) %>% 
  pull(net_income) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() 

quantiles <- c(-80000,0,5000,1250,25000,50000,100000,2000000)
labels <- c("< $0",      "$0 - $5k",    "$5k - $12.5k",    "$12.5k - $25k",   "$25k - $50k", "$50k - $100k",  "> $100k")

# Map ag contribution to GDP
nc_op17 <- nc_sf %>%
  mutate(quantiles = cut(net_income,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(year == 2017) %>% 
ggplot(.) +
  geom_sf(aes(fill = quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), legend.position="right",
          legend.key.size = unit(4, 'mm')) +
    scale_fill_manual(values = c("#B2182B","#F7F7F7", "#D1E5F0", "#92C5DE", "#4393C3", "#2166AC", "#053061"))

# Now, 2002 using the same parameters
nc_op02 <- nc_sf %>%
  mutate(quantiles = cut(net_income_adj,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(year == 2002) %>% 
ggplot(.) +
  geom_sf(aes(fill = quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), legend.position="right",
          legend.key.size = unit(4, 'mm')) +
    scale_fill_manual(values = c("#B2182B","#F7F7F7", "#D1E5F0", "#92C5DE", "#4393C3", "#2166AC", "#053061"))

# Build panel plots!
# (A.) net income 1969 (adjusted), (B.) net income 2019
ggarrange(nc_op02, nc_op17, labels = c("A.", "B."), font.label = list(size = 8), common.legend = TRUE, legend = "right")
ggsave("./visualizations/PNG/Figure6.png", dpi = 400, width = 220, height = 60, units = "mm", bg = "white")
ggsave("./visualizations/JPEG/Figure6.jpg", dpi = 300, width = 200, height = 60, units = "mm", bg = "white")
```

### Figure 7: 

Realized net income of farmers in (A.) 1969 and (B.) 2019, adjusted to 2019 dollars. Net income is defined as total cash receipts from all farms less total production expenses and is analogous to USDA -NASS measures of net cash farm income. We visualize BEA realized net income data because it dates back to 1969 while USDA -NASS county-level data only dates back to 1997. Counties in which net income is negative (red) had average production expenses that surpassed total cash receipts. For instance, Parker, TX realized $17M in 1969, but -$67M in 2019. Data: US BEA.
```{r warning = F, message = F}
options(scipen = 100)
library(blscrapeR) 

df<-inflation_adjust(2019) #this pulls a table of adjustment values (adjustment to 2019 $) 
glimpse(df) 

df$year<-as.numeric(df$year) 
bea <- readRDS("./data/bea.RDS")
bea$YEAR <- as.numeric(bea$YEAR)

dat<-left_join(bea,df[,c(1,3)], by=c("YEAR"="year")) #this basically joins the inflation adjustment values to the dataset you want to adjust by joining by year of the data (so the current year data in the BEA dataset) in this case I am inflation adjusting the per capita income levels (pci) 
dat$net_income_adj<-dat$net_income/dat$adj_value #this performs the actual dollar value adjustment

# Realized net income in 1969
i <- dat %>% filter(GEOID %in% counties$GEOID) %>% select(c(1:3,69)) %>% filter(!is.na(net_income_adj)) %>% mutate(net_income_adj = net_income_adj*1000)

i_sf <- merge(counties, i, by = "GEOID")
#glimpse(i_sf)

# Pull quantiles
q<- i_sf %>%
  filter(YEAR == 1969) %>% 
  pull(net_income_adj) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() 

quantiles <- c(-8000000,0,5000000, 10000000,20000000,40000000,60000000,800000000)
labels <- c("< $0",      "$0 - $5M",    "$5 - $10M",    "$10 - $20M",   "$20 - $40M",  "$40 - $60M", "> $60M")

# Map net income
income_69 <- i_sf %>%
  filter(YEAR == 1969) %>% 
  mutate(quantiles = cut(net_income_adj,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
ggplot(.) +
  geom_sf(aes(fill = quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  theme_map() +
   theme(panel.grid.major = element_line(colour = "white"), 
          legend.position="",
          legend.key.size = unit(4, 'mm')) +
  scale_fill_manual(values = c("#B2182B", "#ebf8ff", "#D1E5F0", "#92C5DE", "#4393C3", "#2166AC", "#053061"),name="") 

# Realized net income
# county-level, in most recent year
i <- bea %>% filter(GEOID %in% counties$GEOID, YEAR == 2019) %>% select(c(1:3,24)) %>% filter(!is.na(net_income)) %>% mutate(net_income = net_income*1000)

median(i$net_income)

i_sf <- merge(counties, i, by = "GEOID")
#glimpse(i_sf)

# Pull quantiles
q<- i_sf %>%
  pull(net_income) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() 

quantiles <- c(-80000000,0,5000000, 10000000,20000000,40000000,60000000,2000000000)
labels <- c("< $0",      "$0 - $5M",    "$5 - $10M",    "$10 - $20M",   "$20 - $40M",  "$40 - $60M", "> $60M")

# Map net income
income_19 <- i_sf %>%
  mutate(quantiles = cut(net_income,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
ggplot(.) +
  geom_sf(aes(fill = quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  theme_map() +
   theme(panel.grid.major = element_line(colour = "white"), 
          legend.position="outside",
          legend.key.size = unit(4, 'mm')) +
  scale_fill_manual(values = c("#B2182B", "#ebf8ff", "#D1E5F0", "#92C5DE", "#4393C3", "#2166AC", "#053061"),name="") 

# Build panel plots!
# (A.) net income 1969 (adjusted), (B.) net income 2019
ggarrange(income_69, income_19, labels = c("A.", "B."), font.label = list(size = 8), common.legend = TRUE, legend = "right")
ggsave("./visualizations/PNG/Figure7.png", dpi = 400, width = 220, height = 60, units = "mm", bg = "white")
ggsave("./visualizations/JPEG/Figure7.jpg", dpi = 300, width = 200, height = 60, units = "mm", bg = "white")
# STATS
# % counties reporting negative net income
i <- bea %>% 
  filter(GEOID %in% counties$GEOID, YEAR == 2019) %>% 
  select(c(1:3,24)) %>% 
  filter(!is.na(net_income)) %>% 
  mutate(net_income = net_income*1000) %>%  #3057 total US counties
  filter(net_income < 0)

i <- bea %>% 
  filter(GEOID %in% counties$GEOID, YEAR == 1969) %>% 
  select(c(1:3,24)) %>% 
  filter(!is.na(net_income)) %>% 
  mutate(net_income = net_income*1000) %>%  #3062 total US counties
  filter(net_income < 0)

808/3057 # 2019
70/3062 # 1969

# merge i_sf (2019) with FRR data
frr <- as.data.frame(readRDS("./data/FRR.RDS")) 

companion <- merge(i, frr, by = "GEOID")

companion <- companion %>% 
  group_by(FRR_NAME) %>% 
  mutate(average = mean(net_income),
         sd = sd(net_income),
         median = median(net_income),
         negative = sum(net_income < 0),
         positive = sum(net_income > 0),
         perc_neg = negative/(negative+positive)*100) %>% 
  select(FRR_NAME, average, sd, median, negative, positive, perc_neg) %>% 
  unique()

write.csv(companion, "./data/out-Figure7-companion.csv")
  
```

### Figure 8: 

(A.) Percent of county agricultural acres covered by crop insurance in 2017; (B.) Dollars provided per agricultural acre in government payouts to farmers in 2017. In 2017, US farms received an average of $11.59/acre (median = $8.69/acre) in government payments and an estimated 31.1% (median = 23.9%) of all agricultural acres were covered by crop insurance (Figure 12). Data: USDA NASS.
```{r warning = F, message = F}

c <- readRDS("./data/contemp-coa.RDS")
#### (A.) Percent of county acres covered by crop insurance in 2017
# county-level, in most recent year
i <- c %>% filter(GEOID %in% counties$GEOID, year == 2017) %>% mutate(perc_insur = insur_acres/tot_acres*100) %>% filter(!is.na(perc_insur))

unique(ave(i$perc_insur))
median(i$perc_insur)
#464 counties > 10%

i_sf <- merge(counties, i, by = "GEOID")

# Pull quantiles
q<- i_sf %>%
  pull(perc_insur) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() 

quantiles <- c(0,5,15,25,40,50,75,100)
labels <- c("0 - 5%",      "5 - 15%",    "15 - 25%",    "25 - 40%",   "40 - 50%", "50 - 75%",  "> 75%")

# Map ag contribution to GDP
perc_insur <- i_sf %>%
  mutate(quantiles = cut(perc_insur,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(year == 2017) %>% 
ggplot(.) +
  geom_sf(aes(fill = quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), legend.position="right",
          legend.key.size = unit(4, 'mm')) +
  scale_fill_brewer(palette = "YlOrBr") 

#### (B.) Dollars provided per agricultural acre in government payouts to farmers.
# county-level, in most recent year
p <- c %>% filter(GEOID %in% counties$GEOID, year == 2017) %>% mutate(gvt_acre = gvt_prog/tot_acres) %>% filter(!is.na(gvt_acre))

unique(ave(p$gvt_acre))
median(p$gvt_acre)
#464 counties > 10%

p_sf <- merge(counties, p, by = "GEOID")

# Pull quantiles
q<- p_sf %>%
  pull(gvt_acre) %>%
  quantile(probs = seq(0, 1, length.out = 8), na.rm = T) %>%
  as.vector() 

quantiles <- c(0,2.5,5,7.5,10,15,25,100)
labels <- c("$0 - $2.5",      "$2.5 - $5",    "$5 - $7.5",    "$7.5 - $10",   "$10 - $15", "$15 - $25",  "> $25")

# Map ag contribution to GDP
gvt_acre <- p_sf %>%
  mutate(quantiles = cut(gvt_acre,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(year == 2017) %>% 
ggplot(.) +
  geom_sf(aes(fill = quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), legend.position="right",
          legend.key.size = unit(4, 'mm')) +
  scale_fill_brewer(palette = "RdPu") 

# Build panel plots!
# (A.) % acres covered by crop insurance, (B.) $/ag acre in government payouts
library(ggpubr)
ggarrange(perc_insur, gvt_acre, labels = c("A.", "B."), ncol = 2, font.label = list(size = 8))
ggsave("./visualizations/PNG/Figure8.png", dpi = 400, units = "mm", width = 220, height = 60, bg = "white")
ggsave("./visualizations/JPEG/Figure8.jpg", dpi = 300, units = "mm", width = 200, height = 60, bg = "white")
```

### Figure 9. 

Per acre expenditure on agricultural inputs in 2017; county-level agricultural expense data standardized by a county's total agricultural acres. Data: USDA ERS BEA, and USDA COA QuickStats.
```{r warning = F, message = F}
# load data
c <- readRDS("./data/contemp-coa.RDS")

ag_acres <- c %>% select(1:2,7) %>% filter(year == 2017) %>% rename("YEAR" = "year")
expenses <- bea %>% select(1:2,11) %>%  filter(YEAR == 2017) %>% mutate(prod_exp = prod_exp*1000)

per_acre_exp <- merge(ag_acres, expenses, by = c("GEOID","YEAR"))

per_acre_exp <- per_acre_exp %>% mutate(exp_per_acre = prod_exp/tot_acres) %>% filter(!is.na(exp_per_acre))

# stats
median(per_acre_exp$exp_per_acre)
mean(per_acre_exp$exp_per_acre)

exp_sf <- merge(counties, per_acre_exp, by = "GEOID")
glimpse(exp_sf)

# Pull quantiles
q<- exp_sf %>%
  pull(exp_per_acre) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() 

quantiles <- c(0,150,250,500, 600,800,1000,25000)
labels <- c("$0 - $150",      "$150 - $250",    "$250 - $500",    "$500 - $600",   "$600 - $800",  "$800 - $1000", "> $1000")

# Map net income
exp_17 <- exp_sf %>%
  mutate(quantiles = cut(exp_per_acre,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
ggplot(.) +
  geom_sf(aes(fill = quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "GnBu") +
  theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), 
          legend.position="right",
          legend.key.size = unit(4, 'mm'))

  ggsave("./visualizations/PNG/Figure9.png", dpi = 400, width = 110, height = 60, units = "mm", bg = "white")
  ggsave("./visualizations/JPEG/Figure9.jpg", dpi = 300, width = 110, height = 60, units = "mm", bg = "white")
```

### Figure 10. 

Major commodity prices, adjusted using the price as paid index (PPITW) provided by the National Agriculture Statistics Service based on instruction for deflation from Jeff Gillespie, REE-ERS. Data: USDA ERS, 2021c

```{r warning = F, message = F}
hist <- readRDS("./data/hist_cws.RDS")
recent <- readRDS("./data/recent_cws.RDS")

build_time_series <- function(vars) {
  
 his <- hist %>% filter(ITEM == vars[[1]]) %>% select(YEAR, VALUE, ITEM, CROP)
 rec <- recent %>% filter(REGION_ID == 10, ITEM == vars[[2]]) %>% select(YEAR, VALUE, ITEM, CROP)
 
 fullts <- rbind.data.frame(his, rec)
 
 return(fullts)

}

net_value <- build_time_series(c("Gross value of production less cash expenses", "Value of production less total costs listed"))
net_value$VAR <- "Net production value"
total_cost <- build_time_series(c("Total, cash expenses", "Total, costs listed"))
total_cost$VAR <- "Total costs"
total_pxn <- build_time_series(c("Total, gross value of production", "Total, gross value of production"))
total_pxn$VAR <- "Gross production value"
yield <- build_time_series(c("Yield (bu./planted acre)", "Yield"))
yield$VAR <- "Yields (bu/ac)"
price <- build_time_series(c("Harvest-period price (dollars/bu.)", "Price"))
price$VAR <- "Price ($/bu)"

adj <- read.csv("./data/adjustment.csv") %>% filter(Period == "YEAR") %>%
  select(Year, Value)
colnames(adj) <- c("YEAR", "PRICE_ADJ")

price2 <- merge(price, adj, by = "YEAR" , all = T)
price2$VALUE_ADJ <- (price2$VALUE * price2$PRICE_ADJ)/100

library(forcats)
ggplot(price2 %>% filter(YEAR > 1990) %>% mutate(CROP = fct_relevel(CROP, "Soy","Wheat","Corn"))) +
  geom_line(aes(x = YEAR, y = VALUE_ADJ, color = CROP), size=1) +
  project_theme +
  labs(x = "",
       y = "$/bushel", 
       color = "")

ggsave("./visualizations/PNG/Figure10.png", plot = last_plot(), dpi = 400, width = 130, height = 70, units = "mm")
ggsave("./visualizations/JPEG/Figure10.jpg", plot = last_plot(), dpi = 300, width = 130, height = 70, units = "mm")
```

### Figure 11.

Gross production value, total costs, and net production value for major commodity crops over the last 40 years. Data: USDA ERS, 2021c 

```{r warning = F, message = F}
pxnviz <- rbind.data.frame(net_value, total_cost, total_pxn) %>% 
  select(YEAR, VALUE, CROP, VAR) 

adj <- read.csv("./data/adjustment.csv") %>% filter(Period == "YEAR") %>%
  select(Year, Value)
colnames(adj) <- c("YEAR", "PRICE_ADJ")

pxnviz <- merge(pxnviz, adj, by = "YEAR" , all = T)
pxnviz$VALUE_ADJ <- (pxnviz$VALUE * pxnviz$PRICE_ADJ)/100

ggplot(pxnviz %>% filter(YEAR > 1990) %>% 
         mutate(VAR = fct_relevel(VAR, "Gross production value","Total costs","Net production value"))) +
  geom_line(aes(x = YEAR, y = VALUE_ADJ, color = VAR)) +
  project_theme +
  geom_hline(yintercept=0, linetype = "dashed") +
  facet_wrap(~CROP) +
  labs(color = "",
       y = "$/acre",
       x = "") +
  theme(legend.position = "bottom") +
  scale_color_manual(values = c("dark green", "orange", "red")) +
  xlim(c(1989, 2021))


ggsave("./visualizations/PNG/Figure11.png", plot = last_plot(), dpi = 400, width = 140, height = 70, units = "mm")
ggsave("./visualizations/JPEG/Figure11.jpg", plot = last_plot(), dpi = 300, width = 140, height = 70, units = "mm")
```

### Figure 12: 

A. Percent agricultural acres operated by principal operators who own the land they work in 2017. B. Percent agricultural acres operated by principal operators who rent the land they work (i.e. tenants) in 2017. Data: USDA QuickStats, 2017 COA.
```{r warning = F, message = F}
# load data
c <- readRDS("./data/contemp-coa.RDS")

# Build spatial
c_sf <- merge(counties, c, by = "GEOID")

############################################################
# Tenancy as % agricultural acres rented in 2017
############################################################
tenant <- c_sf %>% select(c(1,10,26:28)) %>% 
  mutate(perc_rent = tenant/(tenant+part_owner+full_owner)*100)

### Extract quantiles; use these to estimate quantiles, below!
q <- tenant %>% filter(year == 2017) %>% 
  pull(perc_rent) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() # to remove names of quantiles, so idx below is numeric

### What are the quantiles?
quantiles <- c(0,2,3.5,5.5,7.5,15,70)

### Create custom labels
labels <- c("0 - 2.0%",      "2.0 - 3.5%",    "3.5 – 5.5%",    "5.5 - 7.5%",   "7.5 - 15.0%",  "> 15.0%")

### Create a new variable with the quantiles
df <- tenant %>%
  mutate(mean_quantiles = cut(perc_rent,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(!is.na(perc_rent)) %>% 
  filter(year == 2017) 

### PLOT
# Percent tenants - 2017
tenants <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "PuBuGn") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), 
          legend.position="right",
          legend.key.size = unit(4, 'mm')) 

############################################################
# Tenancy as % agricultural acres owned in 2017
############################################################
own <- c_sf %>% select(c(1,10,26:28)) %>% 
  mutate(perc_own = full_owner/(tenant+part_owner+full_owner)*100)

### Extract quantiles; use these to estimate quantiles, below!
q <- own %>% filter(year == 2017) %>% 
  pull(perc_own) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() # to remove names of quantiles, so idx below is numeric

### What are the quantiles?
quantiles <- c(0,20,30,40,50,60,98)

### Create custom labels
labels <- c("0 - 20%",      "20 - 30%",    "30 – 40%",    "40 - 50%",   "50 - 60%",  "> 60%")

### Create a new variable with the quantiles
df <- own %>%
  mutate(mean_quantiles = cut(perc_own,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(!is.na(perc_own)) %>% 
  filter(year == 2017) 

### PLOT
# Percent tenants - 2017
owners <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "YlOrRd") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), 
          legend.position="right",
          legend.key.size = unit(4, 'mm')) 

# Build panel plots!
# (A.) % full owners, (B.) % tenants
ggarrange(owners, tenants, labels = c("A.", "B."), ncol = 2, font.label = list(size = 8))
ggsave("./visualizations/PNG/Figure12.png", dpi = 400, width = 220, height = 60, units = "mm", bg = "white")
ggsave("./visualizations/JPEG/Figure12.jpg", dpi = 300, width = 200, height = 60, units = "mm", bg = "white")
```

### Figure 13: 

Proportion ownership of land by race from 1900 to 2017. In each year the left column shows the proportion of land owned and rented by POC, and the right, by White operators. Due to data limitations (i.e. historical lack of intersectionality in data collection) we can only visualize White versus all Other races. Data: Robert Hoppe, USDA ERS.

```{r warning = F, message = F}

h <- read.csv("./data/historical-coa.csv")

# White v. Nonwhite ownership/tenancy
t <- h %>% select(1,12:17) %>% filter(!is.na(w_tenant)) %>% 
  pivot_longer(!c(1), names_to = "tenancy", values_to = "count") %>% 
  mutate(
    race = case_when(
      tenancy %in% c("w_fullowner","w_partowner","w_tenant") ~ "White",
      tenancy %in% c("nw_fullowner","nw_partowner","nw_tenants") ~ "POC"),
    type = case_when(
      tenancy %in% c("w_fullowner","nw_fullowner") ~ "Full Owner",
      tenancy %in% c("w_partowner","nw_partowner") ~ "Part Owner",
      tenancy %in% c("w_tenant","nw_tenants") ~ "Tenants"
    ))

# new column with 6 colors; and hack in 6 colors
t$race <- as.factor(t$race)
t$type <- as.factor(t$type)
t$year <- as.factor(t$year)

t$alpharace <- as.factor(ifelse(t$race == "White", 0.4, 1))

ggplot(t, aes(x = race, y=count , fill=type, alpha = factor(alpharace))) +
  geom_bar(position = "fill", stat = "identity") +
      scale_fill_manual(name = "", labels = c("Full Owner", "Part Owner", "Tenant"), values=c("#44AA99","#88CCEE","#DDCC77"))  +
      theme(strip.background = element_rect(color="transparent",fill = "transparent")) +
  theme_minimal() +
  theme(text = element_text(size=10)) +
  scale_alpha_manual(values = c("0.4"=0.4, "1"=1), guide='none') +
  scale_x_discrete(labels = NULL, breaks = NULL) + labs(x = "") +
  facet_wrap(~year,nrow=1, strip.position = "bottom") +
    labs(title = "", color = "", y = "", x = "") 

 ggsave('./visualizations/PNG/Figure13.png', dpi = 400, width = 9.5, height = 5, bg = "white") 
  ggsave('./visualizations/JPEG/Figure13.jpg', dpi = 300, width = 9.5, height = 5, bg = "white") 
### NOTE: must bring image out of R and in to editing software (we are using Inkscape) to build matrix legend you see in manuscript!
```

### Figure 14.

Rising farm sector debt, adjusted for inflation using the chain-type GDP deflator provided by the USDA ERS. Farm sector debt is all debt (real estate and non-real estate) accrued by the agricultural sector. See SI Ffigure 15 and 16 for breakdown of non-real estate and real estate debt. Data: USDA ERS.

```{r warning = F, message = F}
w <- read.csv("./data/ers-wealthstatdata.csv")
w <- w[c(1,2,4:8,11)]

debt <- w %>% 
  filter(VariableDescriptionPart1 %in% c("Real estate","Farm sector debt","Non-real estate"))

#write.csv(debt, "./data/farm_sector_debt.csv")

debt$variable <- paste(debt$VariableDescriptionPart1, debt$VariableDescriptionPart2, sep="_")

debt <- debt[c(1,2,6,8:9)]
unique(debt$variable)

debt <- debt %>% mutate(REAL_GDP = Amount / (ChainType_GDP_Deflator/100))

# Real debt
debt %>%
  filter(variable %in% c("Real estate_All","Farm sector debt_All","Non-real estate_All"),
         Year >= 1960) %>%
ggplot(.) +
  geom_line(aes(x = Year, y = REAL_GDP*1000, color = variable), alpha = 0.8) +
  theme_bw() +
  scale_color_manual(labels = c("Farm sector", "Non-real estate", "Real estate"), values = c("#44AA99", "#AA4499","#88CCEE")) +
  labs(title = "", color = "Debt Type", y = "Real US Dollars", x = "") +
  scale_y_continuous(breaks=c(100000000000,200000000000,300000000000,400000000000),
        labels=c("$100B", "$200B", "$300B","$400B")) +
  project_theme +
  theme(legend.position="bottom") 

  ggsave("./visualizations/PNG/Figure14.png", dpi = 400, width = 150, height = 90, units = "mm")
  ggsave("./visualizations/JPEG/Figure14.jpg", dpi = 300, width = 150, height = 90, units = "mm")
```



