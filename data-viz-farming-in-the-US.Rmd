---
title: 'Data Visualizations, by Figure #'
author: "Britta Schumacher"
date: "Last updated: `r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    theme: yeti
    toc: yes
    toc_float: true
---

## Load relevant packages & common data
```{r}
library(tidyverse)
library(ggplot2)
library(ggpubr)
library(sf)

counties <- readRDS("./data/coterm_cty_sf.RDS") 
states <- readRDS("./data/states_sf.RDS") 
states <- states %>% filter(STATE_FIPS %in% counties$STATEFP)

# notes from EB
project_theme <- theme_bw() +
  theme(text = element_text(size=8))

# 
paste_noNA <- function(x,sep=", ") {
gsub(", " ,sep, toString(x[!is.na(x) & x!="" & x!="NA"] ) ) }
```


# Pull in theme for maps
```{r}
theme_map <- function(...) {
  theme_minimal() +
  theme(
    # remove all axes
    axis.line = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),

    # borders and margins
    panel.border = element_blank(),
    
    # titles
    legend.title = element_blank(),
    legend.text = element_text(size = 7, hjust = 0,
                               color = "black"),
    plot.title = element_text(size = 15, hjust = 0.5,
                              color = "black"),
    plot.subtitle = element_text(size = 10, hjust = 0.5,
                                 color = "black",
                                 margin = margin(b = -0.1,
                                                 t = -0.1,
                                                 l = 2,
                                                 unit = "cm"),
                                 debug = F),
    ...
  )
}
```


### Figure 1: The nine US Farm Resource Regions delineated by the USDA ERS (2000). 
```{r}
frr <- readRDS("./data/FRR.RDS") 

frr <- st_as_sf(frr)

ggplot() +
  geom_sf(data = frr, aes(fill = FRR_NAME), color = "transparent") +
   geom_sf(data = states, fill = "transparent", color = "dark gray") +
  theme_map() +
  scale_fill_manual(values = c("#332288", "#117733", "#44AA99", "#88CCEE", "#DDCC77", "#CC6677", "#AA4499", "#882255", "#1D1C1C")) +
  theme(legend.position = "right") +
  theme(panel.grid.major = element_line(colour = "white")) + 
  ggsave('./viz/Figure1.jpeg', width = 6, height = 4, dpi = 300)

```

### Figure 2. (A.) US farms, land in farms, and average farm size from 1850 to 2017. The vertical line in 1978 reflects USDA-NASS implementation of adjustments for under-coverage. Data: Robert Hoppe, USDA ERS. (B.) Number of agricultural jobs from 1969 to 2019. Data: US BEA.

```{r}
# US land assets, historical data from Robert Hoppe at the USDA ERS

land <- read.csv("./data/ERS-farmop.csv")

land_assets <- land %>% 
   filter(YEAR %in% c(1850:2012,2017,2020)) %>% 
  select(1:4) %>% 
   pivot_longer(cols = 2:4, names_to = "variable", values_to = "value") %>% 
ggplot(.) +
  geom_line(aes(x = YEAR, y = value, color = variable), alpha = 0.8, size = 1.3) +
  project_theme +
  scale_color_manual(values = c("#DDCC77","#117733","#332288")) +
  labs(title = "", color = "", y = "", x = "") +
  annotate("text", x = c(1957,1987,1965), y = c(6.4,5.1,1.75), label = c("Farms (millions)", "Average farm size\n(hundred acres/farm)", "Land in farms\n(billion acres)"), size = 2.5) + 
  scale_x_continuous(breaks = seq(1850, 2020, by = 20)) +
  scale_y_continuous(breaks=c(0,2,4,6,8)) +
  coord_cartesian(xlim = c(1858,2012), ylim = c(0.35,7.5)) +
  theme(legend.position="") +
  geom_vline(xintercept=c(1997), linetype="dotted") 

# US employment in agriculture
bea <- readRDS("./data/bea.RDS")
bea$YEAR <- as.numeric(bea$YEAR)

employ <- bea %>% filter(GeoName == "United States") %>% select(c(2,44:45))

employ$farmempl <- as.numeric(apply(employ[c(2:3)],1,paste_noNA))

employment <- employ %>% 
ggplot(.) +
  geom_line(aes(x = YEAR, y = farmempl),color = "#88CCEE", size = 1.3) +
  project_theme +
  labs(title = "", color = "", x = "", y = "Number of jobs (in millions)") +
  scale_y_continuous(breaks=c(3000000,3500000,4000000),
        labels=c("3.0", "3.5", "4.0"))


ggarrange(land_assets, employment, ncol = 2, labels = c('A.', 'B.'),
          font.label = list(size = 8))
ggsave("./viz/Figure2.png", dpi = 400, width = 200, height = 80, units = "mm")

# STATS
# number of farm operations in 1935 and 2017
land %>% filter(YEAR == 1935 | YEAR == 2017 )

# average farm size in 1900 and 2017
land %>% filter(YEAR == 1900 | YEAR == 2017 )

# difference in employment between 1983 and 2017
employ %>% filter(YEAR == 1983 | YEAR == 2017)
```

### Figure 3. (A.) The average age of primary operators from 1940 to 2017. (B.) The number of US farms with primary operators identifying as Black (red), white (blue), and members of all other races (yellow) from 1900 to 2017. For scale, it is important to note that farms operated by Black operators and members of all other races are shown in hundred thousands, while white operated farms are shown in millions. (C.) Number of primary operators by reported gender, shown in hundred thousands; overlayed with percent female primary operators. The USDA began statistical adjustments for under coverage in 1997, reflected in the vertical change (dotted vertical line) in average age in 1997 from 54.3 (unadjusted) to 54.0 (adjusted). Data: Compiled by Robert Hoppe of the USDA Economic Research Service and shared with the authors.
```{r}
h <- read.csv("./data/historical-coa.csv")

project_theme <- theme_bw() +
  theme(text = element_text(size=10))

# Average Operator Age
age <- h %>% 
  ggplot(.) +
  geom_line(aes(x = year, y = ave_age), color = "#88CCEE", size = 1.5) +
  project_theme +
  labs(title = "", color = "", y = "Average Age", x = "") +
  coord_cartesian(xlim = c(1940,2017)) +
  geom_vline(xintercept=c(1997), linetype="dotted") 

# Farm operators by race through time
race <- h %>% filter(!is.na(black)) %>% 
  ggplot(.) +
  geom_line(aes(x = year, y = white/1000000, color = "White operators (in 1Ms)"), size = 1, linetype = "longdash") +
  geom_line(aes(x = year, y = black/100000, color = "Black operators (in 100ks)"), size = 1, linetype = "longdash") +
  geom_line(aes(x = year, y = other/100000, color = "All Other Races operators (in 100ks)"), size = 1, linetype = "longdash") +
  project_theme +
  labs(title = "", color = "", y = "Number of Operators", x = "") +
  scale_color_manual(name="",values = c("White operators (in 1Ms)" = "#88CCEE", "Black operators (in 100ks)" = "#CC6677", "All Other Races operators (in 100ks)" = "#DDCC77")) +
  coord_cartesian(xlim = c(1900,2017)) +
  geom_vline(xintercept=c(1997), linetype="dotted") +
    theme(legend.position="bottom") 


# Number of Farm operators by sex through time

sex <- h %>%
  select(year, male, female) %>% filter (!is.na(female)) %>% mutate(perc = female/male*100) %>% 
  pivot_longer(-c(year, perc), names_to = "variable", values_to = "count") %>% 
ggplot(.) +
  geom_bar(aes(fill=variable, y=count/100000, x=year), position="dodge", stat="identity") +
  geom_line(aes(x = year, y = perc, color = "% Female Primary Operators"), stat = "identity", size = 1.5) +
  project_theme +
  scale_fill_manual(name="",labels = c("Female", "Male"), values = c("#44AA99", "#332288")) +
  scale_color_manual(name="",values = c("% Female Primary Operators" = "#DDCC77")) +
  geom_vline(xintercept=c(1997), linetype="dotted") +
  theme(legend.position="bottom") +
  labs(title = "", y = "Number of Primary Operators", x = "") 

ggarrange(age, race, sex, nrow = 3, labels = c('A.', 'B.', 'C.'),
          font.label = list(size = 8))
ggsave("./viz/Figure3.png", dpi = 400, width = 150, height = 240, units = "mm")

```


Figure 4. Percent primary operators identifying as (A.) Black, (B.) Hispanic, (C.) white, and (D.) female in 2017.  Data: USDA QuickStats, 2017 COA.

```{r}
# load data
c <- readRDS("./data/contemp-coa.RDS")
r <- readRDS("./data/coa-race.RDS")

# Build spatial
c_sf <- merge(counties, c, by = "GEOID")


# proporation of each race
race_prop <- r %>% mutate(TOTAL = rowSums(.[7:13])) %>% 
  mutate(POC = (NATIVE_AMER + BLACK + MULTI + HISPANIC + ASIAN + PACIFIC_ISL)/TOTAL*100,
         NATIVE_AMER = NATIVE_AMER/TOTAL*100,
         BLACK = BLACK/TOTAL*100,
         MULTI = MULTI/TOTAL*100,
         WHITE = WHITE/TOTAL*100,
         HISPANIC = HISPANIC/TOTAL*100,
         ASIAN = ASIAN/TOTAL*100,
         PACIFIC_ISL = PACIFIC_ISL/TOTAL*100) %>% 
  filter(OPERATOR == "OPERATORS, PRINCIPAL") %>% 
  select("GEOID", "YEAR", "OPERATOR", "TYPE", "WHITE", "POC", "NATIVE_AMER", "BLACK", "MULTI", "HISPANIC", "ASIAN", "PACIFIC_ISL", "TOTAL") %>% 
  mutate_at(7:13, round, 3)

# build spatial
r_sf <- merge(counties, race_prop, by = "GEOID") 

############################################################
# Percent operators identifying as female
############################################################

fem_operators <- c_sf %>% select(c(1,10:11,31)) %>% filter(!is.na(percf_operators))

### Extract quantiles; use these to estimate quantiles, below!
q <- fem_operators %>% 
  pull(percf_operators) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() # to remove names of quantiles, so idx below is numeric

### What are the quantiles?
quantiles <- c(6,22.5,27.5,30,35,40,86)

### Create custom labels
labels <- c("0 – 22.5%",      "22.5 – 27.5%",    "27.5 – 30.0%",    "30.0 – 35.0%",   "35.0 – 40.0%",  "> 40.0%")

### Create a new variable with the quantiles
df <- fem_operators %>%
  mutate(mean_quantiles = cut(percf_operators,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(!is.na(percf_operators)) 

### PLOT
# Percent female operators - 2017
female_operators <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "Greens") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), legend.position="bottom",
          legend.key.size = unit(2, 'mm')) 


############################################################
# Percent black, hispanic and white operators
############################################################

### Extract quantiles; use these to estimate quantiles, below!
q <- r_sf %>% filter(YEAR == 2017, TYPE == "OPERATORS") %>% 
  pull(WHITE) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() 

### What are the quantiles?
q_h <- c(0,0.25,0.5,1.0,2.5,5.0,56)
q_b <- c(0,0.25,0.5,1.0,2.5,5.0,56)
q_w <- c(0,85,90,95,97.5,98.5,100.1)

### Create custom labels
l_h <- c("0 - 0.25%",      "0.25 - 0.5%",    "0.5 - 1.0%",    "1.0 - 2.5%",   "2.5 - 5.0%",  "> 5.0%")
l_b <- c("0 - 0.25%",      "0.25 - 0.5%",    "0.5 - 1.0%",    "1.0 - 2.5%",   "2.5 - 5.0%",  "> 5.0%")
l_w <- c("0 - 85.0%",    "85.0 - 90.0%",    "90.0 - 95.0%",   "95.0 - 97.5%",   "97.5 - 98.5%",  "> 98.5%")

### Create a new variable with the quantiles
df <- r_sf %>%
  mutate(mean_quantiles = cut(HISPANIC,
                               breaks = q_h,
                               labels = l_h,
                               include.lowest = T)) %>% 
  filter(!is.na(HISPANIC)) %>% 
  filter(YEAR == 2017, TYPE == "OPERATORS") 

### PLOT
# Percent HISPANIC operators - 2017
hisp_operators <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "Purples") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), legend.position="bottom",
          legend.key.size = unit(2, 'mm')) 

### Create a new variable with the quantiles
df <- r_sf %>%
  mutate(mean_quantiles = cut(BLACK,
                               breaks = q_b,
                               labels = l_b,
                               include.lowest = T)) %>% 
  filter(!is.na(BLACK)) %>% 
  filter(YEAR == 2017, TYPE == "OPERATORS") 

### PLOT
# Percent BLACK operators - 2017
black_operators <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "Oranges") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), legend.position="bottom",
          legend.key.size = unit(2, 'mm')) 

### Create a new variable with the quantiles
df <- r_sf %>%
  mutate(mean_quantiles = cut(WHITE,
                               breaks = q_w,
                               labels = l_w,
                               include.lowest = T)) %>% 
  filter(!is.na(WHITE)) %>% 
  filter(YEAR == 2017, TYPE == "OPERATORS") 

### PLOT
# Percent WHITE operators - 2017
white_operators <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "Reds") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), legend.position="bottom",
          legend.key.size = unit(2, 'mm')) 

# Build panel plots!
# (A.) Black, (B.) Hispanic, (C.) white and (D.) female operators
ggarrange(black_operators, hisp_operators, white_operators, female_operators, labels = c("A.", "B.", "C.", "D."), ncol = 2, nrow = 2, font.label = list(size = 8))
ggsave("./viz/Figure4.png", dpi = 400, width = 180, height = 120, units = "mm")

```


### Figure 5: A. Percent agricultural acres operated by principal operators who own the land they work in 2017. B. Percent agricultural acres operated by principal operators who rent the land they work (i.e. tenants) in 2017. Data: USDA QuickStats, 2017 COA.
```{r}
############################################################
# Tenancy as % agricultural acres rented in 2017
############################################################
tenant <- c_sf %>% select(c(1,10,26:28)) %>% 
  mutate(perc_rent = tenant/(tenant+part_owner+full_owner)*100)

### Extract quantiles; use these to estimate quantiles, below!
q <- tenant %>% filter(year == 2017) %>% 
  pull(perc_rent) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() # to remove names of quantiles, so idx below is numeric

### What are the quantiles?
quantiles <- c(0,2,3.5,5.5,7.5,15,70)

### Create custom labels
labels <- c("0 - 2.0%",      "2.0 - 3.5%",    "3.5 – 5.5%",    "5.5 - 7.5%",   "7.5 - 15.0%",  "> 15.0%")

### Create a new variable with the quantiles
df <- tenant %>%
  mutate(mean_quantiles = cut(perc_rent,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(!is.na(perc_rent)) %>% 
  filter(year == 2017) 

### PLOT
# Percent tenants - 2017
tenants <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "PuBuGn") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), 
          legend.position="bottom",
          legend.key.size = unit(2, 'mm')) 

############################################################
# Tenancy as % agricultural acres owned in 2017
############################################################
own <- c_sf %>% select(c(1,10,26:28)) %>% 
  mutate(perc_own = full_owner/(tenant+part_owner+full_owner)*100)

### Extract quantiles; use these to estimate quantiles, below!
q <- own %>% filter(year == 2017) %>% 
  pull(perc_own) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() # to remove names of quantiles, so idx below is numeric

### What are the quantiles?
quantiles <- c(0,20,30,40,50,60,98)

### Create custom labels
labels <- c("0 - 20%",      "20 - 30%",    "30 – 40%",    "40 - 50%",   "50 - 60%",  "> 60%")

### Create a new variable with the quantiles
df <- own %>%
  mutate(mean_quantiles = cut(perc_own,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(!is.na(perc_own)) %>% 
  filter(year == 2017) 

### PLOT
# Percent tenants - 2017
owners <- ggplot(data = df) +
  geom_sf(mapping = aes(fill = mean_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "YlOrRd") +
 theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), 
          legend.position="bottom",
          legend.key.size = unit(2, 'mm')) 

# Build panel plots!
# (A.) % full owners, (B.) % tenants
ggarrange(owners, tenants, labels = c("A.", "B."), ncol = 2, font.label = list(size = 8))
ggsave("./viz/Figure5.png", dpi = 400, width = 200, height = 80, units = "mm")

```

### Figure 6: Proportion ownership of land by race from 1900 to 2017. In each year the left column shows the proportion of land owned and rented by POC, and the right, by White operators. Due to data limitations (i.e. historical lack of intersectionality in data collection) we can only visualize White versus all Other races. Data: Robert Hoppe, USDA ERS.

```{r}
# White v. Nonwhite ownership/tenancy
t <- h %>% select(1,12:17) %>% filter(!is.na(w_tenant)) %>% 
  pivot_longer(!c(1), names_to = "tenancy", values_to = "count") %>% 
  mutate(
    race = case_when(
      tenancy %in% c("w_fullowner","w_partowner","w_tenant") ~ "White",
      tenancy %in% c("nw_fullowner","nw_partowner","nw_tenants") ~ "POC"),
    type = case_when(
      tenancy %in% c("w_fullowner","nw_fullowner") ~ "Full Owner",
      tenancy %in% c("w_partowner","nw_partowner") ~ "Part Owner",
      tenancy %in% c("w_tenant","nw_tenants") ~ "Tenants"
    ))

t$race <- as.factor(t$race)
t$type <- as.factor(t$type)
t$year <- as.factor(t$year)

t %>% filter(race == "POC")

t$alpharace <- as.factor(ifelse(t$race == "White", 0.6, 1))

ggplot(t, aes(x = race, y=count , fill=type, alpha = factor(alpharace))) +
  geom_bar(position = "fill", stat = "identity") +
      scale_fill_manual(name = "", labels = c("Full Owner", "Part Owner", "Tenant"), values=c("#44AA99","#88CCEE","#DDCC77"))  +
      theme(strip.background = element_rect(color="transparent",fill = "transparent")) +
  theme(legend.position="bottom") +
  theme_minimal() +
  theme(text = element_text(size=10)) +
  scale_alpha_manual(values = c("0.6"=0.6, "1"=1), guide='none') +
  scale_x_discrete(labels = NULL, breaks = NULL) + labs(x = "") +
  facet_wrap(~year,nrow=1) +
    labs(title = "", color = "", y = "", x = "") +
 ggsave('./viz/Figure6.jpeg', dpi = 400, width = 9.5, height = 5) 
```

Figure 10: A.  Median acres per operation in 2017; we visualize median acres rather than mean acres due to very large operations that skew the mean high (see mean acres per operation in SI Figure ###). B. Distribution of farm size through time.

```{r}
############################################################
# Acres per operation, median in 2017
############################################################
size <- c_sf %>% select(c(1,10:11,14:16))  %>% mutate(ave_apo = round(tot_acres/n_op))

### Extract quantiles; use these to estimate quantiles, below!
# Mean
q <- size %>% filter(year == 2017) %>% 
  pull(acres_per_op) %>% # switch ave_apo & acres_per_op
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() # to remove names of quantiles, so idx below is numeric

### What are the quantiles?
quantiles_med <- c(0,50,75,100,150,300,40000) # Median

### Create custom labels
labels_med <- c("0 – 50 acres",      "50 – 75 acres",    "75 – 100 acres",    "100 – 150 acres",   "150 – 300 acres",  "> 300 acres") # Median

### Create a new variable with the quantiles
# Mean
df <- size %>%
  mutate(mean_quantiles = cut(ave_apo,
                               breaks = quantiles_med,
                               labels = labels_med,
                               include.lowest = T)) %>% 
  filter(year == 2017) %>% 
  filter(!is.na(ave_apo)) 

### PLOT
### Create a new variable with the quantiles
# Median
df_op <- size %>%
  mutate(median_quantiles = cut(acres_per_op,
                               breaks = quantiles_med,
                               labels = labels_med,
                               include.lowest = T)) %>% 
  filter(year == 2017) %>% 
  filter(!is.na(acres_per_op)) 

### PLOT
# Median acres
median_acres <- ggplot(data = df_op) +
  geom_sf(mapping = aes(fill = median_quantiles),color = "transparent",size = 0.01) +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "BuPu") +
  theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), 
          legend.position="bottom",
          legend.key.size = unit(2, 'mm')) 

############################################################
# Acres per operation, median in 2017
############################################################
# Distribution of farm size (box and whisker plot)
c$year <- as.factor(c$year)
bw <- c %>% filter(year != 1997) %>% select(c(2,6:8)) %>% mutate(ave = tot_acres/n_op) %>% select(c(1,4:5)) %>% pivot_longer(!year, names_to = "category", values_to = "acres")

bw$category <- factor(bw$category, levels = c("ave", "acres_per_op"))
colors=c("#DDCC77", "#CC6677")
names(colors) <- levels(bw$category)

#bw$alpha <- as.factor(ifelse(bw$category == "ave", 0.7, 0.7))

# put  median and average acres per operation next to each other in box and whisker!
dist_acres <- ggplot(bw, aes(x=year, y=acres, fill=category)) +
  geom_boxplot(outlier.alpha = 0.1) +
  project_theme + 
  theme(legend.position = "none") +
  labs(title = "", y = "Acres per Operation", x = "") +
  scale_fill_manual(name ="year",  values=colors) +
  #scale_alpha_manual(values = c("0.7"=0.7), guide='none') +
  coord_cartesian(ylim = c(0, 1200)) 

# Build panel plots!
# (A.) median acres, (B.) distribution of acreage
ggarrange(median_acres, dist_acres, labels = c("A.", "B."), ncol = 2, font.label = list(size = 8))
ggsave("./viz/Figure10.png", dpi = 400, width = 200, height = 80, units = "mm")
```

### Figure 9: A. The difference in the share of agricultural employment in the workforce from 1969 to 2019; where red, counties employ fewer proprietors, partners, and hired laborers in agriculture now than in 1969. For example, in Cache County, UT, 13.3 out of every 100 workers were employed in agriculture in 1969; in 2019, however, only 1.9 were, resulting in a -11.5 difference in agricultural workers per 100 county workers over time. Data: US BEA.
```{r}
# Farm employment as percentage of total county employment
# county-level, in most recent year (sf/ggplot())
fc <- bea %>% filter(GEOID %in% counties$GEOID) %>% select(c(1:2,38:39,44:45)) 
fc$farmempl <- as.numeric(apply(fc[c(5:6)],1,paste_noNA))
fc$totjobs <- as.numeric(apply(fc[c(3:4)],1,paste_noNA))

fc <- fc %>% mutate(prop_farm = farmempl/totjobs*100) %>% select(1:2,7:9)

###################################################################
# Difference between 2019 and 1969
###################################################################
fd <- fc %>% filter(YEAR == 1969 | YEAR == 2019) %>% select(c(1,2,5)) %>%  group_by(GEOID) %>% summarise(diff = diff(prop_farm))

fd_sf <- merge(counties, fd, by = "GEOID")
glimpse(fd_sf)

# Pull quantiles
q<- fd_sf %>%
  pull(diff) %>%
  quantile(probs = seq(0, 1, length.out = 8), na.rm = T) %>%
  as.vector() 

quantiles <- c(-51,-20,-15,-10,-5,-2.5,0,17)
labels <- c("< -20",      "-20 - -15",    "-15 - -10",    "-10 - -5",   "-5 - -2.5",  "-2.5 - 0", "> 0")

# Map ag contribution to GDP
fd_sf %>%
  mutate(quantiles = cut(diff,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
  filter(!is.na(diff)) %>% 
ggplot(.) +
  geom_sf(aes(fill = quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
   theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), 
          legend.position="bottom",
          legend.key.size = unit(2, 'mm')) +
  scale_fill_manual(values = c("#67001F", "#B2182B", "#D6604D", "#F4A582", "#FDDBC7", "#fff1e8","#92C5DE")) +
  theme(panel.grid.major = element_line(colour = "white")) + 
  ggsave('./viz/Figure9.jpeg', width = 6, height = 4, dpi = 300)
```

### Figure 11.Average farm and nonfarm proprietors’ income, adjusted to 2019 dollars. Data: US BEA.
```{r}
#inflation adjust to 2019 dollars 
options(scipen = 100)
library(blscrapeR) 

df<-inflation_adjust(2019) #this pulls a table of adjustment values (adjustment to 2019 $) 
glimpse(df) 

df$year<-as.numeric(df$year) 

dat<-left_join(bea,df[,c(1,3)], by=c("YEAR"="year")) #this basically joins the inflation adjustment values to the dataset you want to adjust by joining by year of the data (so the current year data in the BEA dataset) in this case I am inflation adjusting the per capita income levels (pci) 

dat$net_income_adj<-dat$net_income/dat$adj_value #this performs the actual dollar value adjustment
p <- dat %>% select(c(1:3,farmprop_income, farmprop_employ, nonfarmprop_income, nonfarmprop_employ,68, prod_exp))

p$farmprop_income_adj<-p$farmprop_income/p$adj_value
p$nonfarmprop_income_adj<-p$nonfarmprop_income/p$adj_value

p <- p %>% 
  subset(!(GEOID %in% counties$GEOID)) %>% 
  filter(str_detect(GEOID, pattern = "000"),
         GEOID != "00000" & GEOID != "11000" & GEOID != "02000" & GEOID != "15000") %>% 
  filter(as.numeric(as.character((GEOID))) < 91000) %>% 
  group_by(YEAR) %>% 
  summarise(US_farm_income = sum(farmprop_income_adj),
         US_farm_employ = sum(farmprop_employ),
         US_nonfarm_income = sum(nonfarmprop_income_adj),
         US_nonfarm_employ = sum(nonfarmprop_employ),
         US_prod_exp = sum(prod_exp)) %>% 
  mutate(ave_farm = US_farm_income*1000/US_farm_employ,
         ave_nonfarm = US_nonfarm_income*1000/US_nonfarm_employ,
         exp_prop = US_prod_exp*1000/US_farm_employ)


p %>% select(1,6:7) %>% pivot_longer(-c(1), names_to = "type", values_to = "income") %>% 
  ggplot(.) +
  geom_line(aes(x = YEAR, y = income, color = type), size = 1.5) +
  project_theme +
  labs(title = "", color = "", y = "Average Proprietors Income", x = "") +
  scale_color_manual(name="",labels = c("Farm", "Nonfarm"), values = c("#CC6677", "#DDCC77")) +
   theme(legend.position="bottom") +
  ggsave("./viz/Figure11.png", width = 6, height = 4, dpi = 300)
```


### Figure 12. Realized net income of farmers in 1969 and 2019, adjusted to 2019 dollars. Net income is defined as total cash receipts from all farms less total production expenses. Counties in which net income is negative (red) had average production expenses that surpassed total cash receipts. For instance, Parker, TX realized $17M in 1969, but -$60M in 2019. Data: USDA ERS BEA.
```{r}

# Realized net income in 1969
i <- dat %>% filter(GEOID %in% counties$GEOID, YEAR == 1969) %>% select(c(1:3,71)) %>% filter(!is.na(net_income_adj)) %>% mutate(net_income_adj = net_income_adj*1000)

i_sf <- merge(counties, i, by = "GEOID")
glimpse(i_sf)

# Pull quantiles
q<- i_sf %>%
  pull(net_income_adj) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() 

quantiles <- c(-8000000,0,5000000, 10000000,20000000,40000000,60000000,800000000)
labels <- c("< $0",      "$0 - $5M",    "$5 - $10M",    "$10 - $20M",   "$20 - $40M",  "$40 - $60M", "> $60M")

# Map net income
income_69 <- i_sf %>%
  mutate(quantiles = cut(net_income_adj,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
ggplot(.) +
  geom_sf(aes(fill = quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  theme_map() +
   theme(panel.grid.major = element_line(colour = "white"), 
          legend.position="bottom",
          legend.key.size = unit(2, 'mm')) +
  scale_fill_manual(values = c("#B2182B", "#ebf8ff", "#D1E5F0", "#92C5DE", "#4393C3", "#2166AC", "#053061"),name="") 

# Realized net income
# county-level, in most recent year
i <- bea %>% filter(GEOID %in% counties$GEOID, YEAR == 2019) %>% select(c(1:3,24)) %>% filter(!is.na(net_income)) %>% mutate(net_income = net_income*1000)

median(i$net_income)

i_sf <- merge(counties, i, by = "GEOID")
glimpse(i_sf)

# Pull quantiles
q<- i_sf %>%
  pull(net_income) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() 

quantiles <- c(-70000000,-2500000,0,2500000, 5000000,20000000,40000000,2000000000)
labels <- c("< -$2.5M",      "-$2.5 - $0",    "$0 - $2.5M",    "$2.5 - $5M",   "$5 - $20M",  "$20 - $40M", "> $40M")

# Map net income
income_19 <- i_sf %>%
  mutate(quantiles = cut(net_income,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
ggplot(.) +
  geom_sf(aes(fill = quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  theme_map() +
   theme(panel.grid.major = element_line(colour = "white"), 
          legend.position="bottom",
          legend.key.size = unit(2, 'mm')) +
  scale_fill_manual(values = c("#B2182B", "#FDDBC7", "#D1E5F0", "#92C5DE", "#4393C3", "#2166AC", "#053061"),name="") 

# Build panel plots!
# (A.) net income 1969 (adjusted), (B.) net income 2019
ggarrange(income_69, income_19, labels = c("A.", "B."), ncol = 2, font.label = list(size = 8))
ggsave("./viz/Figure12.png", dpi = 400, width = 200, height = 80, units = "mm")
```

### Figure 13. Per acre expenditure on agricultural inputs in 2017; county-level agricultural expense data standardized by a county's total agricultural acres. Data: USDA ERS BEA, and USDA COA QuickStats.
```{r}
ag_acres <- c %>% select(1:2,7) %>% filter(year == 2017) %>% rename("YEAR" = "year")
expenses <- bea %>% select(1:2,11) %>%  filter(YEAR == 2017) %>% mutate(prod_exp = prod_exp*1000)

per_acre_exp <- merge(ag_acres, expenses, by = c("GEOID","YEAR"))

per_acre_exp <- per_acre_exp %>% mutate(exp_per_acre = prod_exp/tot_acres) %>% filter(!is.na(exp_per_acre))

# stats
median(per_acre_exp$exp_per_acre)
mean(per_acre_exp$exp_per_acre)

exp_sf <- merge(counties, per_acre_exp, by = "GEOID")
glimpse(exp_sf)

# Pull quantiles
q<- exp_sf %>%
  pull(exp_per_acre) %>%
  quantile(probs = seq(0, 1, length.out = 7), na.rm = T) %>%
  as.vector() 

quantiles <- c(0,150,250,500, 600,800,1000,25000)
labels <- c("$0 - $150",      "$150 - $250",    "$250 - $500",    "$500 - $600",   "$600 - $800",  "$800 - $1000", "> $1000")

# Map net income
exp_17 <- exp_sf %>%
  mutate(quantiles = cut(exp_per_acre,
                               breaks = quantiles,
                               labels = labels,
                               include.lowest = T)) %>% 
ggplot(.) +
  geom_sf(aes(fill = quantiles), color = "transparent") +
  geom_sf(data = states, fill = "transparent", color = "dark gray") +
  scale_fill_brewer(palette = "GnBu") +
  theme_map() +
    theme(panel.grid.major = element_line(colour = "white"), 
          legend.position="bottom",
          legend.key.size = unit(2, 'mm')) +
  ggsave("./viz/Figure13.png", width = 6, height = 4, dpi = 300)

```